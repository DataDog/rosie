package io.codiga.e2e;

import io.codiga.analyzer.Analyzer;
import io.codiga.analyzer.config.AnalyzerConfiguration;
import io.codiga.analyzer.rule.AnalyzerRule;
import io.codiga.cli.errorreporting.ErrorReportingDummy;
import io.codiga.cli.metrics.MetricsDummy;
import io.codiga.model.Language;
import io.codiga.model.error.AnalysisResult;
import io.codiga.model.error.Violation;
import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.io.IOException;
import java.util.Base64;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ExecutionException;
import java.util.logging.Logger;
import java.util.stream.Collectors;

import static io.codiga.cli.RulesUtils.getRulesFromFile;
import static org.junit.jupiter.api.Assertions.assertEquals;


public class LargeFileExecutionTest {

    public static String DB_PY = "aW1wb3J0IGRhdGV0aW1lCmltcG9ydCBsb2dnaW5nCmltcG9ydCB0aW1lCmltcG9ydCBvcwppbXBvcnQgbXlzcWwuY29ubmVjdG9yCmltcG9ydCBiYWNrZW5kX2xpYi5jb25zdGFudHMgYXMgY29uc3RhbnRzCmltcG9ydCBiYWNrZW5kX2xpYi5jb25maWd1cmF0aW9uIGFzIGNvbmZpZ3VyYXRpb24KaW1wb3J0IGJhY2tlbmRfbGliLmNvbW1vbiBhcyBjb21tb24KZnJvbSBiYWNrZW5kX2xpYi5tZXRyaWNzLm5hbWVzIGltcG9ydCBEQVRBQkFTRV9DT05ORUNUSU9OX0ZBSUwKZnJvbSBiYWNrZW5kX2xpYi5tZXRyaWNzLnJlcG9ydGluZyBpbXBvcnQgaW5jcmVtZW50X21ldHJpYwpmcm9tIGJhY2tlbmRfbGliLm1vZGVsLm1vZGVsIGltcG9ydCBHaXRodWJDaGVja1N1aXRlLCBDb21wbGV4aXR5TWV0cmljRnVuY3Rpb24sIFwKICAgIHZpb2xhdGlvbl92YWx1ZV90b192aW9sYXRpb25fY2F0ZWdvcnksIFZpb2xhdGlvblRvSWdub3JlLCBmaWx0ZXJfdmlvbGF0aW9ucywgRHVwbGljYXRpb24sIER1cGxpY2F0aW9uT2NjdXJyZW5jZQpmcm9tIGJhY2tlbmRfbGliLm1vZGVsLnZpb2xhdGlvbiBpbXBvcnQgVmlvbGF0aW9uCmZyb20gYmFja2VuZF9saWIudXRpbHMudXNlcl91dGlscyBpbXBvcnQgZ2V0X21heF9hbmFseXNlc19mb3JfbGV2ZWwKZnJvbSBiYWNrZW5kX2xpYi51dGlscy5sYW5ndWFnZV91dGlscyBpbXBvcnQgZ2V0X2xhbmd1YWdlX2Zvcl9maWxlbmFtZQoKU0VDT05EU19JTl9PTkVfSE9VUiA9IDM2MDAKU0VDT05EU19JTl9PTkVfTUlOVVRFID0gNjAKCgpkZWYgY29ubmVjdChjb25maWcpOgogICAgaG9zdCA9IG9zLmdldGVudigiREFUQUJBU0VfSE9TVCIsIGNvbmZpZ1snZGJob3N0J10pCiAgICB1c2VyID0gb3MuZ2V0ZW52KCJEQVRBQkFTRV9VU0VSIiwgY29uZmlnWydkYnVzZXInXSkKICAgIHBhc3N3b3JkID0gb3MuZ2V0ZW52KCJEQVRBQkFTRV9QQVNTV09SRCIsIGNvbmZpZ1snZGJwYXNzJ10pCiAgICBkYXRhYmFzZSA9IG9zLmdldGVudigiREFUQUJBU0VfTkFNRSIsIGNvbmZpZ1snZGJuYW1lJ10pCiAgICBsb2dnaW5nLmRlYnVnKCJbREJdIENvbm5lY3RpbmcgdG8gaG9zdCAlcyIsIGhvc3QpCgogICAgd2hpbGUgVHJ1ZToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbm5lY3Rpb24gPSBteXNxbC5jb25uZWN0b3IuY29ubmVjdCgKICAgICAgICAgICAgICAgIGhvc3Q9aG9zdCwKICAgICAgICAgICAgICAgIHVzZXI9dXNlciwKICAgICAgICAgICAgICAgIHBhc3N3ZD1wYXNzd29yZCwKICAgICAgICAgICAgICAgIGRhdGFiYXNlPWRhdGFiYXNlLAogICAgICAgICAgICAgICAgY2hhcnNldD0ndXRmOG1iNCcsCiAgICAgICAgICAgICAgICB1c2VfcHVyZT1UcnVlLAogICAgICAgICAgICAgICAgY29ubmVjdGlvbl90aW1lb3V0PTUpCiAgICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uCiAgICAgICAgZXhjZXB0IG15c3FsLmNvbm5lY3Rvci5FcnJvcjoKICAgICAgICAgICAgaW5jcmVtZW50X21ldHJpYyhEQVRBQkFTRV9DT05ORUNUSU9OX0ZBSUwpCiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoIkNhbm5vdCBjb25uZWN0IHRvIHRoZSBkYXRhYmFzZSIpCiAgICAgICAgICAgIHRpbWUuc2xlZXAoNSkKCmRlZiBnZXRfZGVsZXRhYmxlX3Byb2plY3RzKGRiKToKICAgICIiIgogICAgR2V0IHRoZSBsaXN0IG9mIHByb2plY3RzIHRoYXQgY2FuIGJlIGRlbGV0ZWQuIFByb2plY3RzIHRoYXQgY2FuIGJlIGRlbGV0ZWQgYXJlIHByb2plY3RzIHRoYXQgZG8gbm90IGhhdmUKICAgIFNDSEVEVUxFRCBvciBJTlBST0dSRVNTIGFuYWx5c2lzIGFuZCB0aGF0IGFyZSBpbiB0aGUgc3RhdGUgIkRFTEVUSU5HIgogICAgOnBhcmFtIGRiOiB0aGUgbXlzcWwgY29ubmVjdG9yCiAgICA6cmV0dXJuOiBhIGxpc3Qgb2YgZGljdGlvbmFyaWVzIHRoYXQgbGlzdCB0aGUgcHJvamVjdCB0aGF0IGNhbiBiZSBhbmFseXplZCB0aGF0IGdpdmVzIHRoZSBpZCBvZiB0aGUgcHJvamVjdCBhcyB3ZWxsIGFzIGl0cyBuYW1lCiAgICAiIiIKICAgIHJlc3VsdCA9IFtdCiAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQoKICAgICMgTWFrZSBzdXJlIHdlIHNjaGVkdWxlIG9ubHkgYWN0aXZlIHByb2plY3RzCiAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUIHAuaWQsIHAubmFtZSBGUk9NIHByb2plY3RzIHAgV0hFUkUgcC5zdGF0ZT0nRGVsZXRpbmcnIEFORCBwLmlkIE5PVCBJTiAoU0VMRUNUIHByb2plY3RfaWQgRlJPTSBhbmFseXNpc19yZXN1bHRzIFdIRVJFIChzdGF0dXM9J1NDSEVEVUxFRCcgT1Igc3RhdHVzPSdJTl9QUk9HRVNTJykpIikKICAgIGZvciB4IGluIGN1cnNvci5mZXRjaGFsbCgpOgogICAgICAgIHJlc3VsdC5hcHBlbmQoeyJpZCI6IHhbMF0sICJuYW1lIjogeFsxXX0pCiAgICBjdXJzb3IuY2xvc2UoKQogICAgcmV0dXJuIHJlc3VsdAoKCmRlZiBsb2NrX3Byb2plY3RfZm9yX2RlbGV0ZShkYiwgcHJvamVjdF9pZCk6CiAgICAiIiIKICAgIExvY2sgcHJvamVjdCB0byBkZWxldGUgYW5kIHNldCBpdCB0byB0aGUgREVMRVRJTkdfSU5fUFJPR1JFU1MgU1RBVEUKICAgIDpwYXJhbSBkYjogdGhlIG15c3FsIGNvbm5lY3Rpb24KICAgIDpwYXJhbSBsaW1pdDogbnVtYmVyIG9mIHByb2plY3RzIHRvIGdyYWIgYW5kIHVwZGF0ZQogICAgOnJldHVybjoKICAgICIiIgogICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKICAgICMgdXNlIEZPUiBVUERBVEUgdG8gbG9jayB0aGUgZGF0YWJhc2UKICAgIHN0bXQgPSAiU0VMRUNUIGlkLCBzdGF0ZSBGUk9NIHByb2plY3RzIFdIRVJFIGlkPSVzIEZPUiBVUERBVEUiCiAgICBjdXJzb3IuZXhlY3V0ZShzdG10LCAocHJvamVjdF9pZCwgKSkKICAgIGN1cnNvci5mZXRjaGFsbCgpCgogICAgIyB1cGRhdGUgdGhlIHN0YXR1cyBvZiB0aGUgcHJvamVjdAogICAgc3RtdCA9ICJVUERBVEUgcHJvamVjdHMgU0VUIHN0YXRlPSdEZWxldGluZ19Jbl9Qcm9ncmVzcycgV0hFUkUgaWQ9JXMiCiAgICBjdXJzb3IuZXhlY3V0ZShzdG10LCAocHJvamVjdF9pZCwgKSkKICAgIGRiLmNvbW1pdCgpCiAgICBjdXJzb3IuY2xvc2UoKQoKCmRlZiBzZXRfcHJvamVjdF9zdGF0dXMoZGIsIHByb2plY3RfaWQsIG5ld19zdGF0dXMpOgogICAgaWYgbm90IHByb2plY3RfaWQ6CiAgICAgICAgcmV0dXJuCiAgICBpZiBub3QgbmV3X3N0YXR1czoKICAgICAgICByZXR1cm4KICAgIGN1cnNvciA9IGRiLmN1cnNvcigpCiAgICAjIHVwZGF0ZSB0aGUgc3RhdHVzIG9mIHRoZSBwcm9qZWN0CiAgICBzdG10ID0gIlVQREFURSBwcm9qZWN0cyBTRVQgc3RhdGU9JXMgV0hFUkUgaWQ9JXMiCiAgICBjdXJzb3IuZXhlY3V0ZShzdG10LCAobmV3X3N0YXR1cywgcHJvamVjdF9pZCwgKSkKICAgIGRiLmNvbW1pdCgpCiAgICBjdXJzb3IuY2xvc2UoKQoKCmRlZiBzZXRfYW5hbHlzaXNfc3RhdHVzKGRiLCBpZCwgc3RhdHVzKToKICAgICIiIgogICAgQ2hhbmdlIHRoZSBzdGF0dXMgb2YgYW4gYW5hbHlzaXMgcm93CiAgICA6cGFyYW0gZGI6IHRoZSBkYXRhYmFzZSBvYmplY3QKICAgIDpwYXJhbSBpZDogaWRlbnRpZmllciBvZiB0aGUgYW5hbHlzaXMgaWRlbnRpZmllcgogICAgOnBhcmFtIHN0YXR1czogc3RhdHVzIHRvIHNldAogICAgOnJldHVybjogbm90aGluZyAtIGlmIHlvdSBkbyBub3QgaGF2ZSBhbiBleGNlcHRpb24sIHlvdSBhcmUgZ29vZAogICAgIiIiCiAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQogICAgc3RtdCA9ICJVUERBVEUgYW5hbHlzaXNfcmVzdWx0cyBTRVQgc3RhdHVzPSd7MH0nIFdIRVJFIGlkPXsxfSIuZm9ybWF0KHN0YXR1cywgaWQpCiAgICBsb2dnaW5nLmRlYnVnKHN0bXQpCiAgICBjdXJzb3IuZXhlY3V0ZShzdG10KQogICAgY3Vyc29yLmNsb3NlKCkKICAgIGRiLmNvbW1pdCgpCgoKZGVmIHNldF9hbmFseXNpc190YWdzKGRiLCBpZCwgdGFncyk6CiAgICAiIiIKICAgIENoYW5nZSB0aGUgc3RhdHVzIG9mIGFuIGFuYWx5c2lzIHJvdwogICAgOnBhcmFtIGRiOiB0aGUgZGF0YWJhc2Ugb2JqZWN0CiAgICA6cGFyYW0gaWQ6IGlkZW50aWZpZXIgb2YgdGhlIGFuYWx5c2lzIGlkZW50aWZpZXIKICAgIDpwYXJhbSB0YWdzOiB0YWdzIHN0cmluZwogICAgOnJldHVybjogbm90aGluZyAtIGlmIHlvdSBkbyBub3QgaGF2ZSBhbiBleGNlcHRpb24sIHlvdSBhcmUgZ29vZAogICAgIiIiCiAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQogICAgc3RtdCA9ICJVUERBVEUgYW5hbHlzaXNfcmVzdWx0cyBTRVQgdGFncz0nezB9JyBXSEVSRSBpZD17MX0iLmZvcm1hdCh0YWdzLCBpZCkKICAgIGxvZ2dpbmcuZGVidWcoc3RtdCkKICAgIGN1cnNvci5leGVjdXRlKHN0bXQpCiAgICBjdXJzb3IuY2xvc2UoKQogICAgZGIuY29tbWl0KCkKCgpkZWYgc2V0X3J1bm5pbmdfdGltZV9zZWMoZGIsIGlkLCBuc2VjKToKICAgICIiIgogICAgU2V0IHRoZSBydW5uaW5nIHRpbWUgb2YgYW4gYW5hbHlzaXMKICAgIDpwYXJhbSBkYjogdGhlIGRhdGFiYXNlIG9iamVjdAogICAgOnBhcmFtIGlkOiBpZGVudGlmaWVyIG9mIHRoZSBhbmFseXNpcyBpZGVudGlmaWVyCiAgICA6cGFyYW0gbnNlYzogdGhlIG51bWJlciBvZiBzZWNvbmRzIGl0IHRvb2sKICAgIDpyZXR1cm46IG5vdGhpbmcgLSBpZiB5b3UgZG8gbm90IGhhdmUgYW4gZXhjZXB0aW9uLCB5b3UgYXJlIGdvb2QKICAgICIiIgogICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKICAgIHN0bXQgPSAiVVBEQVRFIGFuYWx5c2lzX3Jlc3VsdHMgU0VUIHJ1bm5pbmdfdGltZV9zZWM9J3swfScgV0hFUkUgaWQ9ezF9Ii5mb3JtYXQobnNlYywgaWQpCiAgICBjdXJzb3IuZXhlY3V0ZShzdG10KQogICAgY3Vyc29yLmNsb3NlKCkKICAgIGRiLmNvbW1pdCgpCgoKZGVmIHNldF9yZXZpc2lvbihkYiwgYW5hbHlzaXNfaWQsIHJldmlzaW9uKToKICAgICIiIgogICAgU2V0IHRoZSByZXZpc2lvbiBvZiB0aGUgYW5hbHlzaXMKICAgIDpwYXJhbSBkYjogdGhlIGRhdGFiYXNlIG9iamVjdAogICAgOnBhcmFtIGFuYWx5c2lzX2lkOiBpZGVudGlmaWVyIG9mIHRoZSBhbmFseXNpcyBpZGVudGlmaWVyCiAgICA6cGFyYW0gcmV2aXNpb246IHRoZSByZXZpc2lvbiB0byBzZXQKICAgIDpyZXR1cm46IG5vdGhpbmcgLSBpZiB5b3UgZG8gbm90IGhhdmUgYW4gZXhjZXB0aW9uLCB5b3UgYXJlIGdvb2QKICAgICIiIgogICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKICAgIGxvZ2dpbmcuZGVidWcoIltFWEVDVVRPUl0gVXBkYXRpbmcgcmV2aXNpb24gZm9yIGFuYWx5c2lzIHswfSwgc2V0OiB7MX0iLmZvcm1hdChhbmFseXNpc19pZCwgcmV2aXNpb24pKQogICAgc3RtdCA9ICJVUERBVEUgYW5hbHlzaXNfcmVzdWx0cyBTRVQgcmV2aXNpb24gPSAlcyBXSEVSRSBpZD0lcyIKICAgIGN1cnNvci5leGVjdXRlKHN0bXQsIChyZXZpc2lvbiwgYW5hbHlzaXNfaWQpKQogICAgZGIuY29tbWl0KCkKICAgIGN1cnNvci5jbG9zZSgpCgoKZGVmIGFkZF92aW9sYXRpb25zKGRiLCBhbmFseXNpc19pZCwgYW5hbHlzaXNfcmVzdWx0X3Zpb2xhdGlvbnMsIHByb2plY3RfY29uZmlndXJhdGlvbj1Ob25lKToKICAgICIiIgogICAgQWRkIHZpb2xhdGlvbnMgdG8gdGhlIGRhdGFiYXNlLgogICAgOnBhcmFtIGRiOiB0aGUgbXlzcWwgZGF0YWJhc2UKICAgIDpwYXJhbSBhbmFseXNpc19pZDogdGhlIGFuYWx5c2lzIGlkIHJlbGF0ZWQgdG8gdGhlIHZpb2xhdGlvbnMKICAgIDpwYXJhbSBhbmFseXNpc19yZXN1bHRfdmlvbGF0aW9uczogYWxsIHRoZSB2aW9sYXRpb25zIHRoYXQgYXJlIHJlcG9ydGVkIC0gbGlzdCBvZiBtb2RlbC5WaW9sYXRpb24KICAgIDpwYXJhbSBwcm9qZWN0X2NvbmZpZ3VyYXRpb246IGRpY3Rpb25hcnkgb2YgdGhlIHByb2plY3QgY29uZmlndXJhdGlvbgogICAgOnJldHVybjogbm90aGluZwogICAgIiIiCgogICAgaWYgbm90IGFuYWx5c2lzX3Jlc3VsdF92aW9sYXRpb25zOgogICAgICAgIGxvZ2dpbmcuZGVidWcoIltEQl0gbm8gdmlvbGF0aW9ucyBpbiBhcnJheSwgcmV0dXJuaW5nIikKICAgICAgICByZXR1cm4KCiAgICBpZiBsZW4oYW5hbHlzaXNfcmVzdWx0X3Zpb2xhdGlvbnMpID09IDA6CiAgICAgICAgbG9nZ2luZy5kZWJ1ZygiW0RCXSBlbXB0eSBhcnJheSwgcmV0dXJuaW5nIikKICAgICAgICByZXR1cm4KCiAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQogICAgbG9nZ2luZy5kZWJ1ZygiW0RCXSBBZGRpbmcgezB9IHZpb2xhdGlvbnMgZm9yIGFuYWx5c2lzIHsxfSIuZm9ybWF0KGxlbihhbmFseXNpc19yZXN1bHRfdmlvbGF0aW9ucyksIGFuYWx5c2lzX2lkKSkKICAgIHBhdGhzX3RvX2lnbm9yZSA9IGNvbmZpZ3VyYXRpb24uZ2V0X3BhdGhfdG9faWdub3JlKHByb2plY3RfY29uZmlndXJhdGlvbikKCiAgICBmb3IgdmlvbGF0aW9uIGluIGFuYWx5c2lzX3Jlc3VsdF92aW9sYXRpb25zOgogICAgICAgIGluc2VydCA9IFRydWUKICAgICAgICBpZiBsZW4odmlvbGF0aW9uLmRlc2NyaXB0aW9uKSA+PSAxMDI0OgogICAgICAgICAgICBsb2dnaW5nLndhcm5pbmcoIltEQl0gLSBkZXNjcmlwdGlvbiB0b28gbG9uZyAtIHNraXBwaW5nIikKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgaWYgdmlvbGF0aW9uLnJ1bGUgYW5kIGxlbih2aW9sYXRpb24ucnVsZSkgPj0gMTAwOgogICAgICAgICAgICBsb2dnaW5nLndhcm5pbmcoIltEQl0gLSBydWxlICglcykgdG9vIGxvbmcgLSB0cmltbWluZyIsIHZpb2xhdGlvbi5ydWxlKQogICAgICAgICAgICB2aW9sYXRpb24ucnVsZSA9IHZpb2xhdGlvbi5ydWxlWzA6OTldCgogICAgICAgIGZvciBwIGluIHBhdGhzX3RvX2lnbm9yZToKICAgICAgICAgICAgaWYgdmlvbGF0aW9uLmZpbGVuYW1lLnN0YXJ0c3dpdGgocCk6CiAgICAgICAgICAgICAgICBsb2dnaW5nLmRlYnVnKCJbREJdIC0gaWdub3JlIHZpb2xhdGlvbiBmb3IgZmlsZW5hbWUgezB9IGJlY2F1c2UgdGhpcyBpcyBpbiBwYXRoIHsxfSIuZm9ybWF0KHZpb2xhdGlvbi5maWxlbmFtZSwgcCkpCiAgICAgICAgICAgICAgICBpbnNlcnQgPSBGYWxzZQoKICAgICAgICBpZiBpbnNlcnQ6CiAgICAgICAgICAgIHN0bXQgPSAiSU5TRVJUIElOVE8gYW5hbHlzaXNfcmVzdWx0c192aW9sYXRpb25zIiBcCiAgICAgICAgICAgICAgICAgICAiIChhbmFseXNpc19pZCwgZmlsZW5hbWUsIGxpbmUsIGRlc2NyaXB0aW9uLCBzZXZlcml0eSwgY2F0ZWdvcnksIGxpbmVfY291bnQsIHRvb2wsIiBcCiAgICAgICAgICAgICAgICAgICAiIGxhbmd1YWdlLCBydWxlLCBydWxlc2V0LCBydWxldXJsLCBjb2RlaGFzaCkgIiBcCiAgICAgICAgICAgICAgICAgICAiIFZBTFVFUyglcywgJXMsICVzLCAlcywgJXMsICVzLCAlcywgJXMsICVzLCAlcywgJXMsICVzLCAlcykiCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKHN0bXQsIChhbmFseXNpc19pZCwgdmlvbGF0aW9uLmZpbGVuYW1lLCB2aW9sYXRpb24ubGluZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpb2xhdGlvbi5kZXNjcmlwdGlvbiwgdmlvbGF0aW9uLnNldmVyaXR5LCB2aW9sYXRpb24uY2F0ZWdvcnkudmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aW9sYXRpb24ubGluZV9jb3VudCwgdmlvbGF0aW9uLnRvb2wsIHZpb2xhdGlvbi5sYW5ndWFnZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpb2xhdGlvbi5ydWxlLCB2aW9sYXRpb24ucnVsZV9zZXQsIHZpb2xhdGlvbi5ydWxlX3VybCwgdmlvbGF0aW9uLmNvZGVoYXNoKSkKICAgIGRiLmNvbW1pdCgpCiAgICBjdXJzb3IuY2xvc2UoKQoKCmRlZiBnZXRfbWF4X2RhaWx5X2FuYWx5c2VzX2Zvcl9wcm9qZWN0KGRhdGFiYXNlX2Nvbm5lY3Rpb24sIHByb2plY3RfaWQpOgogICAgIiIiCiAgICBHZXQgdGhlIG1heCBudW1iZXIgb2YgYW5hbHlzZXMgdGhhdCBjYW4gYmUgZG9uZSBmb3IgYSBwcm9qZWN0CiAgICA6cGFyYW0gZGF0YWJhc2VfY29ubmVjdGlvbjoKICAgIDpwYXJhbSBwcm9qZWN0X2lkOiB0aGUgaWRlbnRpZmllciBvZiB0aGUgcHJvamVjdAogICAgOnJldHVybjoKICAgICIiIgoKICAgIGlmIG5vdCBwcm9qZWN0X2lkOgogICAgICAgIGxvZ2dpbmcud2FybmluZygiW0RCXSBnZXRfbWF4X2FuYWx5c2VzX2Zvcl9wcm9qZWN0IC0gcHJvamVjdF9pZCBpcyBOb25lIikKICAgICAgICByZXR1cm4gY29uc3RhbnRzLk1BWF9EQUlMWV9BTkFMWVNFU19CQVNJQwoKICAgIGN1cnNvciA9IGRhdGFiYXNlX2Nvbm5lY3Rpb24uY3Vyc29yKCkKICAgIGN1cnNvci5leGVjdXRlKCJzZWxlY3Qgb3duZXJfaWQsIGdyb3VwX2lkIGZyb20gcHJvamVjdHMgd2hlcmUgaWQ9JXMiLCAocHJvamVjdF9pZCwpKQogICAgcmVzdWx0ID0gY3Vyc29yLmZldGNob25lKCkKICAgIGN1cnNvci5jbG9zZSgpCgogICAgaWYgbm90IHJlc3VsdDoKICAgICAgICBsb2dnaW5nLndhcm5pbmcoIltEQl0gZ2V0X21heF9hbmFseXNlc19mb3JfcHJvamVjdCAtIHJlc3VsdHMgYXJlIE5vbmUgZm9yIHByb2plY3RfaWQgJXMiLCBwcm9qZWN0X2lkKQogICAgICAgIHJldHVybiBjb25zdGFudHMuTUFYX0RBSUxZX0FOQUxZU0VTX0JBU0lDCgogICAgb3duZXJfaWQgPSByZXN1bHRbMF0KICAgIGdyb3VwX2lkID0gTm9uZQoKICAgICMgR3JvdXAgaWQgY2FuIGJlIG5vbmUsIGxldCdzIGNoZWNrIGJlZm9yZSBjb252ZXJ0aW5nIHRvIGEgbnVtYmVyCiAgICBpZiByZXN1bHRbMV06CiAgICAgICAgZ3JvdXBfaWQgPSBpbnQocmVzdWx0WzFdKQoKICAgIGxldmVsID0gY29uc3RhbnRzLlVTRVJfQkFTSUMKCiAgICAjIElmIGdyb3VwX2lkIGlzIG5vdCBub25lLCB0aGUgcHJvamVjdCBpcyB0aGVuIG93bmVkIGJ5IGEgZ3JvdXAgYW5kIG5vdCBhIHVzZXIKICAgIGlmIGdyb3VwX2lkIGlzIG5vdCBOb25lOgogICAgICAgIGN1cnNvciA9IGRhdGFiYXNlX2Nvbm5lY3Rpb24uY3Vyc29yKCkKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgic2VsZWN0IGxldmVsIGZyb20gYGdyb3Vwc2Agd2hlcmUgaWQ9JXMiLCAoZ3JvdXBfaWQsKSkKICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIGN1cnNvci5jbG9zZSgpCgogICAgICAgIGlmIHJlc3VsdDoKICAgICAgICAgICAgbGV2ZWwgPSBpbnQocmVzdWx0WzBdKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dpbmcuZGVidWcoIltEQl0gZ2V0X21heF9hbmFseXNlc19mb3JfcHJvamVjdCAtIHJlc3VsdHMgYXJlIE5vbmUgZm9yIGdyb3VwX2lkICVzIiwgZ3JvdXBfaWQpCiAgICBlbHNlOgogICAgICAgIGN1cnNvciA9IGRhdGFiYXNlX2Nvbm5lY3Rpb24uY3Vyc29yKCkKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgic2VsZWN0IGxldmVsIGZyb20gdXNlcnMgd2hlcmUgaWQ9JXMiLCAob3duZXJfaWQsKSkKICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIGN1cnNvci5jbG9zZSgpCgogICAgICAgIGlmIHJlc3VsdDoKICAgICAgICAgICAgbGV2ZWwgPSBpbnQocmVzdWx0WzBdKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dpbmcuZGVidWcoIltEQl0gZ2V0X21heF9hbmFseXNlc19mb3JfcHJvamVjdCAtIHJlc3VsdHMgYXJlIE5vbmUgZm9yIG93bmVyX2lkICVzIiwgb3duZXJfaWQpCgogICAgcmV0dXJuIGdldF9tYXhfYW5hbHlzZXNfZm9yX2xldmVsKGxldmVsKQoKCmRlZiBhZGRfZHVwbGljYXRlcyhkYiwgYW5hbHlzaXNfaWQsIGR1cGxpY2F0aW9ucywgcHJvamVjdF9jb25maWd1cmF0aW9uID0gTm9uZSk6CiAgICAiIiIKICAgIEFkZCB2aW9sYXRpb25zIHRvIHRoZSBkYXRhYmFzZS4KICAgIDpwYXJhbSBkYjogdGhlIG15c3FsIGRhdGFiYXNlCiAgICA6cGFyYW0gYW5hbHlzaXNfaWQ6IHRoZSBhbmFseXNpcyBpZCByZWxhdGVkIHRvIHRoZSB2aW9sYXRpb25zCiAgICA6cGFyYW0gZHVwbGljYXRpb25zOiBhbGwgdGhlIGR1cGxpY2F0aW9ucyB3ZSBuZWVkIHRvIGFkZCAtIGxpc3Qgb2YgRHVwbGljYXRpb24gb2JqZWN0cwogICAgOnJldHVybjogbm90aGluZwogICAgIiIiCgogICAgbG9nZ2luZy5kZWJ1ZygiQWRkaW5nIGR1cGxpY2F0aW9uIGZvciBhbmFseXNpcyB7MH0iLmZvcm1hdChhbmFseXNpc19pZCkpCgogICAgZm9yIGR1cGxpY2F0aW9uIGluIGR1cGxpY2F0aW9uczoKICAgICAgICBmaWx0ZXJlZF9vY2N1cnJlbmNlcyA9IGNvbW1vbi5maWx0ZXJfb2NjdXJyZW5jZXNfZnJvbV9kdXBsaWNhdGUoZHVwbGljYXRpb24sIHByb2plY3RfY29uZmlndXJhdGlvbikKCiAgICAgICAgaWYgbGVuKGZpbHRlcmVkX29jY3VycmVuY2VzKSA9PSAwOgogICAgICAgICAgICBsb2dnaW5nLmRlYnVnKCJJZ25vcmUgZHVwbGljYXRlIGJlY2F1c2Ugbm8gb2NjdXJyZW5jZSIpCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGN1cnNvciA9IGRiLmN1cnNvcigpCiAgICAgICAgc3RtdCA9ICJJTlNFUlQgSU5UTyBhbmFseXNpc19yZXN1bHRzX2R1cGxpY2F0ZXMgVkFMVUVTKDAsICVzLCAlcywgJXMsICVzKSIKICAgICAgICBjdXJzb3IuZXhlY3V0ZShzdG10LCAoYW5hbHlzaXNfaWQsIGR1cGxpY2F0aW9uLmxpbmVzLCBkdXBsaWNhdGlvbi50b2tlbnMsIGR1cGxpY2F0aW9uLnNhbXBsZSkpCiAgICAgICAgZGIuY29tbWl0KCkKICAgICAgICBjdXJzb3IuY2xvc2UoKQoKICAgICAgICAjIE5vdGU6IHRoZSBsYXN0X2luc2VydF9pZCBpcyBwZXIgY29ubmVjdGlvbi4gVGhpcyBjb2RlIHdpbGwgd29yayBhcyBsb25nIGFzIHdlIGhhdmUKICAgICAgICAjIG9uZSBjb25uZWN0aW9uIHBlciB0aHJlYWQgaW50byB0aGUgZGF0YWJhc2UuCiAgICAgICAgZm9yIG9jY3VycmVuY2UgaW4gZmlsdGVyZWRfb2NjdXJyZW5jZXM6CiAgICAgICAgICAgIGN1cnNvciA9IGRiLmN1cnNvcigpCiAgICAgICAgICAgIHN0bXQgPSAiSU5TRVJUIElOVE8gYW5hbHlzaXNfcmVzdWx0c19kdXBsaWNhdGVzX3ZhbHVlcyBWQUxVRVMobGFzdF9pbnNlcnRfaWQoKSwgJXMsICVzKSIKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoc3RtdCwgKG9jY3VycmVuY2UuZmlsZW5hbWUsIG9jY3VycmVuY2UubGluZSkpCiAgICAgICAgICAgIGRiLmNvbW1pdCgpCiAgICAgICAgICAgIGN1cnNvci5jbG9zZSgpCiAgICBkYi5jb21taXQoKQoKZGVmIGdldF92aW9sYXRpb25zKGRiLCBhbmFseXNpc19pZCwgcHJvamVjdF9pZD1Ob25lKToKICAgICIiIgogICAgR2V0IGFsbCB0aGUgdmlvbGF0aW9ucyBmb3IgYSBwYXJ0aWN1bGFyIGFuYWx5c2lzLiBGaWx0ZXIgdGhlIHZpb2xhdGlvbnMgZm9yIGEgcGFydGljdWxhciBwcm9qZWN0LgogICAgSWYgeW91IGRvIG5vdCB3YW50IHRvIGZpbHRlciB2aW9sYXRpb25zLCBwYXNzIE5vbmUgZm9yIHRoZSBwcm9qZWN0X2lkLgoKICAgIDpwYXJhbSBkYjogdGhlIGRhdGFiYXNlIGxpbmsgdG8gdXNlIHRvIGNvbm5lY3QKICAgIDpwYXJhbSBhbmFseXNpc19pZDogdGhlIGFuYWx5c2lzIGlkZW50aWZpZXIKICAgIDpwYXJhbSBwcm9qZWN0X2lkOiBwcm9qZWN0IGlkIG9mIHRoZSBhbmFseXNpcy4gSWYgbm90IE5vbmUsIHVzZWQgdG8gZmlsdGVyIHZpb2xhdGlvbnMuCiAgICA6cmV0dXJuOgogICAgIiIiCiAgICB2aW9sYXRpb25zID0gW10KICAgIGN1cnNvciA9IGRiLmN1cnNvcigpCgogICAgIyBNYWtlIHN1cmUgd2Ugc2NoZWR1bGUgb25seSBhY3RpdmUgcHJvamVjdHMKICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1QgZmlsZW5hbWUsIGxpbmUsIGRlc2NyaXB0aW9uLCBzZXZlcml0eSwgY2F0ZWdvcnksIGxpbmVfY291bnQsIHRvb2wsIGxhbmd1YWdlLCBydWxlLCBydWxlc2V0LCBydWxldXJsIGZyb20gYW5hbHlzaXNfcmVzdWx0c192aW9sYXRpb25zIFdIRVJFIGFuYWx5c2lzX2lkPSVzOyIsIChhbmFseXNpc19pZCwgKSkKICAgIGZvciB4IGluIGN1cnNvcjoKICAgICAgICBjYXRlZ29yeSA9IHZpb2xhdGlvbl92YWx1ZV90b192aW9sYXRpb25fY2F0ZWdvcnkoaW50KHhbNF0pKQogICAgICAgIHZpb2xhdGlvbiA9IFZpb2xhdGlvbih4WzBdLCBpbnQoeFsxXSksIHhbMl0sIGludCh4WzNdKSwgY2F0ZWdvcnksIGludCh4WzVdKSwgeFs2XSwgeFs3XSwgeFs4XSwgeFs5XSwgeFsxMF0pCiAgICAgICAgdmlvbGF0aW9ucy5hcHBlbmQodmlvbGF0aW9uKQogICAgY3Vyc29yLmNsb3NlKCkKCiAgICAjIE5vdywgYXR0ZW1wdCB0byBmaWx0ZXIgdmlvbGF0aW9ucyB3aXRoIHdoYXQgdGhlIHVzZXIgaWdub3Jlcy4KICAgIHZpb2xhdGlvbnNfdG9faWdub3JlID0gZ2V0X3Zpb2xhdGlvbnNfdG9faWdub3JlKGRiLCBwcm9qZWN0X2lkKQogICAgZmlsdGVyZWRfcmVzdWx0ID0gZmlsdGVyX3Zpb2xhdGlvbnModmlvbGF0aW9ucywgdmlvbGF0aW9uc190b19pZ25vcmUpCgogICAgcmV0dXJuIGZpbHRlcmVkX3Jlc3VsdAoKCmRlZiBnZXRfdmlvbGF0aW9uc190b19pZ25vcmUoZGIsIHByb2plY3RfaWQpOgogICAgIiIiCiAgICBHZXQgYWxsIHRoZSB2aW9sYXRpb25zIGZvciBhIHBhcnRpY3VsYXIgYW5hbHlzaXMuCgogICAgOnBhcmFtIGRiOiB0aGUgZGF0YWJhc2UgbGluayB0byB1c2UgdG8gY29ubmVjdAogICAgOnBhcmFtIHByb2plY3RfaWQ6IHRoZSBwcm9qZWN0IGlkIHRoYXQgY29udGFpbnMgYWxsIHRoZSB2aW9sYXRpb25zIHRvIGlnbm9yZQogICAgOnJldHVybjoKICAgICIiIgogICAgcmVzdWx0ID0gW10KCiAgICBpZiBub3QgcHJvamVjdF9pZDoKICAgICAgICByZXR1cm4gcmVzdWx0CgogICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKCiAgICAjIE1ha2Ugc3VyZSB3ZSBzY2hlZHVsZSBvbmx5IGFjdGl2ZSBwcm9qZWN0cwogICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCBwcm9qZWN0X2lkLCBmaWxlbmFtZSwgcHJlZml4LCBsYW5ndWFnZSwgZGVzY3JpcHRpb24sIHRvb2wsIHJ1bGUgZnJvbSB2aW9sYXRpb25zX3RvX2lnbm9yZSBXSEVSRSBwcm9qZWN0X2lkPSVzOyIsIChwcm9qZWN0X2lkLCApKQogICAgZm9yIHggaW4gY3Vyc29yOgogICAgICAgIGkgPSBWaW9sYXRpb25Ub0lnbm9yZShpbnQoeFswXSksIHhbMV0sIHhbMl0sIHhbM10sIHhbNF0sIHhbNV0sIHhbNl0pCiAgICAgICAgcmVzdWx0LmFwcGVuZChpKQogICAgY3Vyc29yLmNsb3NlKCkKICAgIHJldHVybiByZXN1bHQKCgpkZWYgZ2V0X2NvbXBsZXhpdHlfZnVuY3Rpb25zKGRiLCBhbmFseXNpc19pZCk6CiAgICAiIiIKICAgIEdldCBjb21wbGV4aXR5IGZ1bmN0aW9ucyBtZXRyaWNzCiAgICA6cGFyYW0gZGI6IHRoZSBkYXRhYmFzZSBsaW5rIHRvIHVzZSB0byBjb25uZWN0CiAgICA6cGFyYW0gYW5hbHlzaXNfaWQ6IHRoZSBhbmFseXNpcyBpZGVudGlmaWVyCiAgICA6cmV0dXJuOgogICAgIiIiCiAgICByZXN1bHQgPSBbXQoKICAgIGlmIG5vdCBhbmFseXNpc19pZDoKICAgICAgICByZXR1cm4gcmVzdWx0CgogICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKCiAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUIGZpbGVuYW1lLCBmdW5jdGlvbl9uYW1lLCBsaW5lX3N0YXJ0LCBsaW5lX2VuZCwgY29tcGxleGl0eSwgcGFyYW1zLCBubG9jLCBsZW5ndGggRlJPTSBjb21wbGV4aXR5X21ldHJpY3NfZnVuY3Rpb25zIFdIRVJFIGFuYWx5c2lzX2lkPSVzOyIsIChhbmFseXNpc19pZCwgKSkKICAgIGZvciB4IGluIGN1cnNvcjoKICAgICAgICBjZiA9IENvbXBsZXhpdHlNZXRyaWNGdW5jdGlvbih4WzBdLCB4WzFdLCBpbnQoeFsyXSksIGludCh4WzNdKSwgaW50KHhbNF0pLCBpbnQoeFs1XSksIGludCh4WzZdKSwgaW50KHhbN10pKQogICAgICAgIHJlc3VsdC5hcHBlbmQoY2YpCiAgICBjdXJzb3IuY2xvc2UoKQogICAgcmV0dXJuIHJlc3VsdAoKCmRlZiBnZXRfY29uZmlybWVkX25vdGlmaWNhdGlvbnMoZGIsIHByb2plY3RfaWQpOgogICAgIiIiCiAgICBHZXQgdGhlIGxpc3Qgb2YgY29uZmlybWVkIG5vdGlmaWNhdGlvbnMgZm9yIGEgcGFydGljdWxhciBwcm9qZWN0CiAgICA6cGFyYW0gZGI6IGNvbm5lY3Rpb24gdG8gdGhlIG15c3FsIGRhdGFiYXNlCiAgICA6cGFyYW0gcHJvamVjdF9pZDogdGhlIHByb2plY3QgaWQKICAgIDpyZXR1cm46IGEgbGlzdCBvZiBjb25maXJtZWQgbm90aWZpY2F0aW9uCiAgICAiIiIKICAgIGN1cnNvciA9IGRiLmN1cnNvcigpCiAgICBjdXJzb3IuZXhlY3V0ZSgiIiJzZWxlY3QgZXZlbnRfdHlwZSwgbm90aWZpY2F0aW9uX3R5cGUgLCBub3RpZmljYXRpb25fdmFsdWUgZnJvbSBwcm9qZWN0c19ub3RpZmljYXRpb25zIHdoZXJlIHN0YXR1cyA9ICVzIGFuZCBwcm9qZWN0X2lkID0gJXMiIiIsIChjb25zdGFudHMuTk9USUZJQ0FUSU9OX1NUQVRVU19DT05GSVJNRUQsIHByb2plY3RfaWQsKSkKICAgIHJlc3VsdCA9IFtdCiAgICBmb3IgeCBpbiBjdXJzb3IuZmV0Y2hhbGwoKToKICAgICAgICByZXN1bHQuYXBwZW5kKHsiZXZlbnRfdHlwZSI6IHhbMF0sICJub3RpZmljYXRpb25fdHlwZSI6IHhbMV0sICJub3RpZmljYXRpb25fdmFsdWUiOiB4WzJdfSkKICAgIGN1cnNvci5jbG9zZSgpCiAgICByZXR1cm4gcmVzdWx0CgoKZGVmIGdldF9tb3N0X3JlY2VudF9hbmFseXNpc19pZChkYiwgcHJvamVjdF9pZCk6CiAgICAiIiIKICAgIEdldCB0aGUgbW9zdCByZWNlbnQgYW5hbHlzaXMgaWQgZm9yIGEgcHJvamVjdAogICAgOnBhcmFtIGRiOiB0aGUgZGF0YWJhc2Ugb2JqZWN0CiAgICA6cGFyYW0gcHJvamVjdF9pZDogdGhlIHByb2plY3QgdW5kZXIgY29uc2lkZXJhdGlvbgogICAgOnJldHVybjoKICAgICIiIgogICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKICAgIGN1cnNvci5leGVjdXRlKCIiInNlbGVjdCBpZCBmcm9tIGFuYWx5c2lzX3Jlc3VsdHMgd2hlcmUgcHJvamVjdF9pZD0lcyBBTkQgc3RhdHVzPSdET05FJyBPUkRFUiBCWSBpZCBERVNDIExJTUlUIDEiIiIsIChwcm9qZWN0X2lkLCkpCiAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgY3Vyc29yLmNsb3NlKCkKICAgIGlmIHJlc3VsdDoKICAgICAgICByZXR1cm4gcmVzdWx0WzBdCiAgICBlbHNlOgogICAgICAgIHJldHVybiBOb25lCgoKZGVmIGdldF9wcmV2aW91c19yZWNlbnRfYW5hbHlzaXNfaWQoZGIsIHByb2plY3RfaWQpOgogICAgIiIiCiAgICBHZXQgdGhlIG4gLSAxICh0aGUgYW5hbHlzaXMgYmVmb3JlIHRoZSBsYXN0IG9uZSkgYW5hbHlzaXMgaWQgZm9yIGEgcHJvamVjdC4KICAgIFRoZSBwcmV2aW91cyBhbmFseXNpcyBNVVNUIGJlIGEgcHJvamVjdCBhbmFseXNpcwogICAgOnBhcmFtIGRiOiB0aGUgZGF0YWJhc2Ugb2JqZWN0CiAgICA6cGFyYW0gcHJvamVjdF9pZDogdGhlIHByb2plY3QgdW5kZXIgY29uc2lkZXJhdGlvbgogICAgOnJldHVybjoKICAgICIiIgogICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKICAgIGN1cnNvci5leGVjdXRlKCIiInNlbGVjdCBpZCBmcm9tIGFuYWx5c2lzX3Jlc3VsdHMgd2hlcmUgcHJvamVjdF9pZD0lcyBBTkQgc3RhdHVzPSdET05FJyBBTkQga2luZD0lcyBPUkRFUiBCWSBpZCBERVNDIExJTUlUIDIiIiIsIChwcm9qZWN0X2lkLCBjb25zdGFudHMuQU5BTFlTSVNfS0lORF9QUk9KRUNUKSkKICAgIHJlc3VsdCA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICBjdXJzb3IuY2xvc2UoKQogICAgaWYgcmVzdWx0IGFuZCBsZW4ocmVzdWx0KSA+IDE6CiAgICAgICAgcmV0dXJuIHJlc3VsdFsxXVswXQogICAgZWxzZToKICAgICAgICByZXR1cm4gTm9uZQoKCmRlZiBnZXRfbnVtYmVyX2R1cGxpY2F0aW9uc19mb3JfYW5hbHlzaXMoZGIsIGFuYWx5c2lzX2lkKToKICAgICIiIgogICAgR2V0IHRoZSBudW1iZXIgb2YgZHVwbGljYXRpb25zIGZvciBhIHBhcnRpY3VsYXIgYW5hbHlzaXMKICAgIDpwYXJhbSBkYjogdGhlIGRhdGFiYXNlIG9iamVjdAogICAgOnBhcmFtIGFuYWx5c2lzX2lkOiB0aGUgYW5hbHlzaXMgaWRlbnRpZmllcgogICAgOnJldHVybjoKICAgICIiIgogICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKICAgIGN1cnNvci5leGVjdXRlKCIiInNlbGVjdCBjb3VudCgqKSBmcm9tIGFuYWx5c2lzX3Jlc3VsdHNfZHVwbGljYXRlcyB3aGVyZSBhbmFseXNpc19pZD0lcyIiIiwgKGFuYWx5c2lzX2lkLCkpCiAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgY3Vyc29yLmNsb3NlKCkKICAgIGlmIHJlc3VsdDoKICAgICAgICByZXR1cm4gcmVzdWx0WzBdCiAgICBlbHNlOgogICAgICAgIHJldHVybiBOb25lCgoKZGVmIGdldF9udW1iZXJfdmlvbGF0aW9uc19mb3JfYW5hbHlzaXMoZGIsIGFuYWx5c2lzX2lkKToKICAgICIiIgogICAgR2V0IHRoZSBudW1iZXIgb2YgdmlvbGF0aW9ucyBmb3IgYSBwYXJ0aWN1bGFyIGFuYWx5c2lzCiAgICA6cGFyYW0gZGI6IHRoZSBkYXRhYmFzZSBvYmplY3QgdG8gcXVlcnkKICAgIDpwYXJhbSBhbmFseXNpc19pZDogdGhlIGFuYWx5c2lzIGlkZW50aWZpZXIKICAgIDpyZXR1cm46CiAgICAiIiIKICAgIGN1cnNvciA9IGRiLmN1cnNvcigpCiAgICBjdXJzb3IuZXhlY3V0ZSgiIiJzZWxlY3QgY291bnQoKikgZnJvbSBhbmFseXNpc19yZXN1bHRzX3Zpb2xhdGlvbnMgd2hlcmUgYW5hbHlzaXNfaWQ9JXMiIiIsIChhbmFseXNpc19pZCwpKQogICAgaWYgY3Vyc29yLnJvd2NvdW50ID09IDA6CiAgICAgICAgcmV0dXJuIE5vbmUKICAgIHJlc3VsdCA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICBjdXJzb3IuY2xvc2UoKQogICAgaWYgcmVzdWx0OgogICAgICAgIHJldHVybiByZXN1bHRbMF0KICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIE5vbmUKCgpkZWYgYWRkX2NvbXBsZXhpdHlfbWV0cmljc19mdW5jdGlvbnMoZGIsIGFuYWx5c2lzX2lkLCBjb21wbGV4aXR5X21ldHJpY3NfZnVuY3Rpb25zLCBwcm9qZWN0X2NvbmZpZ3VyYXRpb249Tm9uZSk6CiAgICAiIiIKICAgIEFkZCB2aW9sYXRpb25zIHRvIHRoZSBkYXRhYmFzZS4KICAgIDpwYXJhbSBkYjogdGhlIG15c3FsIGRhdGFiYXNlCiAgICA6cGFyYW0gYW5hbHlzaXNfaWQ6IHRoZSBhbmFseXNpcyBpZCByZWxhdGVkIHRvIHRoZSB2aW9sYXRpb25zCiAgICA6cGFyYW0gY29tcGxleGl0eV9tZXRyaWNzX2Z1bmN0aW9uczogYWxsIHRoZSBjb21wbGV4aXR5IG1ldHJpYyBmdW5jdGlvbnMgdG8gYWRkCiAgICA6cGFyYW0gcHJvamVjdF9jb25maWd1cmF0aW9uOiBkaWN0aW9uYXJ5IG9mIHRoZSBwcm9qZWN0IGNvbmZpZ3VyYXRpb24KICAgIDpyZXR1cm46IG5vdGhpbmcKICAgICIiIgoKICAgIGlmIG5vdCBjb21wbGV4aXR5X21ldHJpY3NfZnVuY3Rpb25zOgogICAgICAgIGxvZ2dpbmcuZGVidWcoIltEQl0gbm8gbWV0cmljcyB0byBhZGQsIHJldHVybmluZyIpCiAgICAgICAgcmV0dXJuCgogICAgaWYgbGVuKGNvbXBsZXhpdHlfbWV0cmljc19mdW5jdGlvbnMpID09IDA6CiAgICAgICAgbG9nZ2luZy5kZWJ1ZygiW0RCXSBlbXB0eSBhcnJheSwgcmV0dXJuaW5nIikKICAgICAgICByZXR1cm4KCiAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQogICAgbG9nZ2luZy5kZWJ1ZygiW0RCXSBBZGRpbmcgezB9IGNvbXBsZXhpdHkgbWV0cmljcyBmb3IgZnVuY3Rpb24gZm9yIGFuYWx5c2lzIHsxfSIuZm9ybWF0KGxlbihjb21wbGV4aXR5X21ldHJpY3NfZnVuY3Rpb25zKSwgYW5hbHlzaXNfaWQpKQogICAgcGF0aHNfdG9faWdub3JlID0gY29uZmlndXJhdGlvbi5nZXRfcGF0aF90b19pZ25vcmUocHJvamVjdF9jb25maWd1cmF0aW9uKQoKICAgIGZvciBjb21wbGV4aXR5X21ldHJpYyBpbiBjb21wbGV4aXR5X21ldHJpY3NfZnVuY3Rpb25zOgogICAgICAgIGluc2VydCA9IFRydWUKCiAgICAgICAgZm9yIHAgaW4gcGF0aHNfdG9faWdub3JlOgogICAgICAgICAgICBpZiBjb21wbGV4aXR5X21ldHJpYy5maWxlbmFtZS5zdGFydHN3aXRoKHApOgogICAgICAgICAgICAgICAgbG9nZ2luZy5kZWJ1ZygiW0RCXSAtIGlnbm9yZSBjb21wbGV4aXR5IG1ldHJpYyBmb3IgZmlsZW5hbWUgezB9IGJlY2F1c2UgdGhpcyBpcyBpbiBwYXRoIHsxfSIuZm9ybWF0KGNvbXBsZXhpdHlfbWV0cmljLmZpbGVuYW1lLCBwKSkKICAgICAgICAgICAgICAgIGluc2VydCA9IEZhbHNlCgogICAgICAgIGlmIGluc2VydDoKICAgICAgICAgICAgc3RtdCA9ICJJTlNFUlQgSU5UTyBjb21wbGV4aXR5X21ldHJpY3NfZnVuY3Rpb25zIFZBTFVFUyglcywgJXMsICVzLCAlcywgJXMsICVzLCAlcywgJXMsICVzLCAlcykiCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKHN0bXQsIChhbmFseXNpc19pZCwgY29tcGxleGl0eV9tZXRyaWMuZmlsZW5hbWUsIGNvbXBsZXhpdHlfbWV0cmljLmZ1bmN0aW9uX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV4aXR5X21ldHJpYy5saW5lX3N0YXJ0LCBjb21wbGV4aXR5X21ldHJpYy5saW5lX2VuZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXhpdHlfbWV0cmljLmN5Y2xvbWF0aWNfY29tcGxleGl0eSwgY29tcGxleGl0eV9tZXRyaWMucGFyYW1zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxleGl0eV9tZXRyaWMubmxvYywgY29tcGxleGl0eV9tZXRyaWMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0X2xhbmd1YWdlX2Zvcl9maWxlbmFtZShjb21wbGV4aXR5X21ldHJpYy5maWxlbmFtZSkpKQogICAgZGIuY29tbWl0KCkKICAgIGN1cnNvci5jbG9zZSgpCgoKZGVmIGFkZF9jb21wbGV4aXR5X21ldHJpY3Nfc3VtbWFyaWVzKGRiLCBhbmFseXNpc19pZCwgY29tcGxleGl0eV9tZXRyaWNzX3N1bW1hcmllcywgcHJvamVjdF9jb25maWd1cmF0aW9uID0gTm9uZSk6CiAgICAiIiIKICAgIEFkZCB2aW9sYXRpb25zIHRvIHRoZSBkYXRhYmFzZS4KICAgIDpwYXJhbSBkYjogdGhlIG15c3FsIGRhdGFiYXNlCiAgICA6cGFyYW0gYW5hbHlzaXNfaWQ6IHRoZSBhbmFseXNpcyBpZCByZWxhdGVkIHRvIHRoZSB2aW9sYXRpb25zCiAgICA6cGFyYW0gY29tcGxleGl0eV9tZXRyaWNzX3N1bW1hcmllczogYWxsIHRoZSBjb21wbGV4aXR5IG1ldHJpYyBzdW1tYXJ5IHRvIGFkZAogICAgOnBhcmFtIHByb2plY3RfY29uZmlndXJhdGlvbjogZGljdGlvbmFyeSBvZiB0aGUgcHJvamVjdCBjb25maWd1cmF0aW9uCiAgICA6cmV0dXJuOiBub3RoaW5nCiAgICAiIiIKCiAgICBpZiBub3QgY29tcGxleGl0eV9tZXRyaWNzX3N1bW1hcmllczoKICAgICAgICBsb2dnaW5nLmRlYnVnKCJbREJdIG5vIG1ldHJpY3MgdG8gYWRkLCByZXR1cm5pbmciKQogICAgICAgIHJldHVybgoKICAgIGlmIGxlbihjb21wbGV4aXR5X21ldHJpY3Nfc3VtbWFyaWVzKSA9PSAwOgogICAgICAgIGxvZ2dpbmcuZGVidWcoIltEQl0gZW1wdHkgYXJyYXksIHJldHVybmluZyIpCiAgICAgICAgcmV0dXJuCgogICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKICAgIGxvZ2dpbmcuZGVidWcoIltEQl0gQWRkaW5nIHswfSBjb21wbGV4aXR5IG1ldHJpY3MgZm9yIHN1bW1hcnkgZm9yIGFuYWx5c2lzIHsxfSIuZm9ybWF0KGxlbihjb21wbGV4aXR5X21ldHJpY3Nfc3VtbWFyaWVzKSwgYW5hbHlzaXNfaWQpKQogICAgcGF0aHNfdG9faWdub3JlID0gY29uZmlndXJhdGlvbi5nZXRfcGF0aF90b19pZ25vcmUocHJvamVjdF9jb25maWd1cmF0aW9uKQoKICAgIGZvciBjb21wbGV4aXR5X21ldHJpYyBpbiBjb21wbGV4aXR5X21ldHJpY3Nfc3VtbWFyaWVzOgogICAgICAgIGluc2VydCA9IFRydWUKCiAgICAgICAgZm9yIHAgaW4gcGF0aHNfdG9faWdub3JlOgogICAgICAgICAgICBpZiBjb21wbGV4aXR5X21ldHJpYy5maWxlbmFtZS5zdGFydHN3aXRoKHApOgogICAgICAgICAgICAgICAgbG9nZ2luZy5kZWJ1ZygiW0RCXSAtIGlnbm9yZSBjb21wbGV4aXR5IG1ldHJpYyBmb3IgZmlsZW5hbWUgezB9IGJlY2F1c2UgdGhpcyBpcyBpbiBwYXRoIHsxfSIuZm9ybWF0KGNvbXBsZXhpdHlfbWV0cmljLmZpbGVuYW1lLCBwKSkKICAgICAgICAgICAgICAgIGluc2VydCA9IEZhbHNlCgogICAgICAgIGlmIGluc2VydDoKICAgICAgICAgICAgc3RtdCA9ICJJTlNFUlQgSU5UTyBjb21wbGV4aXR5X21ldHJpY3Nfc3VtbWFyeSBWQUxVRVMoJXMsICVzLCAlcywgJXMsICVzLCAlcywgJXMpIgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZShzdG10LCAoYW5hbHlzaXNfaWQsIGNvbXBsZXhpdHlfbWV0cmljLmZpbGVuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxleGl0eV9tZXRyaWMubmxvYywgY29tcGxleGl0eV9tZXRyaWMuYXZnX25sb2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV4aXR5X21ldHJpYy5mdW5jdGlvbnNfY291bnQsIGNvbXBsZXhpdHlfbWV0cmljLmF2Z19jb21wbGV4aXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0X2xhbmd1YWdlX2Zvcl9maWxlbmFtZShjb21wbGV4aXR5X21ldHJpYy5maWxlbmFtZSkpKQogICAgZGIuY29tbWl0KCkKICAgIGN1cnNvci5jbG9zZSgpCgoKZGVmIGdldF9lbnRpdHlfYnlfaWQoZGIsIGVudGl0eV9uYW1lLCBpZGVudGlmaWVyKToKICAgICIiIgogICAgR2V0IGEgdmFsdWUgYnkgaWQgaW4gYSBwYXJ0aWN1bGFyIHRhYmxlCiAgICA6cGFyYW0gZGI6CiAgICA6cGFyYW0gZW50aXR5X25hbWU6IG5hbWUgb2YgdGhlIGVudGl0eSAodGFibGUpIHRvIGdldAogICAgOnBhcmFtIGlkZW50aWZpZXI6IGlkZW50aWZpZXIgb2YgdGhlIGVudGl0eSB0byB0YWtlCiAgICA6cmV0dXJuOgogICAgIiIiCgogICAgaWYgbm90IGVudGl0eV9uYW1lOgogICAgICAgIHJldHVybiBOb25lCgogICAgaWYgbm90IGlkZW50aWZpZXI6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQoKICAgICMgTWFrZSBzdXJlIHdlIHNjaGVkdWxlIG9ubHkgYWN0aXZlIHByb2plY3RzCiAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUICogZnJvbSAlcyBXSEVSRSBpZD0lcyIsIChlbnRpdHlfbmFtZSwgaWRlbnRpZmllciwgKSkKICAgIGNvbHVtbnMgPSB0dXBsZShbZFswXSBmb3IgZCBpbiBjdXJzb3IuZGVzY3JpcHRpb25dKQogICAgdiA9IE5vbmUKICAgIGZvciB4IGluIGN1cnNvcjoKICAgICAgICB2ID0gZGljdCh6aXAoY29sdW1ucywgeCkpCiAgICBjdXJzb3IuY2xvc2UoKQogICAgcmV0dXJuIHYKCgpkZWYgZ2V0X2dyb3VwX2Zvcl9wcm9qZWN0KGRiLCBwcm9qZWN0X2lkKToKICAgICIiIgogICAgR2V0IHRoZSBncm91cCBmb3IgYSBwcm9qZWN0CiAgICA6cGFyYW0gZGI6CiAgICA6cGFyYW0gcHJvamVjdF9pZDogcHJvamVjdF9pZCB0byB1c2UKICAgIDpyZXR1cm46CiAgICAiIiIKICAgIGlmIG5vdCBwcm9qZWN0X2lkOgogICAgICAgIHJldHVybiBOb25lCgogICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKCiAgICAjIE1ha2Ugc3VyZSB3ZSBzY2hlZHVsZSBvbmx5IGFjdGl2ZSBwcm9qZWN0cwogICAgY3Vyc29yLmV4ZWN1dGUoInNlbGVjdCBnLmlkLCBnLm5hbWUsIGcuZ3JvdXBfdHlwZSwgZy5zdGF0ZSwgZy5sZXZlbCwgZy5vd25lcl9pZCwgZy5leHRlcm5hbF9pZGVudGlmaWVyLCBnLmV4dGVybmFsX25hbWUsIGcuZ2l0aHViX2luc3RhbGxhdGlvbl9pZCBmcm9tIHByb2plY3RzIHAgLCBgZ3JvdXBzYCBnIHdoZXJlIHAuZ3JvdXBfaWQ9Zy5pZCBhbmQgcC5pZD0lcyIsIChwcm9qZWN0X2lkLCApKQogICAgY29sdW1ucyA9IHR1cGxlKFtkWzBdIGZvciBkIGluIGN1cnNvci5kZXNjcmlwdGlvbl0pCiAgICB2ID0gTm9uZQogICAgZm9yIHggaW4gY3Vyc29yOgogICAgICAgIHYgPSBkaWN0KHppcChjb2x1bW5zLCB4KSkKICAgIGN1cnNvci5jbG9zZSgpCiAgICByZXR1cm4gdgoKCmRlZiBnZXRfdXNlcl9mb3JfcHJvamVjdChkYiwgcHJvamVjdF9pZCk6CiAgICAiIiIKICAgIEdldCB0aGUgdXNlciBmb3IgYSBwcm9qZWN0CiAgICA6cGFyYW0gZGI6CiAgICA6cGFyYW0gcHJvamVjdF9pZDogcHJvamVjdF9pZCB0byB1c2UKICAgIDpyZXR1cm46CiAgICAiIiIKICAgIGlmIG5vdCBwcm9qZWN0X2lkOgogICAgICAgIHJldHVybiBOb25lCgogICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKCiAgICAjIE1ha2Ugc3VyZSB3ZSBzY2hlZHVsZSBvbmx5IGFjdGl2ZSBwcm9qZWN0cwogICAgY3Vyc29yLmV4ZWN1dGUoInNlbGVjdCB1LmlkLCB1LmVtYWlsLCB1LmFjY291bnRfdHlwZSwgdS5lbWFpbCwgdS5sZXZlbCwgdS5pZGVudGlmaWVyLCB1LmdpdGh1Yl9pbnN0YWxsYXRpb25faWQgZnJvbSBwcm9qZWN0cyBwLCB1c2VycyB1IHdoZXJlIHAub3duZXJfaWQ9dS5pZCBhbmQgcC5pZD0lcyIsIChwcm9qZWN0X2lkLCApKQogICAgY29sdW1ucyA9IHR1cGxlKFtkWzBdIGZvciBkIGluIGN1cnNvci5kZXNjcmlwdGlvbl0pCiAgICB2ID0gTm9uZQogICAgZm9yIHggaW4gY3Vyc29yOgogICAgICAgIHYgPSBkaWN0KHppcChjb2x1bW5zLCB4KSkKICAgIGN1cnNvci5jbG9zZSgpCiAgICByZXR1cm4gdgoKCmRlZiBnZXRfZ3JvdXBzX2Zvcl91c2VyKGRiLCB1c2VyX2lkKToKICAgICIiIgogICAgR2V0IHRoZSBncm91cHMgZm9yIGEgc3BlY2lmaWMgdXNlciBpZGVudGlmaWVyCiAgICA6cGFyYW0gZGI6IHRoZSBkYXRhYmFzZSBjb25uZWN0aW9uCiAgICA6cGFyYW0gdXNlcl9pZDogdGhlIGlkZW50aWZpZXIgb2YgdGhlIHVzZXIuCiAgICA6cmV0dXJuOgogICAgIiIiCiAgICByZXN1bHQgPSBbXQoKICAgIGlmIG5vdCB1c2VyX2lkOgogICAgICAgIHJldHVybiByZXN1bHQKCiAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQogICAgc3RtdCA9ICJzZWxlY3QgZy5pZCwgZy5uYW1lLCBnLmdyb3VwX3R5cGUsIGcuc3RhdGUsIGcubGV2ZWwsIGcub3duZXJfaWQsIGcuZXh0ZXJuYWxfaWRlbnRpZmllciwgZy5leHRlcm5hbF9uYW1lICBmcm9tIGBncm91cHNgIGcsIGdyb3VwX21lbWJlcnNoaXBzIG0gd2hlcmUgbS5ncm91cF9pZD1nLmlkIGFuZCBtLnVzZXJfaWQ9JXMiCiAgICBjdXJzb3IuZXhlY3V0ZShzdG10LCAodXNlcl9pZCwgKSkKICAgIGNvbHVtbnMgPSB0dXBsZShbZFswXSBmb3IgZCBpbiBjdXJzb3IuZGVzY3JpcHRpb25dKQogICAgZm9yIHggaW4gY3Vyc29yOgogICAgICAgIHYgPSBkaWN0KHppcChjb2x1bW5zLCB4KSkKICAgICAgICByZXN1bHQuYXBwZW5kKHYpCiAgICBjdXJzb3IuY2xvc2UoKQogICAgcmV0dXJuIHJlc3VsdAoKCmRlZiBnZXRfY29uZmlndXJhdGlvbihkYik6CiAgICAiIiIKICAgIEdldCB0aGUgY29uZmlndXJhdGlvbiBvZiB0aGUgc3lzdGVtCiAgICA6cGFyYW0gZGI6IHRoZSBteXNxbCBjb25uZWN0b3IKICAgIDpyZXR1cm46IGEgZGljdGlvbmFyeSB3aXRoIHRoZSBjb25maWd1cmF0aW9uCiAgICAiIiIKICAgIHJlc3VsdCA9IHt9CiAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQoKICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1QgY29uZmlndXJhdGlvbl9rZXksIHZhbHVlX3N0cmluZywgdmFsdWVfaW50IGZyb20gY29uZmlndXJhdGlvbiIpCiAgICBmb3IgeCBpbiBjdXJzb3IuZmV0Y2hhbGwoKToKICAgICAgICByZXN1bHRbeFswXV0gPSB4WzFdCiAgICBjdXJzb3IuY2xvc2UoKQogICAgcmV0dXJuIHJlc3VsdAoKCmRlZiBnZXRfY2hlY2tfc3VpdGVfb2JqZWN0X2Zyb21fZGljdCh2KToKICAgIG8gPSBHaXRodWJDaGVja1N1aXRlKAogICAgICAgIHZbJ2lkJ10sCiAgICAgICAgdlsnc3RhdHVzJ10sCiAgICAgICAgdlsnY2hlY2tfc3VpdGVfaWQnXSwKICAgICAgICB2WydyZXBvX3VybCddLAogICAgICAgIHZbJ2hlYWRfc2hhJ10sCiAgICAgICAgdlsnaGVhZF9icmFuY2gnXSwKICAgICAgICB2WydyZWZlcmVuY2VfYmVmb3JlJ10sCiAgICAgICAgdlsncmVmZXJlbmNlX2FmdGVyJ10sCiAgICAgICAgdlsnaW5zdGFsbGF0aW9uX2lkJ10sCiAgICAgICAgdlsncHJvamVjdF9pZCddLAogICAgICAgIHZbJ2NvbXBhcmVfYW5hbHlzaXNfaWQnXSwKICAgICAgICB2WydjaGVja19ydW5faWQnXSkKICAgIHJldHVybiBvCgoKZGVmIGdldF9naXRodWJfY2hlY2tfc3VpdGUoZGIsIHN0YXR1cyk6CiAgICAiIiIKICAgIFJldHVybiBjaGVja19zdWl0ZSBkYXRhIHdpdGggYSBwYXJ0aWN1bGFyIHN0YXR1cy4KICAgIDpwYXJhbSBkYjoKICAgIDpwYXJhbSBzdGF0dXM6IHN0YXR1cyBvZiB0aGUgcHVsbCByZXF1ZXN0CiAgICA6cmV0dXJuOgogICAgIiIiCiAgICByZXN1bHQgPSBbXQogICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKCiAgICAjIE1ha2Ugc3VyZSB3ZSBzY2hlZHVsZSBvbmx5IGFjdGl2ZSBwcm9qZWN0cwogICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCAqIGZyb20gZ2l0aHViX2NoZWNrX3N1aXRlIFdIRVJFIHN0YXR1cz0lczsiLCAoc3RhdHVzLCApKQogICAgY29sdW1ucyA9IHR1cGxlKFtkWzBdIGZvciBkIGluIGN1cnNvci5kZXNjcmlwdGlvbl0pCiAgICBmb3IgeCBpbiBjdXJzb3I6CiAgICAgICAgdiA9IGRpY3QoemlwKGNvbHVtbnMsIHgpKQogICAgICAgIG8gPSBnZXRfY2hlY2tfc3VpdGVfb2JqZWN0X2Zyb21fZGljdCh2KQogICAgICAgIHJlc3VsdC5hcHBlbmQobykKICAgIGN1cnNvci5jbG9zZSgpCiAgICByZXR1cm4gcmVzdWx0CgoKZGVmIGdldF9naXRodWJfY2hlY2tfc3VpdGVfdGltZW91dChkYiwgbWludXRlcyk6CiAgICAiIiIKICAgIEdldCB0aGUgZ2l0aHViIGNoZWNrIHN1aXRlIHRoYXQgdGltZXNvdXQKICAgIDpwYXJhbSBkYjogYSBNeVNRTCBvYmplY3QgY29ubmVjdG9yCiAgICA6cGFyYW0gbWludXRlczogbnVtYmVyIG9mIG1pbnV0ZXMgYmVmb3JlIHdlIGRlY2xhcmUgYW4gJ2luIHByb2dyZXNzJyBwcm9qZWN0IHJlYWR5IHRvIGJlIHJlbW92ZWQKICAgIDpyZXR1cm46IHRoZSBsaXN0IG9mIGFuYWx5c2lzX2lkIHRoYXQgbmVlZHMgdG8gYmUgY29uc2lkZXJlZCBhcyB0aW1lZG91dAogICAgIiIiCiAgICByZXN1bHQgPSBbXQogICAgdGltZW91dF90aW1lID0gdGltZS50aW1lKCkgLSBtaW51dGVzICogU0VDT05EU19JTl9PTkVfTUlOVVRFICAjIGxvb2sgYmFjayB0byBnZXQgdGhlIHRpbWVvdXQgdGltZQogICAgdGltZW91dF90aW1lc3RhbXAgPSBkYXRldGltZS5kYXRldGltZS5mcm9tdGltZXN0YW1wKHRpbWVvdXRfdGltZSkuc3RyZnRpbWUoJyVZLSVtLSVkICVIOiVNOiVTJykKICAgIGN1cnNvciA9IGRiLmN1cnNvcigpCiAgICBzdG10ID0gInNlbGVjdCAqIGZyb20gZ2l0aHViX2NoZWNrX3N1aXRlIHdoZXJlIHN0YXR1cz0nSU5fUFJPR1JFU1MnIEFORCBjcmVhdGlvbl90aW1lc3RhbXA8J3swfSciLmZvcm1hdCh0aW1lb3V0X3RpbWVzdGFtcCkKICAgIGN1cnNvci5leGVjdXRlKHN0bXQpCiAgICBjb2x1bW5zID0gdHVwbGUoW2RbMF0gZm9yIGQgaW4gY3Vyc29yLmRlc2NyaXB0aW9uXSkKICAgIGZvciB4IGluIGN1cnNvcjoKICAgICAgICB2ID0gZGljdCh6aXAoY29sdW1ucywgeCkpCiAgICAgICAgcmVzdWx0LmFwcGVuZChnZXRfY2hlY2tfc3VpdGVfb2JqZWN0X2Zyb21fZGljdCh2KSkKICAgIGN1cnNvci5jbG9zZSgpCiAgICByZXR1cm4gcmVzdWx0CgoKZGVmIHVwZGF0ZV9naXRodWJfY2hlY2tfc3VpdGUoZGIsIGNoZWNrX3N1aXRlKToKICAgICIiIgogICAgVXBkYWdlIGEgR2l0aHViQ2hlY2tTdWl0ZSBtb2RlbCBpbiB0aGUgZGF0YWJhc2UuIE9ubHkgdGhlIHN0YXRlIGFuZCB0aGUgY29tcGFyZV9hbmFseXNpc19pZAogICAgY2FuIGNoYW5nZSBzbyB0aGF0IHdlIGp1c3QgY2hhbmdlIHRoZXNlIHZhbHVlcy4gTm90aGluZyBtb3JlLgogICAgOnBhcmFtIGRiOgogICAgOnBhcmFtIGNoZWNrX3N1aXRlOgogICAgOnJldHVybjoKICAgICIiIgogICAgc3RtdCA9ICJVUERBVEUgZ2l0aHViX2NoZWNrX3N1aXRlIFNFVCBzdGF0dXM9JXMsIGNvbXBhcmVfYW5hbHlzaXNfaWQ9JXMsIGNoZWNrX3J1bl9pZD0lcyB3aGVyZSBpZD0lcyIKICAgIGN1cnNvciA9IGRiLmN1cnNvcigpCiAgICBjdXJzb3IuZXhlY3V0ZShzdG10LCAoY2hlY2tfc3VpdGUuc3RhdHVzLCBjaGVja19zdWl0ZS5jb21wYXJlX2FuYWx5c2lzX2lkLCBjaGVja19zdWl0ZS5jaGVja19ydW5faWQsIGNoZWNrX3N1aXRlLmlkKSkKICAgIGN1cnNvci5jbG9zZSgpCiAgICBkYi5jb21taXQoKQoKCmRlZiBjcmVhdGVfZ2l0aHViX2NoZWNrX3N1aXRlKGRiLCBjaGVja19zdWl0ZSk6CiAgICAiIiIKICAgIFVwZGFnZSBhIEdpdGh1YkNoZWNrU3VpdGUgbW9kZWwgaW4gdGhlIGRhdGFiYXNlLiBPbmx5IHRoZSBzdGF0ZSBhbmQgdGhlIGNvbXBhcmVfYW5hbHlzaXNfaWQKICAgIGNhbiBjaGFuZ2Ugc28gdGhhdCB3ZSBqdXN0IGNoYW5nZSB0aGVzZSB2YWx1ZXMuIE5vdGhpbmcgbW9yZS4KICAgIDpwYXJhbSBkYjoKICAgIDpwYXJhbSBjaGVja19zdWl0ZToKICAgIDpyZXR1cm46CiAgICAiIiIKICAgIHN0bXQgPSAiSU5TRVJUIElOVE8gZ2l0aHViX2NoZWNrX3N1aXRlKGlkLCBzdGF0dXMsIGNoZWNrX3N1aXRlX2lkLCByZXBvX3VybCwgaGVhZF9zaGEsIGhlYWRfYnJhbmNoLCByZWZlcmVuY2VfYmVmb3JlLCByZWZlcmVuY2VfYWZ0ZXIsIGluc3RhbGxhdGlvbl9pZCwgY3JlYXRpb25fdGltZXN0YW1wLCBwcm9qZWN0X2lkLCBjb21wYXJlX2FuYWx5c2lzX2lkLCBjaGVja19ydW5faWQpIiBcCiAgICAgICAgICAgIlZBTFVFUyAoMCwgJXMsICVzLCAlcywgJXMsICVzLCAlcywgJXMsICVzLCBOT1coKSwgJXMsICVzLCAlcykiCiAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQogICAgY3Vyc29yLmV4ZWN1dGUoc3RtdCwgKGNoZWNrX3N1aXRlLnN0YXR1cywgY2hlY2tfc3VpdGUuY2hlY2tfc3VpdGVfaWQsIGNoZWNrX3N1aXRlLnJlcG9fdXJsLCBjaGVja19zdWl0ZS5oZWFkX3NoYSwgY2hlY2tfc3VpdGUuaGVhZF9icmFuY2gsIGNoZWNrX3N1aXRlLmJlZm9yZSwgY2hlY2tfc3VpdGUuYWZ0ZXIsIGNoZWNrX3N1aXRlLmluc3RhbGxhdGlvbl9pZCwgY2hlY2tfc3VpdGUucHJvamVjdF9pZCwgY2hlY2tfc3VpdGUuY29tcGFyZV9hbmFseXNpc19pZCwgY2hlY2tfc3VpdGUuY2hlY2tfcnVuX2lkKSkKICAgIGN1cnNvci5jbG9zZSgpCiAgICBkYi5jb21taXQoKQoKCmRlZiBnZXRfZHVwbGljYXRlX29jY3VycmVuY2VzKGRiLCBkdXBsaWNhdGVfaWQpOgogICAgIiIiCiAgICBHZXQgYWxsIG9jY3VycmVuY2VzIGZvciBhIGR1cGxpY2F0ZSB2YWx1ZQogICAgOnBhcmFtIGRiOiB0aGUgY29ubmVjdGlvbiB0byB0aGUgZGF0YWJhc2UKICAgIDpwYXJhbSBkdXBsaWNhdGVfaWQ6IHRoZSBpZGVudGlmaWVyIG9mIHRoZSBkdXBsaWNhdGUKICAgIDpyZXR1cm46IHRoZSBsaXN0IG9mIGFsbCBkdXBsaWNhdGVzCiAgICAiIiIKICAgIHJlc3VsdCA9IFtdCiAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQoKICAgICMgTWFrZSBzdXJlIHdlIHNjaGVkdWxlIG9ubHkgYWN0aXZlIHByb2plY3RzCiAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUIGR1cGxpY2F0ZV9pZCwgZmlsZW5hbWUsIGxpbmVfc3RhcnQgRlJPTSBhbmFseXNpc19yZXN1bHRzX2R1cGxpY2F0ZXNfdmFsdWVzIFdIRVJFIGR1cGxpY2F0ZV9pZD0lczsiLCAoZHVwbGljYXRlX2lkLCApKQogICAgZm9yIHggaW4gY3Vyc29yOgogICAgICAgIGQgPSBEdXBsaWNhdGlvbk9jY3VycmVuY2UoeFsxXSwgeFsyXSkKICAgICAgICByZXN1bHQuYXBwZW5kKGQpCiAgICBjdXJzb3IuY2xvc2UoKQogICAgcmV0dXJuIHJlc3VsdAoKCmRlZiBnZXRfZHVwbGljYXRlcyhkYiwgYW5hbHlzaXNfaWQsIHByb2plY3RfaWQ9Tm9uZSk6CiAgICAiIiIKICAgIEdldCBhbGwgdGhlIGR1cGxpY2F0ZXMgZm9yIGEgcGFydGljdWxhciBhbmFseXNpcy4KCiAgICA6cGFyYW0gZGI6IHRoZSBkYXRhYmFzZSBsaW5rIHRvIHVzZSB0byBjb25uZWN0CiAgICA6cGFyYW0gYW5hbHlzaXNfaWQ6IHRoZSBhbmFseXNpcyBpZGVudGlmaWVyCiAgICA6cGFyYW0gcHJvamVjdF9pZDogcHJvamVjdCBpZCBvZiB0aGUgYW5hbHlzaXMuIElmIG5vdCBOb25lLCB1c2VkIHRvIGZpbHRlciBkdXBsaWNhdGVzLiBOb3QgdXNlZCBub3cuCiAgICA6cmV0dXJuOiBsaXN0IG9mIER1cGxpY2F0aW9uIG9iamVjdCBpbiBtb2RlbC5wdQogICAgIiIiCiAgICBkdXBsaWNhdGVzID0gW10KICAgIGR1cGxpY2F0ZXNfdG1wID0gW10KICAgIGN1cnNvciA9IGRiLmN1cnNvcigpCgogICAgIyBNYWtlIHN1cmUgd2Ugc2NoZWR1bGUgb25seSBhY3RpdmUgcHJvamVjdHMKICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1QgaWQsIGFuYWx5c2lzX2lkLCBsaW5lX2NvdW50LCB0b2tlbl9jb3VudCwgY29kZV9zYW1wbGUgRlJPTSBhbmFseXNpc19yZXN1bHRzX2R1cGxpY2F0ZXMgV0hFUkUgYW5hbHlzaXNfaWQ9JXM7IiwgKGFuYWx5c2lzX2lkLCApKQogICAgZm9yIHggaW4gY3Vyc29yOgogICAgICAgIGR1cGxpY2F0ZSA9IHt9CiAgICAgICAgZHVwbGljYXRlWydpZCddID0geFswXQogICAgICAgIGR1cGxpY2F0ZVsnYW5hbHlzaXNfaWQnXSA9IHhbMV0KICAgICAgICBkdXBsaWNhdGVbJ2xpbmVfY291bnQnXSA9IHhbMl0KICAgICAgICBkdXBsaWNhdGVbJ3Rva2VuX2NvdW50J10gPSB4WzNdCiAgICAgICAgZHVwbGljYXRlWydjb2RlX3NhbXBsZSddID0geFs0XQogICAgICAgIGR1cGxpY2F0ZXNfdG1wLmFwcGVuZChkdXBsaWNhdGUpCiAgICBjdXJzb3IuY2xvc2UoKQoKICAgIGZvciB4IGluIGR1cGxpY2F0ZXNfdG1wOgogICAgICAgIGR1cGxpY2F0ZV9pZCA9IHhbJ2lkJ10KICAgICAgICBvY2N1cnJlbmNlcyA9IGdldF9kdXBsaWNhdGVfb2NjdXJyZW5jZXMoZGIsIGR1cGxpY2F0ZV9pZCkKICAgICAgICBkID0gRHVwbGljYXRpb24oeFsnbGluZV9jb3VudCddLCB4Wyd0b2tlbl9jb3VudCddLCB4Wydjb2RlX3NhbXBsZSddKQogICAgICAgIGZvciBvIGluIG9jY3VycmVuY2VzOgogICAgICAgICAgICBkLmFkZF9vY2N1cnJlbmNlKG8pCiAgICAgICAgZHVwbGljYXRlcy5hcHBlbmQoZCkKCiAgICByZXR1cm4gZHVwbGljYXRlcwoKCmRlZiBnZXRfbnVtYmVyX29mX2FuYWx5c2lzX2luX3RoZV9sYXN0X2RheV9mb3JfdXNlcihkYiwgdXNlcl9pZCk6CiAgICAiIiIKICAgIEdldCB0aGUgbnVtYmVyIG9mIGFuYWx5c2VzIGRvbmUgZm9yIGEgdXNlciB3aXRoaW4gYSBkYXkKICAgIDpwYXJhbSBkYjogdGhlIGNvbm5lY3Rpb24gdG8gdGhlIGRhdGFiYXNlCiAgICA6cGFyYW0gdXNlcl9pZDogdGhlIGlkZW50aWZpZXIgb2YgdGhlIHVzZXIKICAgIDpyZXR1cm46IHRoZSBudW1iZXIgb2YgYW5hbHlzaXMKICAgICIiIgogICAgaWYgbm90IHVzZXJfaWQ6CiAgICAgICAgcmV0dXJuIDAKICAgIGN1cnNvciA9IGRiLmN1cnNvcigpCgogICAgIyBNYWtlIHN1cmUgd2Ugc2NoZWR1bGUgb25seSBhY3RpdmUgcHJvamVjdHMKICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1QgY291bnQoKikgRlJPTSBhbmFseXNpc19yZXN1bHRzIFdIRVJFIHN0YXJ0X3RzID49IG5vdygpIC0gSU5URVJWQUwgMSBEQVkgYW5kIHN0YXR1cyE9J0NBTkNFTExFRF9TQU1FX1JFVicgYW5kIHByb2plY3RfaWQgaW4gKHNlbGVjdCBpZCBmcm9tIHByb2plY3RzIHdoZXJlIG93bmVyX2lkPSVzKSIsICh1c2VyX2lkLCApKQogICAgcmVzdWx0ID0gY3Vyc29yLmZldGNob25lKCkKICAgIGN1cnNvci5jbG9zZSgpCgogICAgaWYgbm90IHJlc3VsdDoKICAgICAgICByZXR1cm4gMAogICAgcmV0dXJuIHJlc3VsdFswXQoKCmRlZiBnZXRfbnVtYmVyX29mX2FuYWx5c2lzX2luX3RoZV9sYXN0X2RheV9mb3JfZ3JvdXAoZGIsIGdyb3VwX2lkKToKICAgICIiIgogICAgR2V0IHRoZSBudW1iZXIgb2YgYW5hbHlzZXMgZG9uZSBmb3IgYSBncm91cCB3aXRoaW4gYSBkYXkKICAgIDpwYXJhbSBkYjogdGhlIGNvbm5lY3Rpb24gdG8gdGhlIGRhdGFiYXNlCiAgICA6cGFyYW0gZ3JvdXBfaWQ6IHRoZSBpZGVudGlmaWVyIG9mIHRoZSBncm91cAogICAgOnJldHVybjogdGhlIG51bWJlciBvZiBhbmFseXNpcwogICAgIiIiCiAgICBpZiBub3QgZ3JvdXBfaWQ6CiAgICAgICAgcmV0dXJuIDAKCiAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQoKICAgICMgTWFrZSBzdXJlIHdlIHNjaGVkdWxlIG9ubHkgYWN0aXZlIHByb2plY3RzCiAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUIGNvdW50KCopIEZST00gYW5hbHlzaXNfcmVzdWx0cyBXSEVSRSBzdGFydF90cyA+PSBub3coKSAtIElOVEVSVkFMIDEgREFZIGFuZCBzdGF0dXMhPSdDQU5DRUxMRURfU0FNRV9SRVYnIGFuZCBwcm9qZWN0X2lkIGluIChzZWxlY3QgaWQgZnJvbSBwcm9qZWN0cyB3aGVyZSBncm91cF9pZD0lcykiLCAoZ3JvdXBfaWQsICkpCiAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgY3Vyc29yLmNsb3NlKCkKCiAgICBpZiBub3QgcmVzdWx0OgogICAgICAgIHJldHVybiAwCiAgICByZXR1cm4gcmVzdWx0WzBdCgoKZGVmIHByaW50X2FuYWx5c2lzKGFuYWx5c2lzKToKICAgIHByaW50KCJBbmFseXNpcyIpCiAgICBmb3IgZmllbGQgaW4gWydpZCcsICdraW5kJywgJ3N0YXR1cycsICd0YWdzJywgJ3JlcG9fa2luZCcsICdyZXBvX3VzZXJuYW1lJywgJ3JlcG9fcGFzc3dvcmQnLCAncHJvamVjdF9pZCcsICd1c2VyX2lkJ106CiAgICAgICAgcHJpbnQoIkZpZWxkIHswfSB7MX0iLmZvcm1hdChmaWVsZCwgYW5hbHlzaXMuZ2V0KGZpZWxkLCAndW5rbm93bicpKSkKCgpkZWYgZ2V0X2JpdGJ1Y2tldF9jcmVkZW50aWFsc19mb3JfdXNlcihkYiwgdXNlcl9pZCk6CiAgICAiIiIKICAgIEdldCBhbGwgYml0YnVja2V0IGluZm9ybWF0aW9uIGZvciBhIHBhcnRpY3VsYXIgdXNlciBpZAogICAgOnBhcmFtIGRiOiB0aGUgbXlzcWwgY29ubmVjdG9yCiAgICA6cGFyYW0gdXNlcl9pZDogdGhlIHVzZXJfaWQKICAgIDpyZXR1cm46IHRoZSBkaWN0aW9uYXJ5IHdpdGggZXZlcnl0aGluZyB3ZSB3YW50L25lZWQKICAgICIiIgogICAgaWYgbm90IHVzZXJfaWQ6CiAgICAgICAgcmV0dXJuIE5vbmUKICAgIGN1cnNvciA9IGRiLmN1cnNvcigpCiAgICBjdXJzb3IuZXhlY3V0ZSgic2VsZWN0IHUuaWQgYXMgdXNlcl9pZCwgYnUuaWQgYXMgYml0YnVja2V0X3VzZXIsIGJpLmJhc2VfdXJsLCBiaS5iYXNlX2FwaV91cmwsIGJ1LnVzZXJuYW1lLCBidS51dWlkLCBidS5zaGFyZWRfc2VjcmV0LCBidS5jbGllbnRfa2V5LCBidS51c2VyX2tleSAgZnJvbSB1c2VycyB1LCBiaXRidWNrZXRfdXNlcnMgYnUsIGJpdGJ1Y2tldF9pbnN0YWxsYXRpb25zIGJpIFdIRVJFIGJ1LmJpdGJ1Y2tldF9pbnN0YWxsYXRpb249YmkuaWQgQU5EIGJ1LmlkPXUuYml0YnVja2V0X3VzZXIgQU5EIHUuaWQ9JXMiLCAodXNlcl9pZCwgKSkKICAgIGNvbHVtbnMgPSB0dXBsZShbZFswXSBmb3IgZCBpbiBjdXJzb3IuZGVzY3JpcHRpb25dKQogICAgciA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICBpZiByOgogICAgICAgIHJlcyA9IGRpY3QoemlwKGNvbHVtbnMsciApKQogICAgZWxzZToKICAgICAgICByZXMgPSBOb25lCiAgICBjdXJzb3IuY2xvc2UoKQogICAgcmV0dXJuIHJlcwoKCmRlZiBnZXRfYml0YnVja2V0X2NyZWRlbnRpYWxzX2Zvcl9ncm91cChkYiwgZ3JvdXBfaWQpOgogICAgIiIiCiAgICBHZXQgYWxsIGJpdGJ1Y2tldCBpbmZvcm1hdGlvbiBmb3IgYSBwYXJ0aWN1bGFyIHVzZXIgaWQKICAgIDpwYXJhbSBkYjogdGhlIG15c3FsIGNvbm5lY3RvcgogICAgOnBhcmFtIGdyb3VwX2lkOiB0aGUgaWRlbnRpZmllciBvZiB0aGUgcmVsYXRlZCBncm91cAogICAgOnJldHVybjogdGhlIGRpY3Rpb25hcnkgd2l0aCBldmVyeXRoaW5nIHdlIHdhbnQvbmVlZAogICAgIiIiCiAgICBpZiBub3QgZ3JvdXBfaWQ6CiAgICAgICAgcmV0dXJuIE5vbmUKICAgIGN1cnNvciA9IGRiLmN1cnNvcigpCiAgICBjdXJzb3IuZXhlY3V0ZSgic2VsZWN0IGcuaWQgYXMgZ3JvdXBfaWQsIGJ1LmlkIGFzIGJpdGJ1Y2tldF91c2VyLCBiaS5iYXNlX3VybCwgYmkuYmFzZV9hcGlfdXJsLCBidS51c2VybmFtZSwgYnUudXVpZCwgYnUuc2hhcmVkX3NlY3JldCwgYnUuY2xpZW50X2tleSwgYnUudXNlcl9rZXkgIGZyb20gYGdyb3Vwc2AgZywgYml0YnVja2V0X3VzZXJzIGJ1LCBiaXRidWNrZXRfaW5zdGFsbGF0aW9ucyBiaSBXSEVSRSBidS5iaXRidWNrZXRfaW5zdGFsbGF0aW9uPWJpLmlkIEFORCBidS5pZD1nLmJpdGJ1Y2tldF91c2VyIEFORCBnLmlkPSVzIiwgKGdyb3VwX2lkLCApKQogICAgY29sdW1ucyA9IHR1cGxlKFtkWzBdIGZvciBkIGluIGN1cnNvci5kZXNjcmlwdGlvbl0pCiAgICByID0gY3Vyc29yLmZldGNob25lKCkKICAgIGlmIHI6CiAgICAgICAgcmVzID0gZGljdCh6aXAoY29sdW1ucyxyICkpCiAgICBlbHNlOgogICAgICAgIHJlcyA9IE5vbmUKICAgIGN1cnNvci5jbG9zZSgpCiAgICByZXR1cm4gcmVzCgoKZGVmIGdldF9iaXRidWNrZXRfdG9rZW5fY2FjaGUoZGIsIGJpdGJ1Y2tldF91c2VyX2lkKToKICAgICIiIgogICAgR2V0IHRoZSB0b2tlbiBmb3IgYSB1c2VyCiAgICA6cGFyYW0gZGI6CiAgICA6cGFyYW0gYml0YnVja2V0X3VzZXJfaWQ6CiAgICA6cmV0dXJuOgogICAgIiIiCiAgICBpZiBub3QgYml0YnVja2V0X3VzZXJfaWQ6CiAgICAgICAgcmV0dXJuIE5vbmUKICAgIGxvZ2dpbmcuZGVidWcoImdldF9iaXRidWNrZXRfdG9rZW5fY2FjaGUgZm9yIHVzZXIgezB9Ii5mb3JtYXQoYml0YnVja2V0X3VzZXJfaWQpKQogICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKICAgIGN1cnNvci5leGVjdXRlKCJzZWxlY3QgKiBmcm9tIGJpdGJ1Y2tldF90b2tlbnNfY2FjaGUgd2hlcmUgY3JlYXRpb25fdGltZXN0YW1wID4gREFURV9TVUIoTk9XKCksIElOVEVSVkFMIDIgSE9VUikgQU5EIGlkPSVzIiwgKGJpdGJ1Y2tldF91c2VyX2lkLCApKQogICAgY29sdW1ucyA9IHR1cGxlKFtkWzBdIGZvciBkIGluIGN1cnNvci5kZXNjcmlwdGlvbl0pCiAgICByID0gY3Vyc29yLmZldGNob25lKCkKICAgIGlmIHI6CiAgICAgICAgcm93ID0gZGljdCh6aXAoY29sdW1ucyxyICkpCiAgICAgICAgcmVzID0gcm93Wyd0b2tlbiddCiAgICAgICAgbG9nZ2luZy5kZWJ1ZygiW2dldF9iaXRidWNrZXRfdG9rZW5fY2FjaGVdIGZvdW5kIHNvbWV0aGluZyBpbiB0aGUgY2FjaGUgZm9yIHVzZXIgaWQgezB9OiB7MX0iLmZvcm1hdChiaXRidWNrZXRfdXNlcl9pZCwgcmVzKSkKICAgIGVsc2U6CiAgICAgICAgbG9nZ2luZy5kZWJ1ZygiW2dldF9iaXRidWNrZXRfdG9rZW5fY2FjaGVdIG5vdGhpbmcgaW4gdGhlIGNhY2hlIGZvciB1c2VyIGlkIHswfSIuZm9ybWF0KGJpdGJ1Y2tldF91c2VyX2lkKSkKICAgICAgICByZXMgPSBOb25lCiAgICBjdXJzb3IuY2xvc2UoKQogICAgcmV0dXJuIHJlcwoKCmRlZiB1cGRhdGVfYml0YnVja2V0X3Rva2VuX2NhY2hlKGRiLCBiaXRidWNrZXRfdXNlcl9pZCwgdG9rZW4pOgogICAgIiIiCiAgICBHZXQgdGhlIHRva2VuIGZvciBhIHVzZXIKICAgIDpwYXJhbSBkYjoKICAgIDpwYXJhbSBiaXRidWNrZXRfdXNlcl9pZDoKICAgIDpyZXR1cm46CiAgICAiIiIKICAgIGlmIG5vdCBiaXRidWNrZXRfdXNlcl9pZDoKICAgICAgICByZXR1cm4gTm9uZQogICAgbG9nZ2luZy5kZWJ1ZygidXBkYXRlX2JpdGJ1Y2tldF90b2tlbl9jYWNoZSBmb3IgdXNlciB7MH0iLmZvcm1hdChiaXRidWNrZXRfdXNlcl9pZCkpCiAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQogICAgY3Vyc29yLmV4ZWN1dGUoInNlbGVjdCAqIGZyb20gYml0YnVja2V0X3Rva2Vuc19jYWNoZSB3aGVyZSAgaWQ9JXMiLCAoYml0YnVja2V0X3VzZXJfaWQsICkpCiAgICBleGlzdHMgPSBGYWxzZQogICAgciA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICBpZiByOgogICAgICAgIGV4aXN0cyA9IFRydWUKICAgIGN1cnNvci5jbG9zZSgpCgogICAgaWYgZXhpc3RzOgogICAgICAgIHN0bXQgPSAiVVBEQVRFIGJpdGJ1Y2tldF90b2tlbnNfY2FjaGUgU0VUIHRva2VuPSVzLCBjcmVhdGlvbl90aW1lc3RhbXA9Tk9XKCkgV0hFUkUgaWQ9JXMiCiAgICAgICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKICAgICAgICBjdXJzb3IuZXhlY3V0ZShzdG10LCAodG9rZW4sIGJpdGJ1Y2tldF91c2VyX2lkKSkKICAgICAgICBjdXJzb3IuY2xvc2UoKQogICAgZWxzZToKICAgICAgICBzdG10ID0gIklOU0VSVCBJTlRPIGJpdGJ1Y2tldF90b2tlbnNfY2FjaGUoaWQsIGNyZWF0aW9uX3RpbWVzdGFtcCwgdG9rZW4pIFZBTFVFUyAoJXMsIE5PVygpLCAlcykiCiAgICAgICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKICAgICAgICBjdXJzb3IuZXhlY3V0ZShzdG10LCAoYml0YnVja2V0X3VzZXJfaWQsIHRva2VuKSkKICAgICAgICBjdXJzb3IuY2xvc2UoKQoKICAgIGRiLmNvbW1pdCgpCgoKZGVmIGdldF9zbGFja19pbnN0YWxsYXRpb25zX2Zvcl9wcm9qZWN0KGRiLCBwcm9qZWN0X2lkKToKICAgICIiIgogICAgUmV0dXJuIHRoZSBsaXN0IG9mIHNsYWNrIGluc3RhbGxhdGlvbnMgZm9yIHByb2plY3RzCgogICAgOnBhcmFtIGRiOgogICAgOnBhcmFtIHByb2plY3RfaWQ6IHByb2plY3QgdG8gZ2V0IHRoZSBzbGFjayBpbnN0YWxsYXRpb24KICAgIDpyZXR1cm46CiAgICAiIiIKICAgIHJlc3VsdCA9IFtdCiAgICBjdXJzb3IgPSBkYi5jdXJzb3IoKQoKICAgICMgTWFrZSBzdXJlIHdlIHNjaGVkdWxlIG9ubHkgYWN0aXZlIHByb2plY3RzCiAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUICogZnJvbSBzbGFja19pbnRlZ3JhdGlvbnMgV0hFUkUgcHJvamVjdF9pZD0lczsiLCAocHJvamVjdF9pZCwgKSkKICAgIGNvbHVtbnMgPSB0dXBsZShbZFswXSBmb3IgZCBpbiBjdXJzb3IuZGVzY3JpcHRpb25dKQogICAgZm9yIHggaW4gY3Vyc29yOgogICAgICAgIHYgPSBkaWN0KHppcChjb2x1bW5zLCB4KSkKICAgICAgICByZXN1bHQuYXBwZW5kKHYpCiAgICBjdXJzb3IuY2xvc2UoKQogICAgcmV0dXJuIHJlc3VsdAo=";
    public static String ANALYSIS_PY = "aW1wb3J0IGxvZ2dpbmcKaW1wb3J0IG9zCmltcG9ydCBoYXNobGliCmltcG9ydCBzdWJwcm9jZXNzCmltcG9ydCB0aW1lCgppbXBvcnQgYmFja2VuZF9saWIuY29uZiBhcyBjb25mCmltcG9ydCBiYWNrZW5kX2xpYi5jb25zdGFudHMgYXMgY29uc3RhbnRzCmltcG9ydCBiYWNrZW5kX2xpYi5kYXRhYmFzZS5hbmFseXNpc19zdGF0cwppbXBvcnQgYmFja2VuZF9saWIuZGF0YWJhc2UucHJvamVjdAppbXBvcnQgYmFja2VuZF9saWIuZGIgYXMgZGF0YWJhc2UKCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMucG1kX2FwZXhfaGVscGVyIGFzIHBtZF9hcGV4X2hlbHBlcgppbXBvcnQgYmFja2VuZF9saWIuYW5hbHl6ZXJzLnBtZF9qYXZhX2hlbHBlciBhcyBwbWRfamF2YV9oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5iYW5kaXRfaGVscGVyIGFzIGJhbmRpdF9oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5jaGVja292X2RvY2tlciBhcyBjaGVja292X2RvY2tlcgppbXBvcnQgYmFja2VuZF9saWIuYW5hbHl6ZXJzLmNoZWNrb3ZfdGVycmFmb3JtIGFzIGNoZWNrb3ZfdGVycmFmb3JtCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMuY3BwY2hlY2tfaGVscGVyIGFzIGNwcGNoZWNrX2hlbHBlcgppbXBvcnQgYmFja2VuZF9saWIuYW5hbHl6ZXJzLmRhcnRfaGVscGVyIGFzIGRhcnRfaGVscGVyCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMuZGV0ZWN0X3NlY3JldHMgYXMgZGV0ZWN0X3NlY3JldHMKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5yZXZpdmVfaGVscGVyIGFzIHJldml2ZV9oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5saXphcmRfaGVscGVyIGFzIGxpemFyZF9oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5qc2NwZF9oZWxwZXIgYXMganNjcGRfaGVscGVyCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMuZ29zZWNfaGVscGVyIGFzIGdvc2VjX2hlbHBlcgppbXBvcnQgYmFja2VuZF9saWIuYW5hbHl6ZXJzLnJvc2llX2hlbHBlciBhcyByb3NpZV9oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5waHBtZF9oZWxwZXIgYXMgcGhwbWRfaGVscGVyCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMucHlsaW50X2hlbHBlciBhcyBweWxpbnRfaGVscGVyCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMucmVla19oZWxwZXIgYXMgcmVla19oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5zY2FsYXN0eWxlX2hlbHBlciBhcyBzY2FsYXN0eWxlX2hlbHBlcgppbXBvcnQgYmFja2VuZF9saWIuYW5hbHl6ZXJzLnNoZWxsY2hlY2tfaGVscGVyIGFzIHNoZWxsY2hlY2tfaGVscGVyCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMueWFtbGxpbnRfaGVscGVyIGFzIHlhbWxsaW50X2hlbHBlcgppbXBvcnQgYmFja2VuZF9saWIuYW5hbHl6ZXJzLnN0YXRpY2NoZWNrX2hlbHBlciBhcyBzdGF0aWNjaGVja19oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLm1ldHJpY3MucmVwb3J0aW5nIGFzIG1ldHJpY3MKaW1wb3J0IGJhY2tlbmRfbGliLm1ldHJpY3MubmFtZXMgYXMgbWV0cmljc19uYW1lcwpmcm9tIGJhY2tlbmRfbGliLmFuYWx5emVycyBpbXBvcnQgZGV0ZWt0X2hlbHBlciwgZGVwZW5kc19oZWxwZXIsIGVzbGludF90eXBlc2NyaXB0X2hlbHBlciwgXAogICAgZXNsaW50X2phdmFzY3JpcHRfaGVscGVyLCBlc2xpbnRfZ2VuZXJpY19oZWxwZXIKZnJvbSBiYWNrZW5kX2xpYi5hbmFseXplcnMuZGVwZW5kZW5jaWVzX2hlbHBlciBpbXBvcnQgcGFyc2VfcnVieV9nZW1maWxlLCBwYXJzZV9weXRob25fcmVxdWlyZW1lbnRzLCBcCiAgICBwYXJzZV9qYXZhc2NyaXB0X3BhY2thZ2VzLCBwYXJzZV9wb20sIHBhcnNlX3BocF9jb21wb3Nlcl9qc29uLCBwYXJzZV9zYnRfYnVpbGRfZmlsZSwgcGFyc2VfZ3JhZGxlX2tvdGxpbiwgXAogICAgcGFyc2VfZ3JhZGxlX2phdmEKZnJvbSBiYWNrZW5kX2xpYi5hbmFseXplcnMuc2xvY2NvdW50IGltcG9ydCBMQU5HVUFHRVNfRVhURU5TSU9OUywgTEFOR1VBR0VTX1RPX0NPTlNUQU5UUwpmcm9tIGJhY2tlbmRfbGliLmNvbmZpZ3VyYXRpb24gaW1wb3J0IGlzX2RlY2lkZXJfZW5hYmxlZApmcm9tIGJhY2tlbmRfbGliLmRhdGFiYXNlLmFuYWx5c2lzX3RpbWUgaW1wb3J0IGFkZF9hbmFseXNpc19zdGVwX3J1bm5pbmdfdGltZQpmcm9tIGJhY2tlbmRfbGliLmRhdGFiYXNlLmFyY2hpdGVjdHVyZSBpbXBvcnQgaW5zZXJ0X2FyY2hpdGVjdHVyZQpmcm9tIGJhY2tlbmRfbGliLmRhdGFiYXNlLmRlcGVuZGVuY3kgaW1wb3J0IGluc2VydF9hbmFseXNpc19kZXBlbmRlbmNpZXMKZnJvbSBiYWNrZW5kX2xpYi5kYXRhYmFzZS5maWxlX2FuYWx5c2lzX3Zpb2xhdGlvbiBpbXBvcnQgY3JlYXRlX2ZpbGVfYW5hbHlzaXNfdmlvbGF0aW9uCmZyb20gYmFja2VuZF9saWIuZGF0YWJhc2UucnVsZXMgaW1wb3J0IGdldF9hbGxfcnVsZXMKZnJvbSBiYWNrZW5kX2xpYi5kZWNpZGVycyBpbXBvcnQgREVDSURFUl9FWEVDVVRPUl9GSUxURVJfUlVMRVNfRlJPTV9EQVRBQkFTRSwgXAogICAgREVDSURFUl9FWEVDVVRPUl9GSUxURVJfUlVMRVNfV0lUSF9UTVBfRlJPTV9EQVRBQkFTRQpmcm9tIGJhY2tlbmRfbGliLmV4Y2VwdGlvbnMgaW1wb3J0IEFuYWx5c2lzVG9vbFRpbWVvdXRFeGNlcHRpb24KZnJvbSBiYWNrZW5kX2xpYi5tb2RlbC5hbmFseXNpc19jb250ZXh0IGltcG9ydCBBbmFseXNpc0NvbnRleHQKZnJvbSBiYWNrZW5kX2xpYi5tb2RlbC5kZXBlbmRlbmN5IGltcG9ydCBEZXBlbmRlbmN5CmZyb20gYmFja2VuZF9saWIubW9kZWwuZmlsZV9hbmFseXNpc192aW9sYXRpb24gaW1wb3J0IEZpbGVBbmFseXNpc1Zpb2xhdGlvbgpmcm9tIGJhY2tlbmRfbGliLm1vZGVsLnJ1bGUgaW1wb3J0IGZpbHRlcl92aW9sYXRpb25zX3dpdGhfcnVsZXMKZnJvbSBiYWNrZW5kX2xpYi5tb2RlbC52aW9sYXRpb24gaW1wb3J0IFZpb2xhdGlvbiwgZmlsdGVyX3Zpb2xhdGlvbnNfc3RhcnRfd2l0aF90bXAKZnJvbSBiYWNrZW5kX2xpYi5waXBlbGluZV9jb25maWd1cmF0aW9uIGltcG9ydCBQaXBlbGluZU1vZGUKZnJvbSBiYWNrZW5kX2xpYi51dGlscy5kZXBlbmRlbmN5LmphdmFzY3JpcHQgaW1wb3J0IHVwZGF0ZV9qYXZhc2NyaXB0X2RlcGVuZGVuY3kKZnJvbSBiYWNrZW5kX2xpYi51dGlscy5kZXBlbmRlbmN5LnBocCBpbXBvcnQgdXBkYXRlX3BocF9kZXBlbmRlbmN5CmZyb20gYmFja2VuZF9saWIudXRpbHMuZGVwZW5kZW5jeS5wb20gaW1wb3J0IHVwZGF0ZV9wb21fZGVwZW5kZW5jeQpmcm9tIGJhY2tlbmRfbGliLnV0aWxzLmRlcGVuZGVuY3kucHl0aG9uIGltcG9ydCB1cGRhdGVfcHl0aG9uX3BhY2thZ2UKZnJvbSBiYWNrZW5kX2xpYi51dGlscy5kZXBlbmRlbmN5LnJ1YnkgaW1wb3J0IHVwZGF0ZV9nZW1zX2RlcGVuZGVuY3kKZnJvbSBiYWNrZW5kX2xpYi51dGlscy5yZXBvc2l0b3J5X3V0aWxzIGltcG9ydCByZWFkX2xpbmVfZnJvbV9yZXBvc2l0b3J5CgoKY2xhc3MgQW5hbHlzaXNUb29sRXhlY3V0aW9uRXhjZXB0aW9uKEV4Y2VwdGlvbik6CiAgICAiIiIKICAgIEV4Y2VwdGlvbiB1c2VkIHdoZW4gdGhlIHRvb2wgZG9lcyBzdWNjZWVkIHRvIGV4ZWN1dGUuCiAgICBUaGlzIGlzIGNhdWdodCBsYXRlciB0byBzdXJmYWNlIHBvdGVudGlhbCBlcnJvcnMuCiAgICAiIiIKICAgIHBhc3MKCgpjbGFzcyBBbmFseXNpc1Rvb2w6CiAgICAiIiIKICAgIERhdGEgc3RydWN0dXJlIHRoYXQgY2FwdHVyZSBhbGwgdGhlIG5lY2Vzc2FyeSBhcnRpZmFjdHMgdG8gZXhlY3V0ZSBhbiBhbmFseXNpcy4KICAgICIiIgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWUsIHRvb2xfbmFtZSwgbGFuZ3VhZ2VzLCBlbmFibGVkX2NvbnN0YW50cywgZXhlY3V0ZV9mdW5jdGlvbiwgcGFyc2VfZnVuY3Rpb24pOgogICAgICAgIHNlbGYubmFtZSA9IG5hbWUKICAgICAgICBzZWxmLnRvb2xfbmFtZSA9IHRvb2xfbmFtZQogICAgICAgIHNlbGYubGFuZ3VhZ2VzID0gbGFuZ3VhZ2VzCiAgICAgICAgc2VsZi5lbmFibGVkX2NvbnN0YW50cyA9IGVuYWJsZWRfY29uc3RhbnRzCiAgICAgICAgc2VsZi5leGVjdXRlX2Z1bmN0aW9uID0gZXhlY3V0ZV9mdW5jdGlvbgogICAgICAgIHNlbGYucGFyc2VfZnVuY3Rpb24gPSBwYXJzZV9mdW5jdGlvbgoKICAgIGRlZiBkZWNpZGVyX2tleV9kaXNhYmxlZChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBSZXR1cm4gYSBrZXkgdG8gZGlzYWJsZSBhIHRvb2wKICAgICAgICA6cmV0dXJuOgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLnRvb2xfbmFtZS5sb3dlcigpICsgIi1kaXNhYmxlZCIKCgpwcm9qZWN0X2FuYWx5c2lzX3Rvb2xzID0gWwogICAgQW5hbHlzaXNUb29sKCJBcGV4IiwgInBtZCIsIFsiYXBleCJdLCBbY29uc3RhbnRzLkVOR0lORV9BUEVYX0VOQUJMRURdLCBwbWRfYXBleF9oZWxwZXIuZXhlY3V0ZV9wbWQsIHBtZF9hcGV4X2hlbHBlci5wYXJzZV9wbWRfb3V0cHV0KSwKICAgIEFuYWx5c2lzVG9vbCgiQmFuZGl0IiwgImJhbmRpdCIsIFsicHl0aG9uIl0sIFtjb25zdGFudHMuRU5HSU5FX1BZVEhPTl9FTkFCTEVEXSwgYmFuZGl0X2hlbHBlci5leGVjdXRlLCBiYW5kaXRfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woIkMvQysrIiwgImNwcGNoZWNrIiwgWyJjIiwgImNwcCJdLCBbY29uc3RhbnRzLkVOR0lORV9DX0VOQUJMRUQsIGNvbnN0YW50cy5FTkdJTkVfQ1BQX0VOQUJMRURdLCBjcHBjaGVja19oZWxwZXIuZXhlY3V0ZSwgY3BwY2hlY2tfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woIkNoZWNrb3YiLCAiY2hlY2tvdi1kb2NrZXIiLCBMQU5HVUFHRVNfRVhURU5TSU9OUy5rZXlzKCksIFtjb25zdGFudHMuRU5HSU5FX0RPQ0tFUl9FTkFCTEVEXSwgY2hlY2tvdl9kb2NrZXIuZXhlY3V0ZSwgY2hlY2tvdl9kb2NrZXIucGFyc2Vfb3V0cHV0KSwKICAgIEFuYWx5c2lzVG9vbCgiQ2hlY2tvdiIsICJjaGVja292LXRlcnJhZm9ybSIsIFsidGVycmFmb3JtIl0sIFtjb25zdGFudHMuRU5HSU5FX1RFUlJBRk9STV9FTkFCTEVEXSwgY2hlY2tvdl90ZXJyYWZvcm0uZXhlY3V0ZSwgY2hlY2tvdl90ZXJyYWZvcm0ucGFyc2Vfb3V0cHV0KSwKICAgIEFuYWx5c2lzVG9vbCgiRGV0ZWt0IiwgImRldGVrdCIsIFsia290bGluIl0sIFtjb25zdGFudHMuRU5HSU5FX0tPVExJTl9FTkFCTEVEXSwgZGV0ZWt0X2hlbHBlci5leGVjdXRlLCBkZXRla3RfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woIkRhcnQiLCAiZGFydGFuYWx5emVyIiwgWyJkYXJ0Il0sIFtjb25zdGFudHMuRU5HSU5FX0RBUlRfRU5BQkxFRF0sIGRhcnRfaGVscGVyLmV4ZWN1dGUsIGRhcnRfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woIkRldGVjdFNlY3JldHMiLCAiZGV0ZWN0LXNlY3JldHMiLCBMQU5HVUFHRVNfRVhURU5TSU9OUy5rZXlzKCksIFtjb25zdGFudHMuRU5HSU5FX0RFVEVDVF9TRUNSRVRTX0VOQUJMRURdLCBkZXRlY3Rfc2VjcmV0cy5leGVjdXRlLCBkZXRlY3Rfc2VjcmV0cy5wYXJzZV9vdXRwdXQpLAogICAgQW5hbHlzaXNUb29sKCJFc2xpbnQiLCAiZXNsaW50LWphdmFzY3JpcHQiLCBbImphdmFzY3JpcHQiXSwgW2NvbnN0YW50cy5FTkdJTkVfSkFWQVNDUklQVF9FTkFCTEVEXSwgZXNsaW50X2phdmFzY3JpcHRfaGVscGVyLmV4ZWN1dGUsIGVzbGludF9nZW5lcmljX2hlbHBlci5wYXJzZV9vdXRwdXQpLAogICAgQW5hbHlzaXNUb29sKCJFc2xpbnQiLCAiZXNsaW50LXR5cGVzY3JpcHQiLCBbInR5cGVzY3JpcHQiXSwgW2NvbnN0YW50cy5FTkdJTkVfVFlQRVNDUklQVF9FTkFCTEVEXSwgZXNsaW50X3R5cGVzY3JpcHRfaGVscGVyLmV4ZWN1dGUsIGVzbGludF9nZW5lcmljX2hlbHBlci5wYXJzZV9vdXRwdXQpLAogICAgQW5hbHlzaXNUb29sKCJKYXZhIiwgInBtZCIsIFsiamF2YSJdLCBbY29uc3RhbnRzLkVOR0lORV9KQVZBX0VOQUJMRURdLCBwbWRfamF2YV9oZWxwZXIuZXhlY3V0ZV9wbWQsIHBtZF9qYXZhX2hlbHBlci5wYXJzZV9wbWRfb3V0cHV0KSwKICAgICMgQW5hbHlzaXNUb29sKCJHbyIsICJnb2xpbnQiLCBbImdvIl0sIFtjb25zdGFudHMuRU5HSU5FX0dPX0VOQUJMRURdLCBnb2xpbnRfaGVscGVyLmV4ZWN1dGUsIGdvbGludF9oZWxwZXIucGFyc2Vfb3V0cHV0KSwKICAgIEFuYWx5c2lzVG9vbCgiR29SZXZpdmUiLCAicmV2aXZlIiwgWyJnbyJdLCBbY29uc3RhbnRzLkVOR0lORV9HT19FTkFCTEVEXSwgcmV2aXZlX2hlbHBlci5leGVjdXRlLCByZXZpdmVfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woIkdvU3RhdGljY2hlY2siLCAic3RhdGljY2hlY2siLCBbImdvIl0sIFtjb25zdGFudHMuRU5HSU5FX0dPX0VOQUJMRURdLCBzdGF0aWNjaGVja19oZWxwZXIuZXhlY3V0ZSwgc3RhdGljY2hlY2tfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woIkdvU2VjIiwgImdvc2VjIiwgWyJnbyJdLCBbY29uc3RhbnRzLkVOR0lORV9HT19FTkFCTEVEXSwgZ29zZWNfaGVscGVyLmV4ZWN1dGUsIGdvc2VjX2hlbHBlci5wYXJzZV9vdXRwdXQpLAogICAgQW5hbHlzaXNUb29sKCJSb3NpZSIsICJyb3NpZSIsIFsiZ28iLCAicHl0aG9uIiwgImphdmEiLCAiY3NoYXJwIl0sIFtjb25zdGFudHMuRU5HSU5FX1JPU0lFX0VOQUJMRURdLCByb3NpZV9oZWxwZXIuZXhlY3V0ZSwgcm9zaWVfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICAjIFRvbyBtYW55IGZhbHNlIHBvc2l0aXZlCiAgICAjIEFuYWx5c2lzVG9vbCgiRmxhd2ZpbmRlciIsICJmbGF3ZmluZGVyIiwgWyJjIiwgImNwcCJdLCBbY29uc3RhbnRzLkVOR0lORV9DX0VOQUJMRURdLCBmbGF3ZmluZGVyX2hlbHBlci5leGVjdXRlLCBmbGF3ZmluZGVyX2hlbHBlci5wYXJzZV9vdXRwdXQpLAogICAgIyBBbmFseXNpc1Rvb2woIkpTSGludCIsICJqc2hpbnQiLCBbImphdmFzY3JpcHQiXSwgW2NvbnN0YW50cy5FTkdJTkVfSkFWQVNDUklQVF9FTkFCTEVEXSwganNoaW50X2hlbHBlci5leGVjdXRlLCBqc2hpbnRfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICAjIERlYWN0aXZhdGVkIGZvciBub3cKICAgICMgQW5hbHlzaXNUb29sKCJGbG93IiwgImZsb3ciLCBbImphdmFzY3JpcHQiXSwgW2NvbnN0YW50cy5FTkdJTkVfSkFWQVNDUklQVF9GTE9XX0VOQUJMRURdLCBmbG93X2hlbHBlci5leGVjdXRlLCBmbG93X2hlbHBlci5wYXJzZV9vdXRwdXQpLAogICAgIyBEZXNhY3RpdmF0ZWQsIGl0J3MgbW9zdGx5IGFib3V0IHN0eWxlCiAgICAjIEFuYWx5c2lzVG9vbCgiUEhQQ1MiLCAicGhwY3MiLCBbInBocCJdLCBbY29uc3RhbnRzLkVOR0lORV9QSFBfRU5BQkxFRF0sIHBocGNzX2hlbHBlci5leGVjdXRlLCBwaHBjc19oZWxwZXIucGFyc2Vfb3V0cHV0KSwKCiAgICBBbmFseXNpc1Rvb2woIlBIUE1EIiwgInBocG1kIiwgWyJwaHAiXSwgW2NvbnN0YW50cy5FTkdJTkVfUEhQX0VOQUJMRURdLCBwaHBtZF9oZWxwZXIuZXhlY3V0ZSwgcGhwbWRfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woIlB5bGludCIsICJweWxpbnQiLCBbInB5dGhvbiJdLCBbY29uc3RhbnRzLkVOR0lORV9QWVRIT05fRU5BQkxFRF0sIHB5bGludF9oZWxwZXIuZXhlY3V0ZSwgcHlsaW50X2hlbHBlci5wYXJzZV9vdXRwdXQpLAogICAgQW5hbHlzaXNUb29sKCJSZWVrIiwgInJlZWsiLCBbInJ1YnkiXSwgW2NvbnN0YW50cy5FTkdJTkVfUlVCWV9FTkFCTEVEXSwgcmVla19oZWxwZXIuZXhlY3V0ZSwgcmVla19oZWxwZXIucGFyc2Vfb3V0cHV0KSwKICAgIEFuYWx5c2lzVG9vbCgiU2NhbGEiLCAic2NhbGFzdHlsZSIsIFsic2NhbGEiXSwgW2NvbnN0YW50cy5FTkdJTkVfU0NBTEFfRU5BQkxFRF0sIHNjYWxhc3R5bGVfaGVscGVyLmV4ZWN1dGUsIHNjYWxhc3R5bGVfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woIlNoZWxsIiwgInNoZWxsY2hlY2siLCBbInNoZWxsIl0sIFtjb25zdGFudHMuRU5HSU5FX1NIRUxMU0NSSVBUX0VOQUJMRURdLCBzaGVsbGNoZWNrX2hlbHBlci5leGVjdXRlLCBzaGVsbGNoZWNrX2hlbHBlci5wYXJzZV9vdXRwdXQpLAogICAgQW5hbHlzaXNUb29sKCJ5YW1sbGludCIsICJ5YW1sbGludCIsIFsieWFtbCJdLCBbY29uc3RhbnRzLkVOR0lORV9ZQU1MX0VOQUJMRURdLCB5YW1sbGludF9oZWxwZXIuZXhlY3V0ZSwgeWFtbGxpbnRfaGVscGVyLnBhcnNlX291dHB1dCksCl0KCgoKZGVmIGV4ZWN1dGVfYW5hbHlzaXNfdG9vbChhbmFseXNpc190b29sLCBjb25maWdfZmlsZSwgd29ya2luZ19kaXJlY3RvcnksIHJlcG9zaXRvcnlfZGlyZWN0b3J5LAogICAgICAgICAgICAgICAgICAgICAgICAgIHByb2plY3RfY29uZmlndXJhdGlvbiwgc2xvY3NfcGVyX2xhbmd1YWdlLCBwaXBlbGluZV9jb25maWd1cmF0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFiYXNlX2Nvbm5lY3Rpb249Tm9uZSwgYW5hbHlzaXNfaWQ9Tm9uZSk6CiAgICAiIiIKICAgIEV4ZWN1dGUgb25lIGFuYWx5c2lzIHRvb2wgdGhhdCBpcyByZXByZXNlbnRlZCBieSBhbiBBbmFseXNpcyBvYmplY3QuCiAgICA6cGFyYW0gYW5hbHlzaXNfaWQ6IGlkZW50aWZpZXIgb2YgdGhlIGFuYWx5c2lzCiAgICA6cGFyYW0gZGF0YWJhc2VfY29ubmVjdGlvbjogY29ubmVjdGlvbiB0byB0aGUgZGF0YWJhc2UKICAgIDpwYXJhbSBhbmFseXNpc190b29sOiB0aGUgdmFsdWUgb2YgdGhlIEFuYWx5c2lzIG9iamVjdCB0byBiZSBwcm9jZXNzZWQKICAgIDpwYXJhbSBjb25maWdfZmlsZTogY29uZmlndXJhdGlvbiBmaWxlIGZvciB0aGUgZXhlY3V0b3IgKHVzZWQgdG8gZmluZCB0aGUgYmluYXJ5IG9mIHRoZSB0b29sKQogICAgOnBhcmFtIHdvcmtpbmdfZGlyZWN0b3J5OiB3b3JraW5nIGRpcmVjdG9yeSB3aGVyZSB3ZSBjYW4gY3JlYXRlIHRlbXBvcmFyeSBmaWxlcy4KICAgIDpwYXJhbSByZXBvc2l0b3J5X2RpcmVjdG9yeTogd2hlcmUgdGhlIHJlcG9zaXRvcnkgZGF0YSBoYXMgYmVlbiBjbG9uZWQuCiAgICA6cGFyYW0gcHJvamVjdF9jb25maWd1cmF0aW9uOiB0aGUgcHJvamVjdCBjb25maWd1cmF0aW9uIChkaWN0aW9uYXJ5KQogICAgOnBhcmFtIHNsb2NzX3Blcl9sYW5ndWFnZTogZGljdGlvbmFyeSB0aGF0IGdpdmVzIHRoZSBudW1iZXIgb2YgTE9DIHBlciBsYW5ndWFnZS4KICAgIDpwYXJhbSBwaXBlbGluZV9jb25maWd1cmF0aW9uOiB0aGUgcGlwZWxpbmUgYmVpbmcgcnVuL2V4ZWN1dGVkCiAgICA6cmV0dXJuOgogICAgIiIiCiAgICB2aW9sYXRpb25zID0gW10KCiAgICAjIFN0ZXAgMTogY2hlY2sgaWYgdGhlIHRvb2wgaXMgZGlzYWJsZWQgb3Igbm90IGluIHRoZSBwcm9qZWN0IGNvbmZpZ3VyYXRpb24uCiAgICBpc19lbmFibGVkID0gRmFsc2UKICAgIGZvciBhbmFseXNpc190b29sX2NvbnN0YW50IGluIGFuYWx5c2lzX3Rvb2wuZW5hYmxlZF9jb25zdGFudHM6CiAgICAgICAgaWYgY29uZi5pc19lbmFibGVkKHByb2plY3RfY29uZmlndXJhdGlvbiwgYW5hbHlzaXNfdG9vbF9jb25zdGFudCwgInRydWUiKToKICAgICAgICAgICAgaXNfZW5hYmxlZCA9IFRydWUKCiAgICBpZiBub3QgaXNfZW5hYmxlZDoKICAgICAgICBsb2dnaW5nLmluZm8oIkFuYWx5c2lzICVzIGlzIGRpc2FibGVkIiwgYW5hbHlzaXNfdG9vbC5uYW1lKQogICAgICAgIG1ldHJpY3MuaW5jcmVtZW50X21ldHJpYygidG9vbF97MH1fZGlzYWJsZWQiLmZvcm1hdChhbmFseXNpc190b29sLnRvb2xfbmFtZSkpCiAgICAgICAgcmV0dXJuIHZpb2xhdGlvbnMKCgogICAgIyBTdGVwIDI6IGNoZWNrIGlmIHRoZSB0b29sIGhhcyBmaWxlcyB0aGF0IGFyZSBzdXBwb3J0ZWQgYnkgdGhpcyBhbmFseXNpcywgZG8gdGhhdCBvbmx5IGlmIHdlIGhhdmUgYSBwcm9qZWN0CiAgICAjIGFuYWx5c2lzLiBGb3IgYSBmaWxlIGFuYWx5c2lzLCB0aGUgdXNlciBhbHJlYWR5IHNwZWNpZnkgdGhlIGxhbmd1YWdlIGFuZCB3ZSBleGVjdXRlIG9ubHkgdGhlIHRvb2wgd2UgcmVhbGx5CiAgICAjIFdhbnQgb3IgbmVlZC4KICAgIGlmIHBpcGVsaW5lX2NvbmZpZ3VyYXRpb24ubW9kZSA9PSBQaXBlbGluZU1vZGUuUFJPSkVDVF9BTkFMWVNJUzoKICAgICAgICBoYXNfc2xvY3MgPSBGYWxzZQogICAgICAgIGZvciBsYW5ndWFnZSBpbiBhbmFseXNpc190b29sLmxhbmd1YWdlczoKICAgICAgICAgICAgaWYgbGFuZ3VhZ2UgaW4gc2xvY3NfcGVyX2xhbmd1YWdlIGFuZCBzbG9jc19wZXJfbGFuZ3VhZ2VbbGFuZ3VhZ2VdID4gMDoKICAgICAgICAgICAgICAgIGhhc19zbG9jcyA9IFRydWUKCiAgICAgICAgaWYgbm90IGhhc19zbG9jczoKICAgICAgICAgICAgbG9nZ2luZy5kZWJ1ZygiTm8gZmlsZSB3aXRoIGZvciB0b29sICVzIiwgYW5hbHlzaXNfdG9vbC50b29sX25hbWUpCiAgICAgICAgICAgIG1ldHJpY3MuaW5jcmVtZW50X21ldHJpYygidG9vbF97MH1fbm9zbG9jIi5mb3JtYXQoYW5hbHlzaXNfdG9vbC50b29sX25hbWUpKQogICAgICAgICAgICByZXR1cm4gdmlvbGF0aW9ucwoKICAgICMgU3RlcCAzOiBleGVjdXRlIHRoZSB0b29sLgogICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKCJ0b29sX3swfV9leGVjdXRlZCIuZm9ybWF0KGFuYWx5c2lzX3Rvb2wudG9vbF9uYW1lKSkKICAgIGFuYWx5c2lzX3Jlc3VsdHNfZmlsZSA9ICJ7MH0vezF9LXJlc3VsdHMiLmZvcm1hdCh3b3JraW5nX2RpcmVjdG9yeSwgYW5hbHlzaXNfdG9vbC50b29sX25hbWUpCiAgICBsb2dnaW5nLmluZm8oCiAgICAgICAgIltleGVjdXRlX2FuYWx5c2lzX3Rvb2xdIGV4ZWN1dGluZyB0b29sICVzIGluICVzLCByZXN1bHQgZmlsZTogJXMiLAogICAgICAgIGFuYWx5c2lzX3Rvb2wudG9vbF9uYW1lLAogICAgICAgIHdvcmtpbmdfZGlyZWN0b3J5LAogICAgICAgIGFuYWx5c2lzX3Jlc3VsdHNfZmlsZSkKCiAgICBpZiBub3QgcHJvamVjdF9jb25maWd1cmF0aW9uOgogICAgICAgIHByb2plY3RfY29uZmlndXJhdGlvbiA9IHt9CgogICAgIyBBZGQgdGhlIHdvcmtpbmcgZGlyZWN0b3J5IGFzIGEga2V5IHRvIHRoZSBjb25maWd1cmF0aW9uLgogICAgcHJvamVjdF9jb25maWd1cmF0aW9uW2NvbnN0YW50cy5QUk9KRUNUX0NPTkZJR1VSQVRJT05fV09SS0lOR19ESVJFQ1RPUllfS0VZXSA9IHdvcmtpbmdfZGlyZWN0b3J5CiAgICBwcm9qZWN0X2NvbmZpZ3VyYXRpb25bY29uc3RhbnRzLlBST0pFQ1RfQ09ORklHVVJBVElPTl9QSVBFTElORV9NT0RFX0tFWV0gPSBwaXBlbGluZV9jb25maWd1cmF0aW9uLm1vZGUKCiAgICBhbmFseXNpc19jb250ZXh0OiBBbmFseXNpc0NvbnRleHQgPSBBbmFseXNpc0NvbnRleHQoZGF0YWJhc2VfY29ubmVjdGlvbj1kYXRhYmFzZV9jb25uZWN0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuYWx5c2lzX2lkPWFuYWx5c2lzX2lkKQoKICAgIGlmIG5vdCBhbmFseXNpc190b29sLmV4ZWN1dGVfZnVuY3Rpb24oY29uZmlnX2ZpbGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcG9zaXRvcnlfZGlyZWN0b3J5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmFseXNpc19yZXN1bHRzX2ZpbGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2plY3RfY29uZmlndXJhdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5hbHlzaXNfY29udGV4dCk6CiAgICAgICAgcmFpc2UgQW5hbHlzaXNUb29sRXhlY3V0aW9uRXhjZXB0aW9uKGFuYWx5c2lzX3Rvb2wubmFtZSkKCiAgICBpZiBvcy5wYXRoLmlzZmlsZShhbmFseXNpc19yZXN1bHRzX2ZpbGUpOgogICAgICAgIHZpb2xhdGlvbnMgPSBhbmFseXNpc190b29sLnBhcnNlX2Z1bmN0aW9uKGFuYWx5c2lzX3Jlc3VsdHNfZmlsZSwgInswfS8iLmZvcm1hdChyZXBvc2l0b3J5X2RpcmVjdG9yeSkpCiAgICBtZXRyaWNzLmluY3JlbWVudF9tZXRyaWNfdmFsdWUoInRvb2xfezB9X3Zpb2xhdGlvbnMiLmZvcm1hdChhbmFseXNpc190b29sLnRvb2xfbmFtZSksIGxlbih2aW9sYXRpb25zKSkKICAgIHJldHVybiB2aW9sYXRpb25zCgoKZGVmIGFkZF9jb2RlaGFzaF90b192aW9sYXRpb25zKHZpb2xhdGlvbnMsIHJlcG9zaXRvcnlfZGlyZWN0b3J5KToKICAgICIiIgogICAgYWRkIGEgaGFzaCB0byBlYWNoIHZpb2xhdGlvbiBiZWZvcmUgaW5zZXJ0aW5nIHRoZW0gaW4gdGhlIGRhdGFiYXNlCiAgICA6cGFyYW0gdmlvbGF0aW9uczogbGlzdCBvZiB2aW9sYXRpb25zIHRvIGFkZCBhIGNvZGVoYXNoCiAgICA6cGFyYW0gcmVwb3NpdG9yeV9kaXJlY3Rvcnk6IHRoZSBkaXJlY3Rvcnkgb2YgdGhlIHJlcG9zaXRvcnkgd2hlcmUgaXMgdGhlIGNvZGUKICAgIDpyZXR1cm46IGEgbmV3IGxpc3Qgb2YgdmlvbGF0aW9ucyB0aGF0IGNvbnRhaW5zIHRoZSBjb2RlaGFzaAogICAgIiIiCiAgICByZXMgPSBbXQogICAgZm9yIHZpb2xhdGlvbiBpbiB2aW9sYXRpb25zOgogICAgICAgIHRyeToKICAgICAgICAgICAgbGluZV9jb250ZW50ID0gcmVhZF9saW5lX2Zyb21fcmVwb3NpdG9yeShyZXBvc2l0b3J5X2RpcmVjdG9yeSwgdmlvbGF0aW9uLmZpbGVuYW1lLCB2aW9sYXRpb24ubGluZSkKICAgICAgICAgICAgaWYgbGluZV9jb250ZW50OgogICAgICAgICAgICAgICAgY29kZV9oYXNoID0gaGFzaGxpYi5tZDUobGluZV9jb250ZW50LmVuY29kZSgpKS5oZXhkaWdlc3QoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgY29kZV9oYXNoID0gTm9uZQogICAgICAgIGV4Y2VwdCBVbmljb2RlRGVjb2RlRXJyb3I6CiAgICAgICAgICAgIGxvZ2dpbmcud2FybmluZygiW2FkZF9jb2RlaGFzaF90b192aW9sYXRpb25zXSBjYW5ub3QgcmVhZCBsaW5lIGluIHJlcG9zaXRvcnkiKQogICAgICAgICAgICBjb2RlX2hhc2ggPSBOb25lCgogICAgICAgIG5ld192aW9sYXRpb24gPSBWaW9sYXRpb24oCiAgICAgICAgICAgIHZpb2xhdGlvbi5maWxlbmFtZSwKICAgICAgICAgICAgdmlvbGF0aW9uLmxpbmUsCiAgICAgICAgICAgIHZpb2xhdGlvbi5kZXNjcmlwdGlvbiwKICAgICAgICAgICAgdmlvbGF0aW9uLnNldmVyaXR5LAogICAgICAgICAgICB2aW9sYXRpb24uY2F0ZWdvcnksCiAgICAgICAgICAgIHZpb2xhdGlvbi5saW5lX2NvdW50LAogICAgICAgICAgICB0b29sPXZpb2xhdGlvbi50b29sLAogICAgICAgICAgICBsYW5ndWFnZT12aW9sYXRpb24ubGFuZ3VhZ2UsCiAgICAgICAgICAgIHJ1bGU9dmlvbGF0aW9uLnJ1bGUsCiAgICAgICAgICAgIHJ1bGVfc2V0PXZpb2xhdGlvbi5ydWxlX3NldCwKICAgICAgICAgICAgcnVsZV91cmw9dmlvbGF0aW9uLnJ1bGVfdXJsLAogICAgICAgICAgICBjb2RlaGFzaD1jb2RlX2hhc2gpCiAgICAgICAgcmVzLmFwcGVuZChuZXdfdmlvbGF0aW9uKQogICAgcmV0dXJuIHJlcwoKCmRlZiBleGVjdXRlX2FuYWx5c2lzX3Rvb2xzKGFuYWx5c2lzX3Rvb2xzLCBkYXRhYmFzZV9jb25uZWN0aW9uLCBjb25maWdfZmlsZSwgd29ya2luZ19kaXJlY3RvcnksIHJlcG9zaXRvcnlfZGlyZWN0b3J5LAogICAgICAgICAgICAgICAgICAgICAgICAgICBzbG9jc19wZXJfbGFuZ3VhZ2UsIHBpcGVsaW5lX2NvbmZpZ3VyYXRpb24sIHByb2plY3RfY29uZmlndXJhdGlvbj1Ob25lLCBhbmFseXNpc19pZD1Ob25lKToKICAgICIiIgogICAgRXhlY3V0ZSBhbGwgYW5hbHlzaXMgdG9vbHMKICAgIDpwYXJhbSBhbmFseXNpc190b29sczogYWxsIGFuYWx5c2lzIHRvb2xzIHRvIGFuYWx5emUsIHVzaW5nIGFuIGFycmF5IG9mIFtbQW5hbHlzaXNUb29sXV0KICAgIDpwYXJhbSBhbmFseXNpc19pZDogdGhlIGFuYWx5c2lzIGlkIGJlaW5nIGRvbmUsIGVpdGhlciBmaWxlIHByb2plY3QgYW5hbHlzaXMgb3IgZmlsZSBhbmFseXNpcwogICAgOnBhcmFtIGRhdGFiYXNlX2Nvbm5lY3Rpb246IHRoZSBvcGVuZWQgZGF0YWJhc2UgY29ubmVjdGlvbgogICAgOnBhcmFtIGNvbmZpZ19maWxlOiBjb25maWcgZmlsZSBvZiB0aGUgZXhlY3V0b3IKICAgIDpwYXJhbSB3b3JraW5nX2RpcmVjdG9yeTogd29ya2luZyBkaXJlY3Rvcnkgd2hlcmUgd2UgcHV0IHNhZmVseSBzdG9yZSB0ZW1wb3JhcnkgZGF0YQogICAgOnBhcmFtIHJlcG9zaXRvcnlfZGlyZWN0b3J5OiB3aGVyZSB0aGUgYWN0dWFsIGNvZGUgbGl2ZXMKICAgIDpwYXJhbSBwcm9qZWN0X2NvbmZpZ3VyYXRpb246IGEgZGljdGlvbmFyeSByZXByZXNlbnRpbmcgdGhlIHByb2plY3QgY29uZmlndXJhdGlvbgogICAgOnBhcmFtIHNsb2NzX3Blcl9sYW5ndWFnZTogYSBkaWN0aW9uYXJ5IGdpdmluZyB0aGUgc2xvY3MgZm9yIGFsbCBsYW5ndWFnZXMgKE5vbmUgZm9yIGZpbGUgYW5hbHlzaXMpCiAgICA6cGFyYW0gcGlwZWxpbmVfY29uZmlndXJhdGlvbjogY29uZmlndXJhdGlvbiBvZiB0aGUgcGlwZWxpbmUsIGVpdGhlciBmb3Igc2luZ2xlIGZpbGUgYW5hbHlzaXMgb3IgcHJvamVjdCBhbmFseXNpcwogICAgOnJldHVybjogYSBsaXN0IG9mIHRhZ3MgdGhhdCByZXBvcnRzIHBvdGVudGlhbCBhbmFseXNpcyBmYWlsdXJlcyBvZiB0aGUgcHJvamVjdAogICAgIiIiCgogICAgdGFncyA9IFtdCiAgICBzeXN0ZW1fY29uZmlndXJhdGlvbiA9IGRhdGFiYXNlLmdldF9jb25maWd1cmF0aW9uKGRhdGFiYXNlX2Nvbm5lY3Rpb24pCgogICAgIyBGb3IgZWFjaCBhbmFseXNpcyB0b29sLCB0cnkgdG8gcnVuIGl0LiBJZiB3ZSBnZXQgdmlvbGF0aW9ucywgbGV0J3MgYWRkIHRoZW0hIE90aGVyd2lzZSwgbGV0J3MgYWRkIGEgdGFnCiAgICAjIHRvIHNob3cgdGhlIGlzc3VlIHRvIHRoZSB1c2VyLgogICAgZm9yIGFuYWx5c2lzX3Rvb2wgaW4gYW5hbHlzaXNfdG9vbHM6CgogICAgICAgICMgRmlyc3QsIHRyeSB0byBzZWUgaWYgdGhlIHRvb2wgaXMgZGlzYWJsZWQgdXNpbmcgZGVjaWRlcnMuCiAgICAgICAgZGVjaWRlcl9rZXkgPSBhbmFseXNpc190b29sLmRlY2lkZXJfa2V5X2Rpc2FibGVkKCkKICAgICAgICBpZiBpc19kZWNpZGVyX2VuYWJsZWQoc3lzdGVtX2NvbmZpZ3VyYXRpb24sIGRlY2lkZXJfa2V5KToKICAgICAgICAgICAgbG9nZ2luZy5pbmZvKCJbRVhFQ1VUT1JdIHRvb2wgJXMgZGlzYWJsZWQgYnkgZGVjaWRlcnMsIHNraXBwaW5nIiwgYW5hbHlzaXNfdG9vbC50b29sX25hbWUpCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHN0YXJ0X3RzID0gdGltZS50aW1lKCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHZpb2xhdGlvbnMgPSBleGVjdXRlX2FuYWx5c2lzX3Rvb2woCiAgICAgICAgICAgICAgICBhbmFseXNpc190b29sPWFuYWx5c2lzX3Rvb2wsCiAgICAgICAgICAgICAgICBjb25maWdfZmlsZT1jb25maWdfZmlsZSwKICAgICAgICAgICAgICAgIHdvcmtpbmdfZGlyZWN0b3J5PXdvcmtpbmdfZGlyZWN0b3J5LAogICAgICAgICAgICAgICAgcmVwb3NpdG9yeV9kaXJlY3Rvcnk9cmVwb3NpdG9yeV9kaXJlY3RvcnksCiAgICAgICAgICAgICAgICBwcm9qZWN0X2NvbmZpZ3VyYXRpb249cHJvamVjdF9jb25maWd1cmF0aW9uLAogICAgICAgICAgICAgICAgc2xvY3NfcGVyX2xhbmd1YWdlPXNsb2NzX3Blcl9sYW5ndWFnZSwKICAgICAgICAgICAgICAgIHBpcGVsaW5lX2NvbmZpZ3VyYXRpb249cGlwZWxpbmVfY29uZmlndXJhdGlvbiwKICAgICAgICAgICAgICAgIGRhdGFiYXNlX2Nvbm5lY3Rpb249ZGF0YWJhc2VfY29ubmVjdGlvbiwKICAgICAgICAgICAgICAgIGFuYWx5c2lzX2lkPWFuYWx5c2lzX2lkKQoKICAgICAgICAgICAgIyBJZiB3ZSBkZWNpZGUgdG8gbXV0YXRlIHRoZSBydWxlcyBiYXNlZCBvbiB0aGUgdmFsdWVzIGluIHRoZSBkYXRhYmFzZQogICAgICAgICAgICBpZiBpc19kZWNpZGVyX2VuYWJsZWQoc3lzdGVtX2NvbmZpZ3VyYXRpb24sIERFQ0lERVJfRVhFQ1VUT1JfRklMVEVSX1JVTEVTX0ZST01fREFUQUJBU0UpOgogICAgICAgICAgICAgICAgcnVsZXMgPSBbXQogICAgICAgICAgICAgICAgZm9yIGFuYWx5c2lzX3Rvb2xfbGFuZ3VhZ2UgaW4gYW5hbHlzaXNfdG9vbC5sYW5ndWFnZXM6CiAgICAgICAgICAgICAgICAgICAgIyBDb252ZXJ0IHRoZSBsYW5ndWFnZSBmcm9tIHN0cmluZyB0byBpbnRlZ2VyIGNvbnN0YW50LgogICAgICAgICAgICAgICAgICAgIGxhbmd1YWdlX2NvbnN0YW50ID0gTEFOR1VBR0VTX1RPX0NPTlNUQU5UU1thbmFseXNpc190b29sX2xhbmd1YWdlXQogICAgICAgICAgICAgICAgICAgIGlmIGxhbmd1YWdlX2NvbnN0YW50OgogICAgICAgICAgICAgICAgICAgICAgICBydWxlcy5leHRlbmQoZ2V0X2FsbF9ydWxlcyhkYXRhYmFzZV9jb25uZWN0aW9uLCBsYW5ndWFnZV9jb25zdGFudCkpCiAgICAgICAgICAgICAgICB2aW9sYXRpb25zID0gZmlsdGVyX3Zpb2xhdGlvbnNfd2l0aF9ydWxlcyh2aW9sYXRpb25zLCBydWxlcykKCiAgICAgICAgICAgIGlmIGlzX2RlY2lkZXJfZW5hYmxlZChzeXN0ZW1fY29uZmlndXJhdGlvbiwgREVDSURFUl9FWEVDVVRPUl9GSUxURVJfUlVMRVNfV0lUSF9UTVBfRlJPTV9EQVRBQkFTRSk6CiAgICAgICAgICAgICAgICB2aW9sYXRpb25zID0gZmlsdGVyX3Zpb2xhdGlvbnNfc3RhcnRfd2l0aF90bXAodmlvbGF0aW9ucywgcmVwb3NpdG9yeV9kaXJlY3RvcnkpCgogICAgICAgICAgICAjIGlmIHRoaXMgaXMgYSBwcm9qZWN0IGFuYWx5c2lzLCBqdXN0IGFkZCB2aW9sYXRpb25zIGluIHRoZSBkYXRhYnNlCiAgICAgICAgICAgIGlmIHBpcGVsaW5lX2NvbmZpZ3VyYXRpb24ubW9kZSA9PSBQaXBlbGluZU1vZGUuUFJPSkVDVF9BTkFMWVNJUzoKICAgICAgICAgICAgICAgIHZpb2xhdGlvbnNfd2l0aF9jb2RlaGFzaCA9IGFkZF9jb2RlaGFzaF90b192aW9sYXRpb25zKHZpb2xhdGlvbnMsIHJlcG9zaXRvcnlfZGlyZWN0b3J5KQogICAgICAgICAgICAgICAgZGF0YWJhc2UuYWRkX3Zpb2xhdGlvbnMoZGF0YWJhc2VfY29ubmVjdGlvbiwgYW5hbHlzaXNfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aW9sYXRpb25zX3dpdGhfY29kZWhhc2gsIHByb2plY3RfY29uZmlndXJhdGlvbikKCiAgICAgICAgICAgICMgSWYgdGhpcyBpcyBhIGZpbGUgYW5hbHlzaXMsIG1ha2Ugc3VyZSB3ZSBjb252ZXJ0IGZpcnN0IHRoZSBWaW9sYXRpb24gb2JqZWN0IGludG8gRmlsZUFuYWx5c2lzVmlvbGF0aW9uCiAgICAgICAgICAgICMgYW5kIHRoZW4gcHV0IHRoZSBkYXRhIGluIHRoZSBkYXRhYmFzZS4KICAgICAgICAgICAgaWYgcGlwZWxpbmVfY29uZmlndXJhdGlvbi5tb2RlID09IFBpcGVsaW5lTW9kZS5GSUxFX0FOQUxZU0lTOgogICAgICAgICAgICAgICAgZm9yIHZpb2xhdGlvbiBpbiB2aW9sYXRpb25zOgoKICAgICAgICAgICAgICAgICAgICAjIE1ha2luZyBzdXJlIHRoYXQgYWxsIHZpb2xhdGlvbnMgaGF2ZSBhIHJ1bGUgZGVmaW5lZC4KICAgICAgICAgICAgICAgICAgICBpZiBub3QgdmlvbGF0aW9uLnJ1bGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgZmlsZV9hbmFseXNpc192aW9sYXRpb24gPSBGaWxlQW5hbHlzaXNWaW9sYXRpb24uZnJvbV92aW9sYXRpb24oYW5hbHlzaXNfaWQsIHZpb2xhdGlvbikKICAgICAgICAgICAgICAgICAgICBjcmVhdGVfZmlsZV9hbmFseXNpc192aW9sYXRpb24oZGF0YWJhc2VfY29ubmVjdGlvbiwgZmlsZV9hbmFseXNpc192aW9sYXRpb24pCiAgICAgICAgZXhjZXB0IEFuYWx5c2lzVG9vbEV4ZWN1dGlvbkV4Y2VwdGlvbjoKICAgICAgICAgICAgdGFncy5hcHBlbmQoInswfV9FUlJPUiIuZm9ybWF0KGFuYWx5c2lzX3Rvb2wudG9vbF9uYW1lLnVwcGVyKCkpKQogICAgICAgICAgICBsb2dnaW5nLmVycm9yKCJbRVhFQ1VUT1JdICVzIC0gY2Fubm90IGNvbnRpbnVlIGFuYWx5c2lzIGVycm9yLCBhbmFseXNpcyAlcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYW5hbHlzaXNfdG9vbC50b29sX25hbWUsIGFuYWx5c2lzX2lkKQogICAgICAgICAgICBtZXRyaWNzLmluY3JlbWVudF9tZXRyaWMoInRvb2xfezB9X2Vycm9yIi5mb3JtYXQoYW5hbHlzaXNfdG9vbC50b29sX25hbWUpKQogICAgICAgIGV4Y2VwdCAoQW5hbHlzaXNUb29sVGltZW91dEV4Y2VwdGlvbiwgc3VicHJvY2Vzcy5UaW1lb3V0RXhwaXJlZCk6CiAgICAgICAgICAgIHRhZ3MuYXBwZW5kKCJ7MH1fVElNRU9VVCIuZm9ybWF0KGFuYWx5c2lzX3Rvb2wudG9vbF9uYW1lLnVwcGVyKCkpKQogICAgICAgICAgICBsb2dnaW5nLmVycm9yKCJbRVhFQ1VUT1JdICVzIC0gdGltZW91dCBleHBpcmVkIGZvciBhbmFseXNpcyAlcyIsIGFuYWx5c2lzX3Rvb2wudG9vbF9uYW1lLCBhbmFseXNpc19pZCkKICAgICAgICAgICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKCJ0b29sX3swfV90aW1lb3V0Ii5mb3JtYXQoYW5hbHlzaXNfdG9vbC50b29sX25hbWUpKQogICAgICAgIGV4Y2VwdCBzdWJwcm9jZXNzLkNhbGxlZFByb2Nlc3NFcnJvcjoKICAgICAgICAgICAgbG9nZ2luZy5leGNlcHRpb24oImV4Y2VwdGlvbiBjYXVnaHQiKQogICAgICAgICAgICB0YWdzLmFwcGVuZCgiezB9X0VSUk9SIi5mb3JtYXQoYW5hbHlzaXNfdG9vbC50b29sX25hbWUudXBwZXIoKSkpCiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoIltFWEVDVVRPUl0gJXMgLSBjYW5ub3QgY29udGludWUsIGNhbGxlZCBwcm9jZXNzIGVycm9yIGFuYWx5c2lzICVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBhbmFseXNpc190b29sLnRvb2xfbmFtZSwgYW5hbHlzaXNfaWQpCiAgICAgICAgICAgIG1ldHJpY3MuaW5jcmVtZW50X21ldHJpYygidG9vbF97MH1fZXJyb3IiLmZvcm1hdChhbmFseXNpc190b29sLnRvb2xfbmFtZSkpCiAgICAgICAgZW5kX3RzID0gdGltZS50aW1lKCkKICAgICAgICBkdXJhdGlvbl9zZWMgPSBpbnQoZW5kX3RzIC0gc3RhcnRfdHMpCgogICAgICAgIGxvZ2dpbmcuaW5mbygiW0VYRUNVVE9SXSBhbmFseXNpcyAlcywgZXhlY3V0aW5nIHRvb2wgJXMgdG9vbCAlcyBzZWNzIiwgYW5hbHlzaXNfaWQsIGFuYWx5c2lzX3Rvb2wudG9vbF9uYW1lLCBkdXJhdGlvbl9zZWMpCgogICAgICAgICMgT25seSBhZGQgZXhlY3V0aW9uIHRpbWUgZm9yIHRoZSBwcm9qZWN0IGFuYWx5c2lzLiBJZiB3ZSBrZWVwIGl0IGFsc28gZm9yIHRoZSBmaWxlIGFuYWx5c2lzLAogICAgICAgICMgdGhpcyB3b3VsZCBzY2V3IHRoZSBkYXRhLgogICAgICAgIGlmIHBpcGVsaW5lX2NvbmZpZ3VyYXRpb24ubW9kZSA9PSBQaXBlbGluZU1vZGUuUFJPSkVDVF9BTkFMWVNJUzoKICAgICAgICAgICAgYWRkX2FuYWx5c2lzX3N0ZXBfcnVubmluZ190aW1lKGRhdGFiYXNlX2Nvbm5lY3Rpb24sIGFuYWx5c2lzX2lkLCBhbmFseXNpc190b29sLnRvb2xfbmFtZSwgZHVyYXRpb25fc2VjKQogICAgcmV0dXJuIHRhZ3MKCgpkZWYgZmluZF9kdXBsaWNhdGVzKGFuYWx5c2lzX2lkLCBkYiwgY29uZmlnX2ZpbGUsIHdvcmtpbmdfZGlyZWN0b3J5LCByZXBvc2l0b3J5X2RpcmVjdG9yeSwgcHJvamVjdF9jb25maWd1cmF0aW9uKToKICAgICMgVGltZSB0byBmaW5kIGR1cGxpY2F0ZXMgd2l0aCBqc2NwIQogICAgdGFncyA9IFtdCiAgICBpZiBjb25mLmlzX2VuYWJsZWQocHJvamVjdF9jb25maWd1cmF0aW9uLCBjb25zdGFudHMuRU5HSU5FX0RVUExJQ0FURVNfRU5BQkxFRCwgInRydWUiKToKICAgICAgICBqc2NwZF9zdGFydF90cyA9IHRpbWUudGltZSgpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBkdXBsaWNhdGVzID0ganNjcGRfaGVscGVyLmZpbmRfZHVwbGljYXRlcyhjb25maWdfZmlsZSwgcHJvamVjdF9jb25maWd1cmF0aW9uLCByZXBvc2l0b3J5X2RpcmVjdG9yeSwgd29ya2luZ19kaXJlY3RvcnkpCgogICAgICAgICAgICBpZiBsZW4oZHVwbGljYXRlcykgPT0gMDoKICAgICAgICAgICAgICAgIGxvZ2dpbmcuaW5mbygiW0VYRUNVVE9SXSBubyBkdXBsaWNhdGVzIGZvciBhbmFseXNpcyB7MH0iLmZvcm1hdChhbmFseXNpc19pZCkpCgogICAgICAgICAgICBkYXRhYmFzZS5hZGRfZHVwbGljYXRlcyhkYiwgYW5hbHlzaXNfaWQsIGR1cGxpY2F0ZXMsIHByb2plY3RfY29uZmlndXJhdGlvbikKICAgICAgICBleGNlcHQgKEFuYWx5c2lzVG9vbFRpbWVvdXRFeGNlcHRpb24sIHN1YnByb2Nlc3MuVGltZW91dEV4cGlyZWQpOgogICAgICAgICAgICB0YWdzLmFwcGVuZCgiSlNDUERfVElNRU9VVCIpCiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoIltFWEVDVVRPUl0gSlNDUEQgLSB0aW1lb3V0IGV4cGlyZWQgZm9yIGFuYWx5c2lzIHswfSIuZm9ybWF0KGFuYWx5c2lzX2lkKSkKICAgICAgICBleGNlcHQgc3VicHJvY2Vzcy5DYWxsZWRQcm9jZXNzRXJyb3I6CiAgICAgICAgICAgIHRhZ3MuYXBwZW5kKCJKU0NQRF9FUlJPUiIpCiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoIltFWEVDVVRPUl0gSlNDUEQgLSBpc3N1ZSBmb3IgYW5hbHlzaXMgezB9Ii5mb3JtYXQoYW5hbHlzaXNfaWQpKQogICAgICAgIGpzY3BkX2VuZF90cyA9IHRpbWUudGltZSgpCiAgICAgICAganNjcGRfZHVyYXRpb24gPSBqc2NwZF9lbmRfdHMgLSBqc2NwZF9zdGFydF90cwogICAgICAgIGxvZ2dpbmcuZGVidWcoIltFWEVDVVRPUl0gSlNDUEQgdG9vayB7MH0gc2VjIHRvIGV4ZWN1dG9yIi5mb3JtYXQoanNjcGRfZHVyYXRpb24pKQogICAgcmV0dXJuIHRhZ3MKCgpkZWYgZ2V0X2NvbXBsZXhpdHlfbWV0cmljcyhhbmFseXNpc19pZCwgZGIsIGNvbmZpZ19maWxlLCB3b3JraW5nX2RpcmVjdG9yeSwgcmVwb3NpdG9yeV9kaXJlY3RvcnksIHByb2plY3RfY29uZmlndXJhdGlvbik6CiAgICB0YWdzID0gW10KICAgIGlmIGNvbmYuaXNfZW5hYmxlZChwcm9qZWN0X2NvbmZpZ3VyYXRpb24sIGNvbnN0YW50cy5FTkdJTkVfQ09NUExFWElUWV9NRVRSSUNTX0VOQUJMRUQsICJ0cnVlIik6CiAgICAgICAgY29tcGxleGl0eV9zdGFydF90cyA9IHRpbWUudGltZSgpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb21wbGV4aXR5X3JlcG9ydCA9IGxpemFyZF9oZWxwZXIuZ2V0X2NvbXBsZXhpdHlfbWV0cmljcyhjb25maWdfZmlsZSwgcHJvamVjdF9jb25maWd1cmF0aW9uLCByZXBvc2l0b3J5X2RpcmVjdG9yeSwgd29ya2luZ19kaXJlY3RvcnkpCgogICAgICAgICAgICBpZiBub3QgY29tcGxleGl0eV9yZXBvcnQ6CiAgICAgICAgICAgICAgICBsb2dnaW5nLmVycm9yKCJbRVhFQ1VUT1JdIG5vIGNvbXBsZXhpdHkgZm9yIGFuYWx5c2lzIHswfSIuZm9ybWF0KGFuYWx5c2lzX2lkKSkKCiAgICAgICAgICAgIGRhdGFiYXNlLmFkZF9jb21wbGV4aXR5X21ldHJpY3NfZnVuY3Rpb25zKGRiLCBhbmFseXNpc19pZCwgY29tcGxleGl0eV9yZXBvcnQucGVyX2Z1bmN0aW9uLCBwcm9qZWN0X2NvbmZpZ3VyYXRpb24pCiAgICAgICAgICAgIGRhdGFiYXNlLmFkZF9jb21wbGV4aXR5X21ldHJpY3Nfc3VtbWFyaWVzKGRiLCBhbmFseXNpc19pZCwgY29tcGxleGl0eV9yZXBvcnQuc3VtbWFyeSwgcHJvamVjdF9jb25maWd1cmF0aW9uKQoKICAgICAgICBleGNlcHQgKEFuYWx5c2lzVG9vbFRpbWVvdXRFeGNlcHRpb24sIHN1YnByb2Nlc3MuVGltZW91dEV4cGlyZWQpOgogICAgICAgICAgICBtZXRyaWNzLmluY3JlbWVudF9tZXRyaWMobWV0cmljc19uYW1lcy5BTkFMWVNJU19MSVpBUkRfVElNRU9VVCkKICAgICAgICAgICAgdGFncy5hcHBlbmQoIkxJWkFSRCBUSU1FT1VUIikKICAgICAgICAgICAgbG9nZ2luZy5lcnJvcigiW0VYRUNVVE9SXSBMSVpBUkQgLSB0aW1lb3V0IGV4cGlyZWQgYW5hbHlzaXMgezB9Ii5mb3JtYXQoYW5hbHlzaXNfaWQpKQogICAgICAgIGV4Y2VwdCBzdWJwcm9jZXNzLkNhbGxlZFByb2Nlc3NFcnJvcjoKICAgICAgICAgICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKG1ldHJpY3NfbmFtZXMuQU5BTFlTSVNfTElaQVJEX0VSUk9SKQogICAgICAgICAgICB0YWdzLmFwcGVuZCgiTElaQVJEX0VSUk9SIikKICAgICAgICAgICAgbG9nZ2luZy5lcnJvcigiW0VYRUNVVE9SXSBMSVpBUkQgLSBlcnJvciBmb3IgYW5hbHlzaXMgezB9Ii5mb3JtYXQoYW5hbHlzaXNfaWQpKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXhjZXB0aW9uOgogICAgICAgICAgICBtZXRyaWNzLmluY3JlbWVudF9tZXRyaWMobWV0cmljc19uYW1lcy5BTkFMWVNJU19MSVpBUkRfRVhDRVBUSU9OKQogICAgICAgICAgICB0YWdzLmFwcGVuZCgiTElaQVJEX0VSUk9SIikKICAgICAgICAgICAgbG9nZ2luZy5leGNlcHRpb24oIltFWEVDVVRPUl0gTElaQVJEIC0gdW5rbm93biBleGNlcHRpb24gezB9IGZvciBhbmFseXNpcyB7MX0iLmZvcm1hdChzdHIoZXhjZXB0aW9uKSwgYW5hbHlzaXNfaWQpKQogICAgICAgIGNvbXBsZXhpdHlfZW5kX3RzID0gdGltZS50aW1lKCkKICAgICAgICBkdXJhdGlvbiA9IGNvbXBsZXhpdHlfZW5kX3RzIC0gY29tcGxleGl0eV9zdGFydF90cwogICAgICAgIGxvZ2dpbmcuZGVidWcoIltFWEVDVVRPUl0gTElaQVJEIHRvb2sgezB9IHNlYyB0byBleGVjdXRvciIuZm9ybWF0KGR1cmF0aW9uKSkKICAgIHJldHVybiB0YWdzCgoKZGVmIGFuYWx5emVfYXJjaGl0ZWN0dXJlKGFuYWx5c2lzX2lkLCBkYiwgY29uZmlnX2ZpbGUsIHdvcmtpbmdfZGlyZWN0b3J5LCByZXBvc2l0b3J5X2RpcmVjdG9yeSwgc2xvY3NfcGVyX2xhbmd1YWdlLCBwcm9qZWN0X2NvbmZpZ3VyYXRpb24pOgogICAgIiIiCiAgICBBbmFseXplIHRoZSBhcmNoaXRlY3R1cmUgd2l0aCBkZXBlbmRzCiAgICA6cGFyYW0gYW5hbHlzaXNfaWQ6CiAgICA6cGFyYW0gZGI6CiAgICA6cGFyYW0gY29uZmlnX2ZpbGU6CiAgICA6cGFyYW0gd29ya2luZ19kaXJlY3Rvcnk6CiAgICA6cGFyYW0gcmVwb3NpdG9yeV9kaXJlY3Rvcnk6CiAgICA6cGFyYW0gc2xvY3NfcGVyX2xhbmd1YWdlOgogICAgOnBhcmFtIHByb2plY3RfY29uZmlndXJhdGlvbjoKICAgIDpyZXR1cm46CiAgICAiIiIKICAgIHRhZ3MgPSBbXQogICAgaWYgY29uZi5pc19lbmFibGVkKHByb2plY3RfY29uZmlndXJhdGlvbiwgY29uc3RhbnRzLkVOR0lORV9BUkNISVRFQ1RVUkVfRU5BQkxFRCwgInRydWUiKToKICAgICAgICBkZXBlbmRzX3N0YXJ0X3RzID0gdGltZS50aW1lKCkKICAgICAgICBkZXBlbmRzX3JlcG9ydF9maWxlID0gInswfS9kZXBlbmRzX3JlcG9ydCIuZm9ybWF0KHdvcmtpbmdfZGlyZWN0b3J5KQoKICAgICAgICBsYW5ndWFnZSA9IGRlcGVuZHNfaGVscGVyLmdldF9sYW5ndWFnZShzbG9jc19wZXJfbGFuZ3VhZ2UpCgogICAgICAgIGlmIG5vdCBsYW5ndWFnZToKICAgICAgICAgICAgbG9nZ2luZy5pbmZvKCJbRVhFQ1VUT1JdIFtERVBFTkRTXSBsYW5ndWFnZSBub3Qgc3VwcG9ydGVkIGZvciBhbmFseXNpcyAlcyIsIGFuYWx5c2lzX2lkKQogICAgICAgICAgICBtZXRyaWNzLmluY3JlbWVudF9tZXRyaWMobWV0cmljc19uYW1lcy5ERVBFTkRTX0xBTkdVQUdFX05PVF9TVVBQT1JURUQpCiAgICAgICAgICAgIHJldHVybiB0YWdzCgogICAgICAgIHRyeToKICAgICAgICAgICAgYXJjaGl0ZWN0dXJlID0gTm9uZQogICAgICAgICAgICBtZXRyaWNzLmluY3JlbWVudF9tZXRyaWMobWV0cmljc19uYW1lcy5ERVBFTkRTX0NBTExfVE9PTCkKICAgICAgICAgICAgZGVwZW5kc19oZWxwZXIuZXhlY3V0ZShjb25maWdfZmlsZSwgbGFuZ3VhZ2UsIHJlcG9zaXRvcnlfZGlyZWN0b3J5LCB3b3JraW5nX2RpcmVjdG9yeSwgZGVwZW5kc19yZXBvcnRfZmlsZSwgcHJvamVjdF9jb25maWd1cmF0aW9uKQogICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShkZXBlbmRzX3JlcG9ydF9maWxlKToKICAgICAgICAgICAgICAgIGFyY2hpdGVjdHVyZSA9IGRlcGVuZHNfaGVscGVyLnBhcnNlX291dHB1dChkZXBlbmRzX3JlcG9ydF9maWxlLCAiezB9LyIuZm9ybWF0KHJlcG9zaXRvcnlfZGlyZWN0b3J5KSkKCiAgICAgICAgICAgIGlmIGFyY2hpdGVjdHVyZToKICAgICAgICAgICAgICAgIG1ldHJpY3MuaW5jcmVtZW50X21ldHJpYyhtZXRyaWNzX25hbWVzLkRFUEVORFNfQVJDSElURUNUVVJFX0ZPVU5EKQogICAgICAgICAgICAgICAgaW5zZXJ0X2FyY2hpdGVjdHVyZShkYiwgYW5hbHlzaXNfaWQsIGFyY2hpdGVjdHVyZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG1ldHJpY3MuaW5jcmVtZW50X21ldHJpYyhtZXRyaWNzX25hbWVzLkRFUEVORFNfQVJDSElURUNUVVJFX05PVF9GT1VORCkKICAgICAgICAgICAgICAgIGxvZ2dpbmcuaW5mbygiW0VYRUNVVE9SXSBbREVQRU5EU10gYXJjaGl0ZWN0dXJlIG5vdCBmb3VuZCBmb3IgYW5hbHlzaXMgJXMiLCBhbmFseXNpc19pZCkKCiAgICAgICAgZXhjZXB0IChBbmFseXNpc1Rvb2xUaW1lb3V0RXhjZXB0aW9uLCBzdWJwcm9jZXNzLlRpbWVvdXRFeHBpcmVkKToKICAgICAgICAgICAgdGFncy5hcHBlbmQoIkRFUEVORFNfVElNRU9VVCIpCiAgICAgICAgICAgIG1ldHJpY3MuaW5jcmVtZW50X21ldHJpYyhtZXRyaWNzX25hbWVzLkRFUEVORFNfRVhDRVBUSU9OX1RJTUVPVVQpCiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoIltFWEVDVVRPUl0gREVQRU5EUyAtIHRpbWVvdXQgZXhwaXJlZCBmb3IgYW5hbHlzaXMgJXMiLCBhbmFseXNpc19pZCkKICAgICAgICBleGNlcHQgc3VicHJvY2Vzcy5DYWxsZWRQcm9jZXNzRXJyb3I6CiAgICAgICAgICAgIHRhZ3MuYXBwZW5kKCJERVBFTkRTX0VSUk9SIikKICAgICAgICAgICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKG1ldHJpY3NfbmFtZXMuREVQRU5EU19DQUxMRURfUFJPQ0VTU19FUlJPUikKICAgICAgICAgICAgbG9nZ2luZy5lcnJvcigiW0VYRUNVVE9SXSBERVBFTkRTIC0gaXNzdWUgZm9yIGFuYWx5c2lzICVzIiwgYW5hbHlzaXNfaWQpCiAgICAgICAgZXhjZXB0IEluZGV4RXJyb3I6CiAgICAgICAgICAgIHRhZ3MuYXBwZW5kKCJERVBFTkRTX0VSUk9SIikKICAgICAgICAgICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKG1ldHJpY3NfbmFtZXMuREVQRU5EU19VTktOT1dOX0VSUk9SKQogICAgICAgICAgICBsb2dnaW5nLmVycm9yKCJbREVQRU5EU10gZmlsZSBjb250ZW50IikKICAgICAgICAgICAgbG9nZ2luZy5leGNlcHRpb24oIltFWEVDVVRPUl0gREVQRU5EUyAtIHVua25vd24gZXhjZXB0aW9uIGZvciBhbmFseXNpcyAlcyIsIGFuYWx5c2lzX2lkKQogICAgICAgIGRlcGVuZHNfbGFzdF90cyA9IHRpbWUudGltZSgpCiAgICAgICAgZGVwZW5kc19kdXJhdGlvbiA9IGRlcGVuZHNfbGFzdF90cyAtIGRlcGVuZHNfc3RhcnRfdHMKICAgICAgICBsb2dnaW5nLmRlYnVnKCJbRVhFQ1VUT1JdIERFUEVORFMgdG9vayAlcyBzZWMgdG8gZXhlY3V0b3IiLCBkZXBlbmRzX2R1cmF0aW9uKQogICAgcmV0dXJuIHRhZ3MKCgpkZWYgYW5hbHl6ZV9kZXBlbmRlbmNpZXMoYW5hbHlzaXNfaWQsIGRiLCByZXBvc2l0b3J5X2RpcmVjdG9yeSwgcHJvamVjdF9jb25maWd1cmF0aW9uKToKICAgICIiIgogICAgR2V0IGFsbCB0aGUgZGVwZW5kZW5jaWVzIGFuZCBhZGQgdGhlbSBpbiB0aGUgZGF0YWJhc2UKICAgIDpwYXJhbSBhbmFseXNpc19pZDogY3VycmVudCBhbmFseXNpcyBpZAogICAgOnBhcmFtIGRiOiB0aGUgY29ubmVjdGlvbiB0byB0aGUgZGF0YWJhc2UKICAgIDpwYXJhbSByZXBvc2l0b3J5X2RpcmVjdG9yeTogd2hlcmUgaXMgdGhlIHJlcG9zaXRvcnkKICAgIDpwYXJhbSBwcm9qZWN0X2NvbmZpZ3VyYXRpb246IHRoZSBwcm9qZWN0IGNvbmZpZ3VyYXRpb24KICAgIDpyZXR1cm46IGEgbGlzdCBvZiB0YWdzIGlmIGFueQogICAgIiIiCiAgICBkZWYgYnVpbGRfZmlsZW5hbWUoY29uZmlndXJhdGlvbl9maWxlbmFtZSwgZGVmYXVsdF9maWxlbmFtZSk6CiAgICAgICAgIiIiCiAgICAgICAgQnVpbGQgdGhlIGZpbGVuYW1lIHRvIGdldCB0aGUgY29uZmlndXJhdGlvbiBmaWxlLgogICAgICAgIDpwYXJhbSBjb25maWd1cmF0aW9uX2ZpbGVuYW1lOiB1c2VyLWRlZmluZWQgZmlsZSBzZXQgaW4gdGhlIGNvbmZpZ3VyYXRpb24uIGNhbiBiZSBOb25lIGlmIG5vdCBzZXQKICAgICAgICA6cGFyYW0gZGVmYXVsdF9maWxlbmFtZTogdGhlIGRlZmF1bHQgZmlsZSwgYWx3YXlzIHNldC4KICAgICAgICA6cmV0dXJuOiB0aGUgZmlsZW5hbWUgdG8gdXNlCiAgICAgICAgIiIiCiAgICAgICAgaWYgY29uZmlndXJhdGlvbl9maWxlbmFtZSBpcyBub3QgTm9uZSBhbmQgbGVuKGNvbmZpZ3VyYXRpb25fZmlsZW5hbWUpID4gMCBhbmQgIi4uIiBub3QgaW4gY29uZmlndXJhdGlvbl9maWxlbmFtZToKICAgICAgICAgICAgIyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgdXNlciBpcyBub3QgdHJ5aW5nIHRvIGdldCBvdGhlciBmaWxlcwogICAgICAgICAgICB0bXAgPSAiezB9L3sxfSIuZm9ybWF0KHJlcG9zaXRvcnlfZGlyZWN0b3J5LCBjb25maWd1cmF0aW9uX2ZpbGVuYW1lKQogICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZSh0bXApOgogICAgICAgICAgICAgICAgcmV0dXJuIHRtcAogICAgICAgIHJldHVybiAiezB9L3sxfSIuZm9ybWF0KHJlcG9zaXRvcnlfZGlyZWN0b3J5LCBkZWZhdWx0X2ZpbGVuYW1lKQoKICAgIHRhZ3MgPSBbXQogICAgZGVwZW5kZW5jaWVzOiBsaXN0W0RlcGVuZGVuY3ldID0gW10KICAgIGlmIGNvbmYuaXNfZW5hYmxlZChwcm9qZWN0X2NvbmZpZ3VyYXRpb24sIGNvbnN0YW50cy5FTkdJTkVfREVQRU5ERU5DWV9FTkFCTEVELCAidHJ1ZSIpOgogICAgICAgIGRlcGVuZGVuY2llcy5leHRlbmQocGFyc2VfcnVieV9nZW1maWxlKGJ1aWxkX2ZpbGVuYW1lKHByb2plY3RfY29uZmlndXJhdGlvbi5nZXQoY29uc3RhbnRzLlBST0pFQ1RfQ09ORklHVVJBVElPTl9SVUJZX0dFTUZJTEVfRklMRV9QQVRILCBOb25lKSwgY29uc3RhbnRzLkRFUEVOREVOQ1lfR0VNRklMRV9OQU1FKSkpCiAgICAgICAgZGVwZW5kZW5jaWVzLmV4dGVuZChwYXJzZV9weXRob25fcmVxdWlyZW1lbnRzKGJ1aWxkX2ZpbGVuYW1lKHByb2plY3RfY29uZmlndXJhdGlvbi5nZXQoY29uc3RhbnRzLlBST0pFQ1RfQ09ORklHVVJBVElPTl9QWVRIT05fUkVRVUlSRU1FTlRTX1BBVEgsIE5vbmUpLCBjb25zdGFudHMuREVQRU5ERU5DWV9QWVRIT05fUkVRVUlSRU1FTlRTX05BTUUpKSkKICAgICAgICBkZXBlbmRlbmNpZXMuZXh0ZW5kKHBhcnNlX3BocF9jb21wb3Nlcl9qc29uKGJ1aWxkX2ZpbGVuYW1lKHByb2plY3RfY29uZmlndXJhdGlvbi5nZXQoY29uc3RhbnRzLlBST0pFQ1RfQ09ORklHVVJBVElPTl9QSFBfQ09NUE9TRVJfSlNPTl9QQVRILCBOb25lKSwgY29uc3RhbnRzLkRFUEVOREVOQ1lfUEhQX0NPTVBPU0VSX0pTT05fTkFNRSkpKQogICAgICAgIGRlcGVuZGVuY2llcy5leHRlbmQocGFyc2VfamF2YXNjcmlwdF9wYWNrYWdlcyhidWlsZF9maWxlbmFtZShwcm9qZWN0X2NvbmZpZ3VyYXRpb24uZ2V0KGNvbnN0YW50cy5QUk9KRUNUX0NPTkZJR1VSQVRJT05fSkFWQVNDUklQVF9QQUNLQUdFX1BBVEgsIE5vbmUpLCBjb25zdGFudHMuREVQRU5ERU5DWV9KQVZBU0NSSVBUX1BBQ0tBR0VfTkFNRSkpKQogICAgICAgIGRlcGVuZGVuY2llcy5leHRlbmQocGFyc2VfcG9tKGJ1aWxkX2ZpbGVuYW1lKHByb2plY3RfY29uZmlndXJhdGlvbi5nZXQoY29uc3RhbnRzLlBST0pFQ1RfQ09ORklHVVJBVElPTl9KQVZBX1BPTV9GSUxFX1BBVEgsIE5vbmUpLCBjb25zdGFudHMuREVQRU5ERU5DWV9KQVZBX1BPTV9OQU1FKSkpCiAgICAgICAgZGVwZW5kZW5jaWVzLmV4dGVuZChwYXJzZV9zYnRfYnVpbGRfZmlsZShidWlsZF9maWxlbmFtZShwcm9qZWN0X2NvbmZpZ3VyYXRpb24uZ2V0KGNvbnN0YW50cy5QUk9KRUNUX0NPTkZJR1VSQVRJT05fU0JUX0JVSUxEX0ZJTEVfUEFUSCwgTm9uZSksIGNvbnN0YW50cy5ERVBFTkRFTkNZX1NCVF9CVUlMRF9OQU1FKSkpCiAgICAgICAgZGVwZW5kZW5jaWVzLmV4dGVuZChwYXJzZV9ncmFkbGVfa290bGluKGJ1aWxkX2ZpbGVuYW1lKHByb2plY3RfY29uZmlndXJhdGlvbi5nZXQoY29uc3RhbnRzLlBST0pFQ1RfQ09ORklHVVJBVElPTl9HUkFETEVfS09UTElOX0ZJTEVfUEFUSCwgTm9uZSksIGNvbnN0YW50cy5ERVBFTkRFTkNZX0dSQURMRV9LT1RMSU5fTkFNRSkpKQogICAgICAgIGRlcGVuZGVuY2llcy5leHRlbmQocGFyc2VfZ3JhZGxlX2phdmEoYnVpbGRfZmlsZW5hbWUocHJvamVjdF9jb25maWd1cmF0aW9uLmdldChjb25zdGFudHMuUFJPSkVDVF9DT05GSUdVUkFUSU9OX0dSQURMRV9KQVZBX0ZJTEVfUEFUSCwgTm9uZSksIGNvbnN0YW50cy5ERVBFTkRFTkNZX0dSQURMRV9KQVZBX05BTUUpKSkKCgogICAgICAgICMgTm93LCB1cGRhdGUgdGhlIGRlcGVuZGVuY3kgZGVzY3JpcHRpb24gaW4gdGhlIGRhdGFiYXNlIHRvIG1ha2Ugc3VyZSB0aGV5IGFyZSB1cCB0byBkYXRlLgogICAgICAgIGZvciBkZXBlbmRlbmN5IGluIGRlcGVuZGVuY2llczoKICAgICAgICAgICAgaWYgZGVwZW5kZW5jeS5sYW5ndWFnZSA9PSBjb25zdGFudHMuTEFOR1VBR0VfUFlUSE9OOgogICAgICAgICAgICAgICAgdXBkYXRlX3B5dGhvbl9wYWNrYWdlKGRiLCBkZXBlbmRlbmN5Lm5hbWUpCiAgICAgICAgICAgIGlmIGRlcGVuZGVuY3kubGFuZ3VhZ2UgPT0gY29uc3RhbnRzLkxBTkdVQUdFX0pBVkFTQ1JJUFQ6CiAgICAgICAgICAgICAgICB1cGRhdGVfamF2YXNjcmlwdF9kZXBlbmRlbmN5KGRiLCBkZXBlbmRlbmN5Lm5hbWUpCiAgICAgICAgICAgIGlmIGRlcGVuZGVuY3kubGFuZ3VhZ2UgPT0gY29uc3RhbnRzLkxBTkdVQUdFX0pBVkE6CiAgICAgICAgICAgICAgICB1cGRhdGVfcG9tX2RlcGVuZGVuY3koZGIsIGRlcGVuZGVuY3kubmFtZSkKICAgICAgICAgICAgaWYgZGVwZW5kZW5jeS5sYW5ndWFnZSA9PSBjb25zdGFudHMuTEFOR1VBR0VfUlVCWToKICAgICAgICAgICAgICAgIHVwZGF0ZV9nZW1zX2RlcGVuZGVuY3koZGIsIGRlcGVuZGVuY3kubmFtZSkKICAgICAgICAgICAgaWYgZGVwZW5kZW5jeS5sYW5ndWFnZSA9PSBjb25zdGFudHMuTEFOR1VBR0VfUEhQOgogICAgICAgICAgICAgICAgdXBkYXRlX3BocF9kZXBlbmRlbmN5KGRiLCBkZXBlbmRlbmN5Lm5hbWUpCiAgICAgICAgaW5zZXJ0X2FuYWx5c2lzX2RlcGVuZGVuY2llcyhkYiwgYW5hbHlzaXNfaWQsIGRlcGVuZGVuY2llcykKICAgIHJldHVybiB0YWdzCgoKZGVmIHNob3VsZF9za2lwKGNvbW1pdF9tZXNzYWdlLCBwcm9qZWN0X2NvbmZpZ3VyYXRpb24pOgogICAgIiIiCiAgICBkZWNpZGUgaWYgeW91IHNob3VsZCBza2lwIGFuIGFuYWx5c2lzIGJhc2VkIG9uIHRoZSBsYXRlc3QgY29tbWl0IG1lc3NhZ2UKICAgIDpwYXJhbSBjb21taXRfbWVzc2FnZTogdGhlIGNvbW1pdCBtZXNzYWdlCiAgICA6cGFyYW0gcHJvamVjdF9jb25maWd1cmF0aW9uOiB0aGUgcHJvamVjdCBjb25maWd1cmF0aW9uIHJldHJpZXZlZCBiZWZvcmUgYW5hbHlzaXMKICAgIDpyZXR1cm46IHRydWUgb2YgZmFsc2UgLSBpZiB3ZSBzaG91bGQgc2tpcAogICAgIiIiCgogICAgaWYgbm90IGNvbW1pdF9tZXNzYWdlOgogICAgICAgIHJldHVybiBGYWxzZQogICAgaWYgbm90IHByb2plY3RfY29uZmlndXJhdGlvbjoKICAgICAgICByZXR1cm4gRmFsc2UKICAgIGtleXdvcmRzID0gY29uZi5nZXRfYW5hbHlzaXNfc2tpcF9rZXl3b3Jkcyhwcm9qZWN0X2NvbmZpZ3VyYXRpb24pCiAgICBpZiBub3Qga2V5d29yZHM6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICBpZiBsZW4oa2V5d29yZHMpID09IDA6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICBmb3Iga2V5d29yZCBpbiBrZXl3b3JkczoKICAgICAgICBpZiBsZW4oa2V5d29yZCkgPiAwIGFuZCBrZXl3b3JkIGluIGNvbW1pdF9tZXNzYWdlOgogICAgICAgICAgICBsb2dnaW5nLmluZm8oIltzaG91bGRfc2tpcF0ga2V5d29yZCB7MH0gZm91bmQgaW4gY29tbWl0IG1lc3NhZ2UgezF9Ii5mb3JtYXQoa2V5d29yZCwgY29tbWl0X21lc3NhZ2UpKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgcmV0dXJuIEZhbHNlCgoKZGVmIGdldF9tYXhfYWxsb3dlZF9zbG9jc19mb3JfYW5hbHlzaXMoZGIsIGFuYWx5c2lzKToKICAgICIiIgogICAgR2V0IHRoZSBtYXggYWxsb3dlZCBzbG9jcyBmb3IgYW4gYW5hbHlzaXMsIGF0dGVtcHRpbmcgdG8gdGFrZSBpdCBmcm9tIHZhcmlvdXMgc291cmNlcwogICAgOnBhcmFtIGRiOgogICAgOnBhcmFtIGFuYWx5c2lzOgogICAgOnJldHVybjoKICAgICIiIgoKICAgIGlmIG5vdCBhbmFseXNpczoKICAgICAgICByZXR1cm4gY29uc3RhbnRzLk1BWF9TTE9DU19CQVNJQwoKICAgIHVzZXJfaWQgPSBhbmFseXNpc1sndXNlcl9pZCddCiAgICBwcm9qZWN0X2lkID0gYW5hbHlzaXNbJ3Byb2plY3RfaWQnXQoKICAgIG1heF9zbG9jcyA9IFtdCiAgICBtYXhfc2xvY3MuYXBwZW5kKGJhY2tlbmRfbGliLmRhdGFiYXNlLmFuYWx5c2lzX3N0YXRzLmdldF9tYXhfYWxsb3dlZF9zbG9jc19mb3JfdXNlcihkYiwgdXNlcl9pZCkpCgogICAgaWYgcHJvamVjdF9pZDoKICAgICAgICBwcm9qZWN0X2luZm8gPSBiYWNrZW5kX2xpYi5kYXRhYmFzZS5wcm9qZWN0LmdldF9wcm9qZWN0X2luZm8oZGIsIHByb2plY3RfaWQpCiAgICAgICAgaWYgcHJvamVjdF9pbmZvIGFuZCBwcm9qZWN0X2luZm9bJ2dyb3VwX2lkJ106CiAgICAgICAgICAgIG1heF9zbG9jcy5hcHBlbmQoCiAgICAgICAgICAgICAgICBiYWNrZW5kX2xpYi5kYXRhYmFzZS5hbmFseXNpc19zdGF0cy5nZXRfbWF4X2FsbG93ZWRfc2xvY3NfZm9yX2dyb3VwKGRiLCBwcm9qZWN0X2luZm9bJ2dyb3VwX2lkJ10pKQogICAgICAgIGlmIHByb2plY3RfaW5mbyBhbmQgcHJvamVjdF9pbmZvWyd1c2VyX2lkJ106CiAgICAgICAgICAgIG1heF9zbG9jcy5hcHBlbmQoCiAgICAgICAgICAgICAgICBiYWNrZW5kX2xpYi5kYXRhYmFzZS5hbmFseXNpc19zdGF0cy5nZXRfbWF4X2FsbG93ZWRfc2xvY3NfZm9yX3VzZXIoZGIsIHByb2plY3RfaW5mb1sndXNlcl9pZCddKSkKICAgIHJldHVybiBtYXgobWF4X3Nsb2NzKQoKCmRlZiBoYXNfdG9vX21hbnlfc2xvY3MoZGF0YWJhc2VfY29ubmVjdGlvbiwgYW5hbHlzaXMpOgogICAgIiIiCiAgICBJbmRpY2F0ZSBpZiBhbiBhbmFseXNpcyBoYXMgdG9vIG1hbnkgc2xvY3MuIFRoZSBhbmFseXNpcyBvYmplY3QgaXMgYSBkaWN0b25hcnkgcHVsbGVkIGZyb20gdGhlCiAgICBkYXRhYmFzZS4KICAgIDpwYXJhbSBkYXRhYmFzZV9jb25uZWN0aW9uOiBjb25uZWN0aW9uIHRvIHRoZSBkYXRhYmFzZQogICAgOnBhcmFtIGFuYWx5c2lzOiB0aGUgZGljdGlvbmFyeSB0aGF0IHJlcHJlc2VudCB0aGUgYW5hbHlzaXMuCiAgICA6cmV0dXJuOgogICAgIiIiCiAgICBpZiBhbmFseXNpcyBpcyBOb25lOgogICAgICAgIHJldHVybiBGYWxzZQoKICAgIGFuYWx5c2lzX2lkID0gYW5hbHlzaXNbImlkIl0KICAgIG1heF9hbGxvd2VkX3Nsb2NzID0gZ2V0X21heF9hbGxvd2VkX3Nsb2NzX2Zvcl9hbmFseXNpcyhkYXRhYmFzZV9jb25uZWN0aW9uLCBhbmFseXNpcykKCiAgICBzbG9jcyA9IGJhY2tlbmRfbGliLmRhdGFiYXNlLmFuYWx5c2lzX3N0YXRzLmdldF9zbG9jc19mb3JfYW5hbHlzaXMoZGF0YWJhc2VfY29ubmVjdGlvbiwgYW5hbHlzaXNfaWQpCgogICAgcmV0dXJuIHNsb2NzID4gbWF4X2FsbG93ZWRfc2xvY3MK";

    public static Map<String, String> FILES_TO_ANALYZE = Map.of(
        "db.py", DB_PY,
        "analysis.py", ANALYSIS_PY
    );

    public static Map<String, Integer> FILES_TO_VIOLATIONS = Map.of(
        "db.py", 21,
        "analysis.py", 27
    );


    ClassLoader classLoader = getClass().getClassLoader();
    private Logger log = Logger.getLogger("Test");

    @BeforeAll
    public static void init() {
    }

    @AfterAll
    public static void done() {

    }

    @Test
    @DisplayName("Execute rules on large files")
    public void testLargeFiles() throws IOException {
        long startMs = System.currentTimeMillis();


        try {
            List<AnalyzerRule> rules = getRulesFromFile("src/test/resources/rules.json");
            AnalyzerConfiguration configuration = new AnalyzerConfiguration(10000);

            Analyzer analyzer = new Analyzer(new ErrorReportingDummy(), new MetricsDummy(), configuration);

            FILES_TO_ANALYZE.forEach((fileName, fileContent) -> {
                try {
                    String decoded = new String(Base64.getDecoder().decode(fileContent.getBytes()));

                    AnalysisResult analysisResult = analyzer.analyze(Language.PYTHON, fileName, decoded, rules, false).get();
                    List<String> errors = analysisResult.ruleResults().stream().flatMap(r -> r.errors().stream()).collect(Collectors.toList());
                    List<Violation> violations = analysisResult.ruleResults().stream().flatMap(r -> r.violations().stream()).collect(Collectors.toList());
                    assertEquals(0, errors.size());
//                    assertEquals(FILES_TO_VIOLATIONS.get(fileName), violations.size());

                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                } catch (ExecutionException e) {
                    throw new RuntimeException(e);
                }
            });
        } catch (IOException e) {
            throw new RuntimeException(e);
        }

        long endMs = System.currentTimeMillis();
        long duration = endMs - startMs;
        log.info(String.format("time to complete: %s ms", duration));

    }

}

package io.codiga.analyzer.ast.languages.python;

import io.codiga.parser.python.gen.PythonLexer;
import io.codiga.parser.python.gen.PythonParser;
import org.antlr.v4.runtime.CharStreams;
import org.antlr.v4.runtime.CommonTokenStream;
import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.util.Base64;
import java.util.logging.Logger;

import static org.junit.jupiter.api.Assertions.assertEquals;

public class CodigaVisitorTest extends PythonTestUtils {

    private Logger log = Logger.getLogger("Test");

    @BeforeAll
    public static void init() {
    }

    @AfterAll
    public static void done() {

    }

    @Test
    @DisplayName("Parse long file")
    public void testLongFile() {
        String encodedCode = "aW1wb3J0IGxvZ2dpbmcKaW1wb3J0IG9zCmltcG9ydCBoYXNobGliCmltcG9ydCBzdWJwcm9jZXNzCmltcG9ydCB0aW1lCgppbXBvcnQgYmFja2VuZF9saWIuY29uZiBhcyBjb25mCmltcG9ydCBiYWNrZW5kX2xpYi5jb25zdGFudHMgYXMgY29uc3RhbnRzCmltcG9ydCBiYWNrZW5kX2xpYi5kYXRhYmFzZS5hbmFseXNpc19zdGF0cwppbXBvcnQgYmFja2VuZF9saWIuZGF0YWJhc2UucHJvamVjdAppbXBvcnQgYmFja2VuZF9saWIuZGIgYXMgZGF0YWJhc2UKCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMucG1kX2FwZXhfaGVscGVyIGFzIHBtZF9hcGV4X2hlbHBlcgppbXBvcnQgYmFja2VuZF9saWIuYW5hbHl6ZXJzLnBtZF9qYXZhX2hlbHBlciBhcyBwbWRfamF2YV9oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5iYW5kaXRfaGVscGVyIGFzIGJhbmRpdF9oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5jaGVja292X2RvY2tlciBhcyBjaGVja292X2RvY2tlcgppbXBvcnQgYmFja2VuZF9saWIuYW5hbHl6ZXJzLmNoZWNrb3ZfdGVycmFmb3JtIGFzIGNoZWNrb3ZfdGVycmFmb3JtCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMuY3BwY2hlY2tfaGVscGVyIGFzIGNwcGNoZWNrX2hlbHBlcgppbXBvcnQgYmFja2VuZF9saWIuYW5hbHl6ZXJzLmRhcnRfaGVscGVyIGFzIGRhcnRfaGVscGVyCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMuZGV0ZWN0X3NlY3JldHMgYXMgZGV0ZWN0X3NlY3JldHMKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5yZXZpdmVfaGVscGVyIGFzIHJldml2ZV9oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5saXphcmRfaGVscGVyIGFzIGxpemFyZF9oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5qc2NwZF9oZWxwZXIgYXMganNjcGRfaGVscGVyCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMuZ29zZWNfaGVscGVyIGFzIGdvc2VjX2hlbHBlcgppbXBvcnQgYmFja2VuZF9saWIuYW5hbHl6ZXJzLnJvc2llX2hlbHBlciBhcyByb3NpZV9oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5waHBtZF9oZWxwZXIgYXMgcGhwbWRfaGVscGVyCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMucHlsaW50X2hlbHBlciBhcyBweWxpbnRfaGVscGVyCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMucmVla19oZWxwZXIgYXMgcmVla19oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLmFuYWx5emVycy5zY2FsYXN0eWxlX2hlbHBlciBhcyBzY2FsYXN0eWxlX2hlbHBlcgppbXBvcnQgYmFja2VuZF9saWIuYW5hbHl6ZXJzLnNoZWxsY2hlY2tfaGVscGVyIGFzIHNoZWxsY2hlY2tfaGVscGVyCmltcG9ydCBiYWNrZW5kX2xpYi5hbmFseXplcnMueWFtbGxpbnRfaGVscGVyIGFzIHlhbWxsaW50X2hlbHBlcgppbXBvcnQgYmFja2VuZF9saWIuYW5hbHl6ZXJzLnN0YXRpY2NoZWNrX2hlbHBlciBhcyBzdGF0aWNjaGVja19oZWxwZXIKaW1wb3J0IGJhY2tlbmRfbGliLm1ldHJpY3MucmVwb3J0aW5nIGFzIG1ldHJpY3MKaW1wb3J0IGJhY2tlbmRfbGliLm1ldHJpY3MubmFtZXMgYXMgbWV0cmljc19uYW1lcwpmcm9tIGJhY2tlbmRfbGliLmFuYWx5emVycyBpbXBvcnQgZGV0ZWt0X2hlbHBlciwgZGVwZW5kc19oZWxwZXIsIGVzbGludF90eXBlc2NyaXB0X2hlbHBlciwgXAogICAgZXNsaW50X2phdmFzY3JpcHRfaGVscGVyLCBlc2xpbnRfZ2VuZXJpY19oZWxwZXIKZnJvbSBiYWNrZW5kX2xpYi5hbmFseXplcnMuZGVwZW5kZW5jaWVzX2hlbHBlciBpbXBvcnQgcGFyc2VfcnVieV9nZW1maWxlLCBwYXJzZV9weXRob25fcmVxdWlyZW1lbnRzLCBcCiAgICBwYXJzZV9qYXZhc2NyaXB0X3BhY2thZ2VzLCBwYXJzZV9wb20sIHBhcnNlX3BocF9jb21wb3Nlcl9qc29uLCBwYXJzZV9zYnRfYnVpbGRfZmlsZSwgcGFyc2VfZ3JhZGxlX2tvdGxpbiwgXAogICAgcGFyc2VfZ3JhZGxlX2phdmEKZnJvbSBiYWNrZW5kX2xpYi5hbmFseXplcnMuc2xvY2NvdW50IGltcG9ydCBMQU5HVUFHRVNfRVhURU5TSU9OUywgTEFOR1VBR0VTX1RPX0NPTlNUQU5UUwpmcm9tIGJhY2tlbmRfbGliLmNvbmZpZ3VyYXRpb24gaW1wb3J0IGlzX2RlY2lkZXJfZW5hYmxlZApmcm9tIGJhY2tlbmRfbGliLmRhdGFiYXNlLmFuYWx5c2lzX3RpbWUgaW1wb3J0IGFkZF9hbmFseXNpc19zdGVwX3J1bm5pbmdfdGltZQpmcm9tIGJhY2tlbmRfbGliLmRhdGFiYXNlLmFyY2hpdGVjdHVyZSBpbXBvcnQgaW5zZXJ0X2FyY2hpdGVjdHVyZQpmcm9tIGJhY2tlbmRfbGliLmRhdGFiYXNlLmRlcGVuZGVuY3kgaW1wb3J0IGluc2VydF9hbmFseXNpc19kZXBlbmRlbmNpZXMKZnJvbSBiYWNrZW5kX2xpYi5kYXRhYmFzZS5maWxlX2FuYWx5c2lzX3Zpb2xhdGlvbiBpbXBvcnQgY3JlYXRlX2ZpbGVfYW5hbHlzaXNfdmlvbGF0aW9uCmZyb20gYmFja2VuZF9saWIuZGF0YWJhc2UucnVsZXMgaW1wb3J0IGdldF9hbGxfcnVsZXMKZnJvbSBiYWNrZW5kX2xpYi5kZWNpZGVycyBpbXBvcnQgREVDSURFUl9FWEVDVVRPUl9GSUxURVJfUlVMRVNfRlJPTV9EQVRBQkFTRSwgXAogICAgREVDSURFUl9FWEVDVVRPUl9GSUxURVJfUlVMRVNfV0lUSF9UTVBfRlJPTV9EQVRBQkFTRQpmcm9tIGJhY2tlbmRfbGliLm1vZGVsLmFuYWx5c2lzX2NvbnRleHQgaW1wb3J0IEFuYWx5c2lzQ29udGV4dApmcm9tIGJhY2tlbmRfbGliLm1vZGVsLmRlcGVuZGVuY3kgaW1wb3J0IERlcGVuZGVuY3kKZnJvbSBiYWNrZW5kX2xpYi5tb2RlbC5maWxlX2FuYWx5c2lzX3Zpb2xhdGlvbiBpbXBvcnQgRmlsZUFuYWx5c2lzVmlvbGF0aW9uCmZyb20gYmFja2VuZF9saWIubW9kZWwucnVsZSBpbXBvcnQgZmlsdGVyX3Zpb2xhdGlvbnNfd2l0aF9ydWxlcwpmcm9tIGJhY2tlbmRfbGliLm1vZGVsLnZpb2xhdGlvbiBpbXBvcnQgVmlvbGF0aW9uLCBmaWx0ZXJfdmlvbGF0aW9uc19zdGFydF93aXRoX3RtcApmcm9tIGJhY2tlbmRfbGliLnBpcGVsaW5lX2NvbmZpZ3VyYXRpb24gaW1wb3J0IFBpcGVsaW5lTW9kZQpmcm9tIGJhY2tlbmRfbGliLnV0aWxzLmRlcGVuZGVuY3kuamF2YXNjcmlwdCBpbXBvcnQgdXBkYXRlX2phdmFzY3JpcHRfZGVwZW5kZW5jeQpmcm9tIGJhY2tlbmRfbGliLnV0aWxzLmRlcGVuZGVuY3kucGhwIGltcG9ydCB1cGRhdGVfcGhwX2RlcGVuZGVuY3kKZnJvbSBiYWNrZW5kX2xpYi51dGlscy5kZXBlbmRlbmN5LnBvbSBpbXBvcnQgdXBkYXRlX3BvbV9kZXBlbmRlbmN5CmZyb20gYmFja2VuZF9saWIudXRpbHMuZGVwZW5kZW5jeS5weXRob24gaW1wb3J0IHVwZGF0ZV9weXRob25fcGFja2FnZQpmcm9tIGJhY2tlbmRfbGliLnV0aWxzLmRlcGVuZGVuY3kucnVieSBpbXBvcnQgdXBkYXRlX2dlbXNfZGVwZW5kZW5jeQpmcm9tIGJhY2tlbmRfbGliLnV0aWxzLnJlcG9zaXRvcnlfdXRpbHMgaW1wb3J0IHJlYWRfbGluZV9mcm9tX3JlcG9zaXRvcnkKCgpjbGFzcyBBbmFseXNpc1Rvb2xFeGVjdXRpb25FeGNlcHRpb24oRXhjZXB0aW9uKToKICAgICIiIgogICAgRXhjZXB0aW9uIHVzZWQgd2hlbiB0aGUgdG9vbCBkb2VzIHN1Y2NlZWQgdG8gZXhlY3V0ZS4KICAgIFRoaXMgaXMgY2F1Z2h0IGxhdGVyIHRvIHN1cmZhY2UgcG90ZW50aWFsIGVycm9ycy4KICAgICIiIgogICAgcGFzcwoKCmNsYXNzIEFuYWx5c2lzVG9vbDoKICAgICIiIgogICAgRGF0YSBzdHJ1Y3R1cmUgdGhhdCBjYXB0dXJlIGFsbCB0aGUgbmVjZXNzYXJ5IGFydGlmYWN0cyB0byBleGVjdXRlIGFuIGFuYWx5c2lzLgogICAgIiIiCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZSwgdG9vbF9uYW1lLCBsYW5ndWFnZXMsIGVuYWJsZWRfY29uc3RhbnRzLCBleGVjdXRlX2Z1bmN0aW9uLCBwYXJzZV9mdW5jdGlvbik6CiAgICAgICAgc2VsZi5uYW1lID0gbmFtZQogICAgICAgIHNlbGYudG9vbF9uYW1lID0gdG9vbF9uYW1lCiAgICAgICAgc2VsZi5sYW5ndWFnZXMgPSBsYW5ndWFnZXMKICAgICAgICBzZWxmLmVuYWJsZWRfY29uc3RhbnRzID0gZW5hYmxlZF9jb25zdGFudHMKICAgICAgICBzZWxmLmV4ZWN1dGVfZnVuY3Rpb24gPSBleGVjdXRlX2Z1bmN0aW9uCiAgICAgICAgc2VsZi5wYXJzZV9mdW5jdGlvbiA9IHBhcnNlX2Z1bmN0aW9uCgogICAgZGVmIGRlY2lkZXJfa2V5X2Rpc2FibGVkKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFJldHVybiBhIGtleSB0byBkaXNhYmxlIGEgdG9vbAogICAgICAgIDpyZXR1cm46CiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYudG9vbF9uYW1lLmxvd2VyKCkgKyAiLWRpc2FibGVkIgoKCnByb2plY3RfYW5hbHlzaXNfdG9vbHMgPSBbCiAgICBBbmFseXNpc1Rvb2woIkFwZXgiLCAicG1kIiwgWyJhcGV4Il0sIFtjb25zdGFudHMuRU5HSU5FX0FQRVhfRU5BQkxFRF0sIHBtZF9hcGV4X2hlbHBlci5leGVjdXRlX3BtZCwgcG1kX2FwZXhfaGVscGVyLnBhcnNlX3BtZF9vdXRwdXQpLAogICAgQW5hbHlzaXNUb29sKCJCYW5kaXQiLCAiYmFuZGl0IiwgWyJweXRob24iXSwgW2NvbnN0YW50cy5FTkdJTkVfUFlUSE9OX0VOQUJMRURdLCBiYW5kaXRfaGVscGVyLmV4ZWN1dGUsIGJhbmRpdF9oZWxwZXIucGFyc2Vfb3V0cHV0KSwKICAgIEFuYWx5c2lzVG9vbCgiQy9DKysiLCAiY3BwY2hlY2siLCBbImMiLCAiY3BwIl0sIFtjb25zdGFudHMuRU5HSU5FX0NfRU5BQkxFRCwgY29uc3RhbnRzLkVOR0lORV9DUFBfRU5BQkxFRF0sIGNwcGNoZWNrX2hlbHBlci5leGVjdXRlLCBjcHBjaGVja19oZWxwZXIucGFyc2Vfb3V0cHV0KSwKICAgIEFuYWx5c2lzVG9vbCgiQ2hlY2tvdiIsICJjaGVja292LWRvY2tlciIsIExBTkdVQUdFU19FWFRFTlNJT05TLmtleXMoKSwgW2NvbnN0YW50cy5FTkdJTkVfRE9DS0VSX0VOQUJMRURdLCBjaGVja292X2RvY2tlci5leGVjdXRlLCBjaGVja292X2RvY2tlci5wYXJzZV9vdXRwdXQpLAogICAgQW5hbHlzaXNUb29sKCJDaGVja292IiwgImNoZWNrb3YtdGVycmFmb3JtIiwgWyJ0ZXJyYWZvcm0iXSwgW2NvbnN0YW50cy5FTkdJTkVfVEVSUkFGT1JNX0VOQUJMRURdLCBjaGVja292X3RlcnJhZm9ybS5leGVjdXRlLCBjaGVja292X3RlcnJhZm9ybS5wYXJzZV9vdXRwdXQpLAogICAgQW5hbHlzaXNUb29sKCJEZXRla3QiLCAiZGV0ZWt0IiwgWyJrb3RsaW4iXSwgW2NvbnN0YW50cy5FTkdJTkVfS09UTElOX0VOQUJMRURdLCBkZXRla3RfaGVscGVyLmV4ZWN1dGUsIGRldGVrdF9oZWxwZXIucGFyc2Vfb3V0cHV0KSwKICAgIEFuYWx5c2lzVG9vbCgiRGFydCIsICJkYXJ0YW5hbHl6ZXIiLCBbImRhcnQiXSwgW2NvbnN0YW50cy5FTkdJTkVfREFSVF9FTkFCTEVEXSwgZGFydF9oZWxwZXIuZXhlY3V0ZSwgZGFydF9oZWxwZXIucGFyc2Vfb3V0cHV0KSwKICAgIEFuYWx5c2lzVG9vbCgiRGV0ZWN0U2VjcmV0cyIsICJkZXRlY3Qtc2VjcmV0cyIsIExBTkdVQUdFU19FWFRFTlNJT05TLmtleXMoKSwgW2NvbnN0YW50cy5FTkdJTkVfREVURUNUX1NFQ1JFVFNfRU5BQkxFRF0sIGRldGVjdF9zZWNyZXRzLmV4ZWN1dGUsIGRldGVjdF9zZWNyZXRzLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woIkVzbGludCIsICJlc2xpbnQtamF2YXNjcmlwdCIsIFsiamF2YXNjcmlwdCJdLCBbY29uc3RhbnRzLkVOR0lORV9KQVZBU0NSSVBUX0VOQUJMRURdLCBlc2xpbnRfamF2YXNjcmlwdF9oZWxwZXIuZXhlY3V0ZSwgZXNsaW50X2dlbmVyaWNfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woIkVzbGludCIsICJlc2xpbnQtdHlwZXNjcmlwdCIsIFsidHlwZXNjcmlwdCJdLCBbY29uc3RhbnRzLkVOR0lORV9UWVBFU0NSSVBUX0VOQUJMRURdLCBlc2xpbnRfdHlwZXNjcmlwdF9oZWxwZXIuZXhlY3V0ZSwgZXNsaW50X2dlbmVyaWNfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woIkphdmEiLCAicG1kIiwgWyJqYXZhIl0sIFtjb25zdGFudHMuRU5HSU5FX0pBVkFfRU5BQkxFRF0sIHBtZF9qYXZhX2hlbHBlci5leGVjdXRlX3BtZCwgcG1kX2phdmFfaGVscGVyLnBhcnNlX3BtZF9vdXRwdXQpLAogICAgIyBBbmFseXNpc1Rvb2woIkdvIiwgImdvbGludCIsIFsiZ28iXSwgW2NvbnN0YW50cy5FTkdJTkVfR09fRU5BQkxFRF0sIGdvbGludF9oZWxwZXIuZXhlY3V0ZSwgZ29saW50X2hlbHBlci5wYXJzZV9vdXRwdXQpLAogICAgQW5hbHlzaXNUb29sKCJHb1Jldml2ZSIsICJyZXZpdmUiLCBbImdvIl0sIFtjb25zdGFudHMuRU5HSU5FX0dPX0VOQUJMRURdLCByZXZpdmVfaGVscGVyLmV4ZWN1dGUsIHJldml2ZV9oZWxwZXIucGFyc2Vfb3V0cHV0KSwKICAgIEFuYWx5c2lzVG9vbCgiR29TdGF0aWNjaGVjayIsICJzdGF0aWNjaGVjayIsIFsiZ28iXSwgW2NvbnN0YW50cy5FTkdJTkVfR09fRU5BQkxFRF0sIHN0YXRpY2NoZWNrX2hlbHBlci5leGVjdXRlLCBzdGF0aWNjaGVja19oZWxwZXIucGFyc2Vfb3V0cHV0KSwKICAgIEFuYWx5c2lzVG9vbCgiR29TZWMiLCAiZ29zZWMiLCBbImdvIl0sIFtjb25zdGFudHMuRU5HSU5FX0dPX0VOQUJMRURdLCBnb3NlY19oZWxwZXIuZXhlY3V0ZSwgZ29zZWNfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woIlJvc2llIiwgInJvc2llIiwgWyJnbyIsICJweXRob24iLCAiamF2YSIsICJjc2hhcnAiXSwgW2NvbnN0YW50cy5FTkdJTkVfUk9TSUVfRU5BQkxFRF0sIHJvc2llX2hlbHBlci5leGVjdXRlLCByb3NpZV9oZWxwZXIucGFyc2Vfb3V0cHV0KSwKICAgICMgVG9vIG1hbnkgZmFsc2UgcG9zaXRpdmUKICAgICMgQW5hbHlzaXNUb29sKCJGbGF3ZmluZGVyIiwgImZsYXdmaW5kZXIiLCBbImMiLCAiY3BwIl0sIFtjb25zdGFudHMuRU5HSU5FX0NfRU5BQkxFRF0sIGZsYXdmaW5kZXJfaGVscGVyLmV4ZWN1dGUsIGZsYXdmaW5kZXJfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICAjIEFuYWx5c2lzVG9vbCgiSlNIaW50IiwgImpzaGludCIsIFsiamF2YXNjcmlwdCJdLCBbY29uc3RhbnRzLkVOR0lORV9KQVZBU0NSSVBUX0VOQUJMRURdLCBqc2hpbnRfaGVscGVyLmV4ZWN1dGUsIGpzaGludF9oZWxwZXIucGFyc2Vfb3V0cHV0KSwKICAgICMgRGVhY3RpdmF0ZWQgZm9yIG5vdwogICAgIyBBbmFseXNpc1Rvb2woIkZsb3ciLCAiZmxvdyIsIFsiamF2YXNjcmlwdCJdLCBbY29uc3RhbnRzLkVOR0lORV9KQVZBU0NSSVBUX0ZMT1dfRU5BQkxFRF0sIGZsb3dfaGVscGVyLmV4ZWN1dGUsIGZsb3dfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICAjIERlc2FjdGl2YXRlZCwgaXQncyBtb3N0bHkgYWJvdXQgc3R5bGUKICAgICMgQW5hbHlzaXNUb29sKCJQSFBDUyIsICJwaHBjcyIsIFsicGhwIl0sIFtjb25zdGFudHMuRU5HSU5FX1BIUF9FTkFCTEVEXSwgcGhwY3NfaGVscGVyLmV4ZWN1dGUsIHBocGNzX2hlbHBlci5wYXJzZV9vdXRwdXQpLAoKICAgIEFuYWx5c2lzVG9vbCgiUEhQTUQiLCAicGhwbWQiLCBbInBocCJdLCBbY29uc3RhbnRzLkVOR0lORV9QSFBfRU5BQkxFRF0sIHBocG1kX2hlbHBlci5leGVjdXRlLCBwaHBtZF9oZWxwZXIucGFyc2Vfb3V0cHV0KSwKICAgIEFuYWx5c2lzVG9vbCgiUHlsaW50IiwgInB5bGludCIsIFsicHl0aG9uIl0sIFtjb25zdGFudHMuRU5HSU5FX1BZVEhPTl9FTkFCTEVEXSwgcHlsaW50X2hlbHBlci5leGVjdXRlLCBweWxpbnRfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woIlJlZWsiLCAicmVlayIsIFsicnVieSJdLCBbY29uc3RhbnRzLkVOR0lORV9SVUJZX0VOQUJMRURdLCByZWVrX2hlbHBlci5leGVjdXRlLCByZWVrX2hlbHBlci5wYXJzZV9vdXRwdXQpLAogICAgQW5hbHlzaXNUb29sKCJTY2FsYSIsICJzY2FsYXN0eWxlIiwgWyJzY2FsYSJdLCBbY29uc3RhbnRzLkVOR0lORV9TQ0FMQV9FTkFCTEVEXSwgc2NhbGFzdHlsZV9oZWxwZXIuZXhlY3V0ZSwgc2NhbGFzdHlsZV9oZWxwZXIucGFyc2Vfb3V0cHV0KSwKICAgIEFuYWx5c2lzVG9vbCgiU2hlbGwiLCAic2hlbGxjaGVjayIsIFsic2hlbGwiXSwgW2NvbnN0YW50cy5FTkdJTkVfU0hFTExTQ1JJUFRfRU5BQkxFRF0sIHNoZWxsY2hlY2tfaGVscGVyLmV4ZWN1dGUsIHNoZWxsY2hlY2tfaGVscGVyLnBhcnNlX291dHB1dCksCiAgICBBbmFseXNpc1Rvb2woInlhbWxsaW50IiwgInlhbWxsaW50IiwgWyJ5YW1sIl0sIFtjb25zdGFudHMuRU5HSU5FX1lBTUxfRU5BQkxFRF0sIHlhbWxsaW50X2hlbHBlci5leGVjdXRlLCB5YW1sbGludF9oZWxwZXIucGFyc2Vfb3V0cHV0KSwKXQoKCgpkZWYgZXhlY3V0ZV9hbmFseXNpc190b29sKGFuYWx5c2lzX3Rvb2wsIGNvbmZpZ19maWxlLCB3b3JraW5nX2RpcmVjdG9yeSwgcmVwb3NpdG9yeV9kaXJlY3RvcnksCiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvamVjdF9jb25maWd1cmF0aW9uLCBzbG9jc19wZXJfbGFuZ3VhZ2UsIHBpcGVsaW5lX2NvbmZpZ3VyYXRpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YWJhc2VfY29ubmVjdGlvbj1Ob25lLCBhbmFseXNpc19pZD1Ob25lKToKICAgICIiIgogICAgRXhlY3V0ZSBvbmUgYW5hbHlzaXMgdG9vbCB0aGF0IGlzIHJlcHJlc2VudGVkIGJ5IGFuIEFuYWx5c2lzIG9iamVjdC4KICAgIDpwYXJhbSBhbmFseXNpc19pZDogaWRlbnRpZmllciBvZiB0aGUgYW5hbHlzaXMKICAgIDpwYXJhbSBkYXRhYmFzZV9jb25uZWN0aW9uOiBjb25uZWN0aW9uIHRvIHRoZSBkYXRhYmFzZQogICAgOnBhcmFtIGFuYWx5c2lzX3Rvb2w6IHRoZSB2YWx1ZSBvZiB0aGUgQW5hbHlzaXMgb2JqZWN0IHRvIGJlIHByb2Nlc3NlZAogICAgOnBhcmFtIGNvbmZpZ19maWxlOiBjb25maWd1cmF0aW9uIGZpbGUgZm9yIHRoZSBleGVjdXRvciAodXNlZCB0byBmaW5kIHRoZSBiaW5hcnkgb2YgdGhlIHRvb2wpCiAgICA6cGFyYW0gd29ya2luZ19kaXJlY3Rvcnk6IHdvcmtpbmcgZGlyZWN0b3J5IHdoZXJlIHdlIGNhbiBjcmVhdGUgdGVtcG9yYXJ5IGZpbGVzLgogICAgOnBhcmFtIHJlcG9zaXRvcnlfZGlyZWN0b3J5OiB3aGVyZSB0aGUgcmVwb3NpdG9yeSBkYXRhIGhhcyBiZWVuIGNsb25lZC4KICAgIDpwYXJhbSBwcm9qZWN0X2NvbmZpZ3VyYXRpb246IHRoZSBwcm9qZWN0IGNvbmZpZ3VyYXRpb24gKGRpY3Rpb25hcnkpCiAgICA6cGFyYW0gc2xvY3NfcGVyX2xhbmd1YWdlOiBkaWN0aW9uYXJ5IHRoYXQgZ2l2ZXMgdGhlIG51bWJlciBvZiBMT0MgcGVyIGxhbmd1YWdlLgogICAgOnBhcmFtIHBpcGVsaW5lX2NvbmZpZ3VyYXRpb246IHRoZSBwaXBlbGluZSBiZWluZyBydW4vZXhlY3V0ZWQKICAgIDpyZXR1cm46CiAgICAiIiIKICAgIHZpb2xhdGlvbnMgPSBbXQoKICAgICMgU3RlcCAxOiBjaGVjayBpZiB0aGUgdG9vbCBpcyBkaXNhYmxlZCBvciBub3QgaW4gdGhlIHByb2plY3QgY29uZmlndXJhdGlvbi4KICAgIGlzX2VuYWJsZWQgPSBGYWxzZQogICAgZm9yIGFuYWx5c2lzX3Rvb2xfY29uc3RhbnQgaW4gYW5hbHlzaXNfdG9vbC5lbmFibGVkX2NvbnN0YW50czoKICAgICAgICBpZiBjb25mLmlzX2VuYWJsZWQocHJvamVjdF9jb25maWd1cmF0aW9uLCBhbmFseXNpc190b29sX2NvbnN0YW50LCAidHJ1ZSIpOgogICAgICAgICAgICBpc19lbmFibGVkID0gVHJ1ZQoKICAgIGlmIG5vdCBpc19lbmFibGVkOgogICAgICAgIGxvZ2dpbmcuaW5mbygiQW5hbHlzaXMgJXMgaXMgZGlzYWJsZWQiLCBhbmFseXNpc190b29sLm5hbWUpCiAgICAgICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKCJ0b29sX3swfV9kaXNhYmxlZCIuZm9ybWF0KGFuYWx5c2lzX3Rvb2wudG9vbF9uYW1lKSkKICAgICAgICByZXR1cm4gdmlvbGF0aW9ucwoKCiAgICAjIFN0ZXAgMjogY2hlY2sgaWYgdGhlIHRvb2wgaGFzIGZpbGVzIHRoYXQgYXJlIHN1cHBvcnRlZCBieSB0aGlzIGFuYWx5c2lzLCBkbyB0aGF0IG9ubHkgaWYgd2UgaGF2ZSBhIHByb2plY3QKICAgICMgYW5hbHlzaXMuIEZvciBhIGZpbGUgYW5hbHlzaXMsIHRoZSB1c2VyIGFscmVhZHkgc3BlY2lmeSB0aGUgbGFuZ3VhZ2UgYW5kIHdlIGV4ZWN1dGUgb25seSB0aGUgdG9vbCB3ZSByZWFsbHkKICAgICMgV2FudCBvciBuZWVkLgogICAgaWYgcGlwZWxpbmVfY29uZmlndXJhdGlvbi5tb2RlID09IFBpcGVsaW5lTW9kZS5QUk9KRUNUX0FOQUxZU0lTOgogICAgICAgIGhhc19zbG9jcyA9IEZhbHNlCiAgICAgICAgZm9yIGxhbmd1YWdlIGluIGFuYWx5c2lzX3Rvb2wubGFuZ3VhZ2VzOgogICAgICAgICAgICBpZiBsYW5ndWFnZSBpbiBzbG9jc19wZXJfbGFuZ3VhZ2UgYW5kIHNsb2NzX3Blcl9sYW5ndWFnZVtsYW5ndWFnZV0gPiAwOgogICAgICAgICAgICAgICAgaGFzX3Nsb2NzID0gVHJ1ZQoKICAgICAgICBpZiBub3QgaGFzX3Nsb2NzOgogICAgICAgICAgICBsb2dnaW5nLmRlYnVnKCJObyBmaWxlIHdpdGggZm9yIHRvb2wgJXMiLCBhbmFseXNpc190b29sLnRvb2xfbmFtZSkKICAgICAgICAgICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKCJ0b29sX3swfV9ub3Nsb2MiLmZvcm1hdChhbmFseXNpc190b29sLnRvb2xfbmFtZSkpCiAgICAgICAgICAgIHJldHVybiB2aW9sYXRpb25zCgogICAgIyBTdGVwIDM6IGV4ZWN1dGUgdGhlIHRvb2wuCiAgICBtZXRyaWNzLmluY3JlbWVudF9tZXRyaWMoInRvb2xfezB9X2V4ZWN1dGVkIi5mb3JtYXQoYW5hbHlzaXNfdG9vbC50b29sX25hbWUpKQogICAgYW5hbHlzaXNfcmVzdWx0c19maWxlID0gInswfS97MX0tcmVzdWx0cyIuZm9ybWF0KHdvcmtpbmdfZGlyZWN0b3J5LCBhbmFseXNpc190b29sLnRvb2xfbmFtZSkKICAgIGxvZ2dpbmcuaW5mbygKICAgICAgICAiW2V4ZWN1dGVfYW5hbHlzaXNfdG9vbF0gZXhlY3V0aW5nIHRvb2wgJXMgaW4gJXMsIHJlc3VsdCBmaWxlOiAlcyIsCiAgICAgICAgYW5hbHlzaXNfdG9vbC50b29sX25hbWUsCiAgICAgICAgd29ya2luZ19kaXJlY3RvcnksCiAgICAgICAgYW5hbHlzaXNfcmVzdWx0c19maWxlKQoKICAgIGlmIG5vdCBwcm9qZWN0X2NvbmZpZ3VyYXRpb246CiAgICAgICAgcHJvamVjdF9jb25maWd1cmF0aW9uID0ge30KCiAgICAjIEFkZCB0aGUgd29ya2luZyBkaXJlY3RvcnkgYXMgYSBrZXkgdG8gdGhlIGNvbmZpZ3VyYXRpb24uCiAgICBwcm9qZWN0X2NvbmZpZ3VyYXRpb25bY29uc3RhbnRzLlBST0pFQ1RfQ09ORklHVVJBVElPTl9XT1JLSU5HX0RJUkVDVE9SWV9LRVldID0gd29ya2luZ19kaXJlY3RvcnkKICAgIHByb2plY3RfY29uZmlndXJhdGlvbltjb25zdGFudHMuUFJPSkVDVF9DT05GSUdVUkFUSU9OX1BJUEVMSU5FX01PREVfS0VZXSA9IHBpcGVsaW5lX2NvbmZpZ3VyYXRpb24ubW9kZQoKICAgIGFuYWx5c2lzX2NvbnRleHQ6IEFuYWx5c2lzQ29udGV4dCA9IEFuYWx5c2lzQ29udGV4dChkYXRhYmFzZV9jb25uZWN0aW9uPWRhdGFiYXNlX2Nvbm5lY3Rpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5hbHlzaXNfaWQ9YW5hbHlzaXNfaWQpCgogICAgaWYgbm90IGFuYWx5c2lzX3Rvb2wuZXhlY3V0ZV9mdW5jdGlvbihjb25maWdfZmlsZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwb3NpdG9yeV9kaXJlY3RvcnksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuYWx5c2lzX3Jlc3VsdHNfZmlsZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvamVjdF9jb25maWd1cmF0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmFseXNpc19jb250ZXh0KToKICAgICAgICByYWlzZSBBbmFseXNpc1Rvb2xFeGVjdXRpb25FeGNlcHRpb24oYW5hbHlzaXNfdG9vbC5uYW1lKQoKICAgIGlmIG9zLnBhdGguaXNmaWxlKGFuYWx5c2lzX3Jlc3VsdHNfZmlsZSk6CiAgICAgICAgdmlvbGF0aW9ucyA9IGFuYWx5c2lzX3Rvb2wucGFyc2VfZnVuY3Rpb24oYW5hbHlzaXNfcmVzdWx0c19maWxlLCAiezB9LyIuZm9ybWF0KHJlcG9zaXRvcnlfZGlyZWN0b3J5KSkKICAgIG1ldHJpY3MuaW5jcmVtZW50X21ldHJpY192YWx1ZSgidG9vbF97MH1fdmlvbGF0aW9ucyIuZm9ybWF0KGFuYWx5c2lzX3Rvb2wudG9vbF9uYW1lKSwgbGVuKHZpb2xhdGlvbnMpKQogICAgcmV0dXJuIHZpb2xhdGlvbnMKCgpkZWYgYWRkX2NvZGVoYXNoX3RvX3Zpb2xhdGlvbnModmlvbGF0aW9ucywgcmVwb3NpdG9yeV9kaXJlY3RvcnkpOgogICAgIiIiCiAgICBhZGQgYSBoYXNoIHRvIGVhY2ggdmlvbGF0aW9uIGJlZm9yZSBpbnNlcnRpbmcgdGhlbSBpbiB0aGUgZGF0YWJhc2UKICAgIDpwYXJhbSB2aW9sYXRpb25zOiBsaXN0IG9mIHZpb2xhdGlvbnMgdG8gYWRkIGEgY29kZWhhc2gKICAgIDpwYXJhbSByZXBvc2l0b3J5X2RpcmVjdG9yeTogdGhlIGRpcmVjdG9yeSBvZiB0aGUgcmVwb3NpdG9yeSB3aGVyZSBpcyB0aGUgY29kZQogICAgOnJldHVybjogYSBuZXcgbGlzdCBvZiB2aW9sYXRpb25zIHRoYXQgY29udGFpbnMgdGhlIGNvZGVoYXNoCiAgICAiIiIKICAgIHJlcyA9IFtdCiAgICBmb3IgdmlvbGF0aW9uIGluIHZpb2xhdGlvbnM6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBsaW5lX2NvbnRlbnQgPSByZWFkX2xpbmVfZnJvbV9yZXBvc2l0b3J5KHJlcG9zaXRvcnlfZGlyZWN0b3J5LCB2aW9sYXRpb24uZmlsZW5hbWUsIHZpb2xhdGlvbi5saW5lKQogICAgICAgICAgICBpZiBsaW5lX2NvbnRlbnQ6CiAgICAgICAgICAgICAgICBjb2RlX2hhc2ggPSBoYXNobGliLm1kNShsaW5lX2NvbnRlbnQuZW5jb2RlKCkpLmhleGRpZ2VzdCgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBjb2RlX2hhc2ggPSBOb25lCiAgICAgICAgZXhjZXB0IFVuaWNvZGVEZWNvZGVFcnJvcjoKICAgICAgICAgICAgbG9nZ2luZy53YXJuaW5nKCJbYWRkX2NvZGVoYXNoX3RvX3Zpb2xhdGlvbnNdIGNhbm5vdCByZWFkIGxpbmUgaW4gcmVwb3NpdG9yeSIpCiAgICAgICAgICAgIGNvZGVfaGFzaCA9IE5vbmUKCiAgICAgICAgbmV3X3Zpb2xhdGlvbiA9IFZpb2xhdGlvbigKICAgICAgICAgICAgdmlvbGF0aW9uLmZpbGVuYW1lLAogICAgICAgICAgICB2aW9sYXRpb24ubGluZSwKICAgICAgICAgICAgdmlvbGF0aW9uLmRlc2NyaXB0aW9uLAogICAgICAgICAgICB2aW9sYXRpb24uc2V2ZXJpdHksCiAgICAgICAgICAgIHZpb2xhdGlvbi5jYXRlZ29yeSwKICAgICAgICAgICAgdmlvbGF0aW9uLmxpbmVfY291bnQsCiAgICAgICAgICAgIHRvb2w9dmlvbGF0aW9uLnRvb2wsCiAgICAgICAgICAgIGxhbmd1YWdlPXZpb2xhdGlvbi5sYW5ndWFnZSwKICAgICAgICAgICAgcnVsZT12aW9sYXRpb24ucnVsZSwKICAgICAgICAgICAgcnVsZV9zZXQ9dmlvbGF0aW9uLnJ1bGVfc2V0LAogICAgICAgICAgICBydWxlX3VybD12aW9sYXRpb24ucnVsZV91cmwsCiAgICAgICAgICAgIGNvZGVoYXNoPWNvZGVfaGFzaCkKICAgICAgICByZXMuYXBwZW5kKG5ld192aW9sYXRpb24pCiAgICByZXR1cm4gcmVzCgoKZGVmIGV4ZWN1dGVfYW5hbHlzaXNfdG9vbHMoYW5hbHlzaXNfdG9vbHMsIGRhdGFiYXNlX2Nvbm5lY3Rpb24sIGNvbmZpZ19maWxlLCB3b3JraW5nX2RpcmVjdG9yeSwgcmVwb3NpdG9yeV9kaXJlY3RvcnksCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsb2NzX3Blcl9sYW5ndWFnZSwgcGlwZWxpbmVfY29uZmlndXJhdGlvbiwgcHJvamVjdF9jb25maWd1cmF0aW9uPU5vbmUsIGFuYWx5c2lzX2lkPU5vbmUpOgogICAgIiIiCiAgICBFeGVjdXRlIGFsbCBhbmFseXNpcyB0b29scwogICAgOnBhcmFtIGFuYWx5c2lzX3Rvb2xzOiBhbGwgYW5hbHlzaXMgdG9vbHMgdG8gYW5hbHl6ZSwgdXNpbmcgYW4gYXJyYXkgb2YgW1tBbmFseXNpc1Rvb2xdXQogICAgOnBhcmFtIGFuYWx5c2lzX2lkOiB0aGUgYW5hbHlzaXMgaWQgYmVpbmcgZG9uZSwgZWl0aGVyIGZpbGUgcHJvamVjdCBhbmFseXNpcyBvciBmaWxlIGFuYWx5c2lzCiAgICA6cGFyYW0gZGF0YWJhc2VfY29ubmVjdGlvbjogdGhlIG9wZW5lZCBkYXRhYmFzZSBjb25uZWN0aW9uCiAgICA6cGFyYW0gY29uZmlnX2ZpbGU6IGNvbmZpZyBmaWxlIG9mIHRoZSBleGVjdXRvcgogICAgOnBhcmFtIHdvcmtpbmdfZGlyZWN0b3J5OiB3b3JraW5nIGRpcmVjdG9yeSB3aGVyZSB3ZSBwdXQgc2FmZWx5IHN0b3JlIHRlbXBvcmFyeSBkYXRhCiAgICA6cGFyYW0gcmVwb3NpdG9yeV9kaXJlY3Rvcnk6IHdoZXJlIHRoZSBhY3R1YWwgY29kZSBsaXZlcwogICAgOnBhcmFtIHByb2plY3RfY29uZmlndXJhdGlvbjogYSBkaWN0aW9uYXJ5IHJlcHJlc2VudGluZyB0aGUgcHJvamVjdCBjb25maWd1cmF0aW9uCiAgICA6cGFyYW0gc2xvY3NfcGVyX2xhbmd1YWdlOiBhIGRpY3Rpb25hcnkgZ2l2aW5nIHRoZSBzbG9jcyBmb3IgYWxsIGxhbmd1YWdlcyAoTm9uZSBmb3IgZmlsZSBhbmFseXNpcykKICAgIDpwYXJhbSBwaXBlbGluZV9jb25maWd1cmF0aW9uOiBjb25maWd1cmF0aW9uIG9mIHRoZSBwaXBlbGluZSwgZWl0aGVyIGZvciBzaW5nbGUgZmlsZSBhbmFseXNpcyBvciBwcm9qZWN0IGFuYWx5c2lzCiAgICA6cmV0dXJuOiBhIGxpc3Qgb2YgdGFncyB0aGF0IHJlcG9ydHMgcG90ZW50aWFsIGFuYWx5c2lzIGZhaWx1cmVzIG9mIHRoZSBwcm9qZWN0CiAgICAiIiIKCiAgICB0YWdzID0gW10KICAgIHN5c3RlbV9jb25maWd1cmF0aW9uID0gZGF0YWJhc2UuZ2V0X2NvbmZpZ3VyYXRpb24oZGF0YWJhc2VfY29ubmVjdGlvbikKCiAgICAjIEZvciBlYWNoIGFuYWx5c2lzIHRvb2wsIHRyeSB0byBydW4gaXQuIElmIHdlIGdldCB2aW9sYXRpb25zLCBsZXQncyBhZGQgdGhlbSEgT3RoZXJ3aXNlLCBsZXQncyBhZGQgYSB0YWcKICAgICMgdG8gc2hvdyB0aGUgaXNzdWUgdG8gdGhlIHVzZXIuCiAgICBmb3IgYW5hbHlzaXNfdG9vbCBpbiBhbmFseXNpc190b29sczoKCiAgICAgICAgIyBGaXJzdCwgdHJ5IHRvIHNlZSBpZiB0aGUgdG9vbCBpcyBkaXNhYmxlZCB1c2luZyBkZWNpZGVycy4KICAgICAgICBkZWNpZGVyX2tleSA9IGFuYWx5c2lzX3Rvb2wuZGVjaWRlcl9rZXlfZGlzYWJsZWQoKQogICAgICAgIGlmIGlzX2RlY2lkZXJfZW5hYmxlZChzeXN0ZW1fY29uZmlndXJhdGlvbiwgZGVjaWRlcl9rZXkpOgogICAgICAgICAgICBsb2dnaW5nLmluZm8oIltFWEVDVVRPUl0gdG9vbCAlcyBkaXNhYmxlZCBieSBkZWNpZGVycywgc2tpcHBpbmciLCBhbmFseXNpc190b29sLnRvb2xfbmFtZSkKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgc3RhcnRfdHMgPSB0aW1lLnRpbWUoKQogICAgICAgIHRyeToKICAgICAgICAgICAgdmlvbGF0aW9ucyA9IGV4ZWN1dGVfYW5hbHlzaXNfdG9vbCgKICAgICAgICAgICAgICAgIGFuYWx5c2lzX3Rvb2w9YW5hbHlzaXNfdG9vbCwKICAgICAgICAgICAgICAgIGNvbmZpZ19maWxlPWNvbmZpZ19maWxlLAogICAgICAgICAgICAgICAgd29ya2luZ19kaXJlY3Rvcnk9d29ya2luZ19kaXJlY3RvcnksCiAgICAgICAgICAgICAgICByZXBvc2l0b3J5X2RpcmVjdG9yeT1yZXBvc2l0b3J5X2RpcmVjdG9yeSwKICAgICAgICAgICAgICAgIHByb2plY3RfY29uZmlndXJhdGlvbj1wcm9qZWN0X2NvbmZpZ3VyYXRpb24sCiAgICAgICAgICAgICAgICBzbG9jc19wZXJfbGFuZ3VhZ2U9c2xvY3NfcGVyX2xhbmd1YWdlLAogICAgICAgICAgICAgICAgcGlwZWxpbmVfY29uZmlndXJhdGlvbj1waXBlbGluZV9jb25maWd1cmF0aW9uLAogICAgICAgICAgICAgICAgZGF0YWJhc2VfY29ubmVjdGlvbj1kYXRhYmFzZV9jb25uZWN0aW9uLAogICAgICAgICAgICAgICAgYW5hbHlzaXNfaWQ9YW5hbHlzaXNfaWQpCgogICAgICAgICAgICAjIElmIHdlIGRlY2lkZSB0byBtdXRhdGUgdGhlIHJ1bGVzIGJhc2VkIG9uIHRoZSB2YWx1ZXMgaW4gdGhlIGRhdGFiYXNlCiAgICAgICAgICAgIGlmIGlzX2RlY2lkZXJfZW5hYmxlZChzeXN0ZW1fY29uZmlndXJhdGlvbiwgREVDSURFUl9FWEVDVVRPUl9GSUxURVJfUlVMRVNfRlJPTV9EQVRBQkFTRSk6CiAgICAgICAgICAgICAgICBydWxlcyA9IFtdCiAgICAgICAgICAgICAgICBmb3IgYW5hbHlzaXNfdG9vbF9sYW5ndWFnZSBpbiBhbmFseXNpc190b29sLmxhbmd1YWdlczoKICAgICAgICAgICAgICAgICAgICAjIENvbnZlcnQgdGhlIGxhbmd1YWdlIGZyb20gc3RyaW5nIHRvIGludGVnZXIgY29uc3RhbnQuCiAgICAgICAgICAgICAgICAgICAgbGFuZ3VhZ2VfY29uc3RhbnQgPSBMQU5HVUFHRVNfVE9fQ09OU1RBTlRTW2FuYWx5c2lzX3Rvb2xfbGFuZ3VhZ2VdCiAgICAgICAgICAgICAgICAgICAgaWYgbGFuZ3VhZ2VfY29uc3RhbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHJ1bGVzLmV4dGVuZChnZXRfYWxsX3J1bGVzKGRhdGFiYXNlX2Nvbm5lY3Rpb24sIGxhbmd1YWdlX2NvbnN0YW50KSkKICAgICAgICAgICAgICAgIHZpb2xhdGlvbnMgPSBmaWx0ZXJfdmlvbGF0aW9uc193aXRoX3J1bGVzKHZpb2xhdGlvbnMsIHJ1bGVzKQoKICAgICAgICAgICAgaWYgaXNfZGVjaWRlcl9lbmFibGVkKHN5c3RlbV9jb25maWd1cmF0aW9uLCBERUNJREVSX0VYRUNVVE9SX0ZJTFRFUl9SVUxFU19XSVRIX1RNUF9GUk9NX0RBVEFCQVNFKToKICAgICAgICAgICAgICAgIHZpb2xhdGlvbnMgPSBmaWx0ZXJfdmlvbGF0aW9uc19zdGFydF93aXRoX3RtcCh2aW9sYXRpb25zLCByZXBvc2l0b3J5X2RpcmVjdG9yeSkKCiAgICAgICAgICAgICMgaWYgdGhpcyBpcyBhIHByb2plY3QgYW5hbHlzaXMsIGp1c3QgYWRkIHZpb2xhdGlvbnMgaW4gdGhlIGRhdGFic2UKICAgICAgICAgICAgaWYgcGlwZWxpbmVfY29uZmlndXJhdGlvbi5tb2RlID09IFBpcGVsaW5lTW9kZS5QUk9KRUNUX0FOQUxZU0lTOgogICAgICAgICAgICAgICAgdmlvbGF0aW9uc193aXRoX2NvZGVoYXNoID0gYWRkX2NvZGVoYXNoX3RvX3Zpb2xhdGlvbnModmlvbGF0aW9ucywgcmVwb3NpdG9yeV9kaXJlY3RvcnkpCiAgICAgICAgICAgICAgICBkYXRhYmFzZS5hZGRfdmlvbGF0aW9ucyhkYXRhYmFzZV9jb25uZWN0aW9uLCBhbmFseXNpc19pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpb2xhdGlvbnNfd2l0aF9jb2RlaGFzaCwgcHJvamVjdF9jb25maWd1cmF0aW9uKQoKICAgICAgICAgICAgIyBJZiB0aGlzIGlzIGEgZmlsZSBhbmFseXNpcywgbWFrZSBzdXJlIHdlIGNvbnZlcnQgZmlyc3QgdGhlIFZpb2xhdGlvbiBvYmplY3QgaW50byBGaWxlQW5hbHlzaXNWaW9sYXRpb24KICAgICAgICAgICAgIyBhbmQgdGhlbiBwdXQgdGhlIGRhdGEgaW4gdGhlIGRhdGFiYXNlLgogICAgICAgICAgICBpZiBwaXBlbGluZV9jb25maWd1cmF0aW9uLm1vZGUgPT0gUGlwZWxpbmVNb2RlLkZJTEVfQU5BTFlTSVM6CiAgICAgICAgICAgICAgICBmb3IgdmlvbGF0aW9uIGluIHZpb2xhdGlvbnM6CgogICAgICAgICAgICAgICAgICAgICMgTWFraW5nIHN1cmUgdGhhdCBhbGwgdmlvbGF0aW9ucyBoYXZlIGEgcnVsZSBkZWZpbmVkLgogICAgICAgICAgICAgICAgICAgIGlmIG5vdCB2aW9sYXRpb24ucnVsZToKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBmaWxlX2FuYWx5c2lzX3Zpb2xhdGlvbiA9IEZpbGVBbmFseXNpc1Zpb2xhdGlvbi5mcm9tX3Zpb2xhdGlvbihhbmFseXNpc19pZCwgdmlvbGF0aW9uKQogICAgICAgICAgICAgICAgICAgIGNyZWF0ZV9maWxlX2FuYWx5c2lzX3Zpb2xhdGlvbihkYXRhYmFzZV9jb25uZWN0aW9uLCBmaWxlX2FuYWx5c2lzX3Zpb2xhdGlvbikKICAgICAgICBleGNlcHQgQW5hbHlzaXNUb29sRXhlY3V0aW9uRXhjZXB0aW9uOgogICAgICAgICAgICB0YWdzLmFwcGVuZCgiezB9X0VSUk9SIi5mb3JtYXQoYW5hbHlzaXNfdG9vbC50b29sX25hbWUudXBwZXIoKSkpCiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoIltFWEVDVVRPUl0gJXMgLSBjYW5ub3QgY29udGludWUgYW5hbHlzaXMgZXJyb3IsIGFuYWx5c2lzICVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBhbmFseXNpc190b29sLnRvb2xfbmFtZSwgYW5hbHlzaXNfaWQpCiAgICAgICAgICAgIG1ldHJpY3MuaW5jcmVtZW50X21ldHJpYygidG9vbF97MH1fZXJyb3IiLmZvcm1hdChhbmFseXNpc190b29sLnRvb2xfbmFtZSkpCiAgICAgICAgZXhjZXB0IHN1YnByb2Nlc3MuVGltZW91dEV4cGlyZWQ6CiAgICAgICAgICAgIHRhZ3MuYXBwZW5kKCJ7MH1fVElNRU9VVCIuZm9ybWF0KGFuYWx5c2lzX3Rvb2wudG9vbF9uYW1lLnVwcGVyKCkpKQogICAgICAgICAgICBsb2dnaW5nLmVycm9yKCJbRVhFQ1VUT1JdICVzIC0gdGltZW91dCBleHBpcmVkIGZvciBhbmFseXNpcyAlcyIsIGFuYWx5c2lzX3Rvb2wudG9vbF9uYW1lLCBhbmFseXNpc19pZCkKICAgICAgICAgICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKCJ0b29sX3swfV90aW1lb3V0Ii5mb3JtYXQoYW5hbHlzaXNfdG9vbC50b29sX25hbWUpKQogICAgICAgIGV4Y2VwdCBzdWJwcm9jZXNzLkNhbGxlZFByb2Nlc3NFcnJvcjoKICAgICAgICAgICAgbG9nZ2luZy5leGNlcHRpb24oImV4Y2VwdGlvbiBjYXVnaHQiKQogICAgICAgICAgICB0YWdzLmFwcGVuZCgiezB9X0VSUk9SIi5mb3JtYXQoYW5hbHlzaXNfdG9vbC50b29sX25hbWUudXBwZXIoKSkpCiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoIltFWEVDVVRPUl0gJXMgLSBjYW5ub3QgY29udGludWUsIGNhbGxlZCBwcm9jZXNzIGVycm9yIGFuYWx5c2lzICVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBhbmFseXNpc190b29sLnRvb2xfbmFtZSwgYW5hbHlzaXNfaWQpCiAgICAgICAgICAgIG1ldHJpY3MuaW5jcmVtZW50X21ldHJpYygidG9vbF97MH1fZXJyb3IiLmZvcm1hdChhbmFseXNpc190b29sLnRvb2xfbmFtZSkpCiAgICAgICAgZW5kX3RzID0gdGltZS50aW1lKCkKICAgICAgICBkdXJhdGlvbl9zZWMgPSBpbnQoZW5kX3RzIC0gc3RhcnRfdHMpCgogICAgICAgIGxvZ2dpbmcuZGVidWcoIltFWEVDVVRPUl0gZXhlY3V0aW5nIHRvb2wgJXMgdG9vbCAlcyBzZWNzIiwgYW5hbHlzaXNfdG9vbC50b29sX25hbWUsIGR1cmF0aW9uX3NlYykKCiAgICAgICAgIyBPbmx5IGFkZCBleGVjdXRpb24gdGltZSBmb3IgdGhlIHByb2plY3QgYW5hbHlzaXMuIElmIHdlIGtlZXAgaXQgYWxzbyBmb3IgdGhlIGZpbGUgYW5hbHlzaXMsCiAgICAgICAgIyB0aGlzIHdvdWxkIHNjZXcgdGhlIGRhdGEuCiAgICAgICAgaWYgcGlwZWxpbmVfY29uZmlndXJhdGlvbi5tb2RlID09IFBpcGVsaW5lTW9kZS5QUk9KRUNUX0FOQUxZU0lTOgogICAgICAgICAgICBhZGRfYW5hbHlzaXNfc3RlcF9ydW5uaW5nX3RpbWUoZGF0YWJhc2VfY29ubmVjdGlvbiwgYW5hbHlzaXNfaWQsIGFuYWx5c2lzX3Rvb2wudG9vbF9uYW1lLCBkdXJhdGlvbl9zZWMpCiAgICByZXR1cm4gdGFncwoKCmRlZiBmaW5kX2R1cGxpY2F0ZXMoYW5hbHlzaXNfaWQsIGRiLCBjb25maWdfZmlsZSwgd29ya2luZ19kaXJlY3RvcnksIHJlcG9zaXRvcnlfZGlyZWN0b3J5LCBwcm9qZWN0X2NvbmZpZ3VyYXRpb24pOgogICAgIyBUaW1lIHRvIGZpbmQgZHVwbGljYXRlcyB3aXRoIGpzY3AhCiAgICB0YWdzID0gW10KICAgIGlmIGNvbmYuaXNfZW5hYmxlZChwcm9qZWN0X2NvbmZpZ3VyYXRpb24sIGNvbnN0YW50cy5FTkdJTkVfRFVQTElDQVRFU19FTkFCTEVELCAidHJ1ZSIpOgogICAgICAgIGpzY3BkX3N0YXJ0X3RzID0gdGltZS50aW1lKCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGR1cGxpY2F0ZXMgPSBqc2NwZF9oZWxwZXIuZmluZF9kdXBsaWNhdGVzKGNvbmZpZ19maWxlLCBwcm9qZWN0X2NvbmZpZ3VyYXRpb24sIHJlcG9zaXRvcnlfZGlyZWN0b3J5LCB3b3JraW5nX2RpcmVjdG9yeSkKCiAgICAgICAgICAgIGlmIGxlbihkdXBsaWNhdGVzKSA9PSAwOgogICAgICAgICAgICAgICAgbG9nZ2luZy5pbmZvKCJbRVhFQ1VUT1JdIG5vIGR1cGxpY2F0ZXMgZm9yIGFuYWx5c2lzIHswfSIuZm9ybWF0KGFuYWx5c2lzX2lkKSkKCiAgICAgICAgICAgIGRhdGFiYXNlLmFkZF9kdXBsaWNhdGVzKGRiLCBhbmFseXNpc19pZCwgZHVwbGljYXRlcywgcHJvamVjdF9jb25maWd1cmF0aW9uKQogICAgICAgIGV4Y2VwdCBzdWJwcm9jZXNzLlRpbWVvdXRFeHBpcmVkOgogICAgICAgICAgICB0YWdzLmFwcGVuZCgiSlNDUERfVElNRU9VVCIpCiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoIltFWEVDVVRPUl0gSlNDUEQgLSB0aW1lb3V0IGV4cGlyZWQgZm9yIGFuYWx5c2lzIHswfSIuZm9ybWF0KGFuYWx5c2lzX2lkKSkKICAgICAgICBleGNlcHQgc3VicHJvY2Vzcy5DYWxsZWRQcm9jZXNzRXJyb3I6CiAgICAgICAgICAgIHRhZ3MuYXBwZW5kKCJKU0NQRF9FUlJPUiIpCiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoIltFWEVDVVRPUl0gSlNDUEQgLSBpc3N1ZSBmb3IgYW5hbHlzaXMgezB9Ii5mb3JtYXQoYW5hbHlzaXNfaWQpKQogICAgICAgIGpzY3BkX2VuZF90cyA9IHRpbWUudGltZSgpCiAgICAgICAganNjcGRfZHVyYXRpb24gPSBqc2NwZF9lbmRfdHMgLSBqc2NwZF9zdGFydF90cwogICAgICAgIGxvZ2dpbmcuZGVidWcoIltFWEVDVVRPUl0gSlNDUEQgdG9vayB7MH0gc2VjIHRvIGV4ZWN1dG9yIi5mb3JtYXQoanNjcGRfZHVyYXRpb24pKQogICAgcmV0dXJuIHRhZ3MKCgpkZWYgZ2V0X2NvbXBsZXhpdHlfbWV0cmljcyhhbmFseXNpc19pZCwgZGIsIGNvbmZpZ19maWxlLCB3b3JraW5nX2RpcmVjdG9yeSwgcmVwb3NpdG9yeV9kaXJlY3RvcnksIHByb2plY3RfY29uZmlndXJhdGlvbik6CiAgICB0YWdzID0gW10KICAgIGlmIGNvbmYuaXNfZW5hYmxlZChwcm9qZWN0X2NvbmZpZ3VyYXRpb24sIGNvbnN0YW50cy5FTkdJTkVfQ09NUExFWElUWV9NRVRSSUNTX0VOQUJMRUQsICJ0cnVlIik6CiAgICAgICAgY29tcGxleGl0eV9zdGFydF90cyA9IHRpbWUudGltZSgpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb21wbGV4aXR5X3JlcG9ydCA9IGxpemFyZF9oZWxwZXIuZ2V0X2NvbXBsZXhpdHlfbWV0cmljcyhjb25maWdfZmlsZSwgcHJvamVjdF9jb25maWd1cmF0aW9uLCByZXBvc2l0b3J5X2RpcmVjdG9yeSwgd29ya2luZ19kaXJlY3RvcnkpCgogICAgICAgICAgICBpZiBub3QgY29tcGxleGl0eV9yZXBvcnQ6CiAgICAgICAgICAgICAgICBsb2dnaW5nLmVycm9yKCJbRVhFQ1VUT1JdIG5vIGNvbXBsZXhpdHkgZm9yIGFuYWx5c2lzIHswfSIuZm9ybWF0KGFuYWx5c2lzX2lkKSkKCiAgICAgICAgICAgIGRhdGFiYXNlLmFkZF9jb21wbGV4aXR5X21ldHJpY3NfZnVuY3Rpb25zKGRiLCBhbmFseXNpc19pZCwgY29tcGxleGl0eV9yZXBvcnQucGVyX2Z1bmN0aW9uLCBwcm9qZWN0X2NvbmZpZ3VyYXRpb24pCiAgICAgICAgICAgIGRhdGFiYXNlLmFkZF9jb21wbGV4aXR5X21ldHJpY3Nfc3VtbWFyaWVzKGRiLCBhbmFseXNpc19pZCwgY29tcGxleGl0eV9yZXBvcnQuc3VtbWFyeSwgcHJvamVjdF9jb25maWd1cmF0aW9uKQoKICAgICAgICBleGNlcHQgc3VicHJvY2Vzcy5UaW1lb3V0RXhwaXJlZDoKICAgICAgICAgICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKG1ldHJpY3NfbmFtZXMuQU5BTFlTSVNfTElaQVJEX1RJTUVPVVQpCiAgICAgICAgICAgIHRhZ3MuYXBwZW5kKCJMSVpBUkQgVElNRU9VVCIpCiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoIltFWEVDVVRPUl0gTElaQVJEIC0gdGltZW91dCBleHBpcmVkIGFuYWx5c2lzIHswfSIuZm9ybWF0KGFuYWx5c2lzX2lkKSkKICAgICAgICBleGNlcHQgc3VicHJvY2Vzcy5DYWxsZWRQcm9jZXNzRXJyb3I6CiAgICAgICAgICAgIG1ldHJpY3MuaW5jcmVtZW50X21ldHJpYyhtZXRyaWNzX25hbWVzLkFOQUxZU0lTX0xJWkFSRF9FUlJPUikKICAgICAgICAgICAgdGFncy5hcHBlbmQoIkxJWkFSRF9FUlJPUiIpCiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoIltFWEVDVVRPUl0gTElaQVJEIC0gZXJyb3IgZm9yIGFuYWx5c2lzIHswfSIuZm9ybWF0KGFuYWx5c2lzX2lkKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGV4Y2VwdGlvbjoKICAgICAgICAgICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKG1ldHJpY3NfbmFtZXMuQU5BTFlTSVNfTElaQVJEX0VYQ0VQVElPTikKICAgICAgICAgICAgdGFncy5hcHBlbmQoIkxJWkFSRF9FUlJPUiIpCiAgICAgICAgICAgIGxvZ2dpbmcuZXhjZXB0aW9uKCJbRVhFQ1VUT1JdIExJWkFSRCAtIHVua25vd24gZXhjZXB0aW9uIHswfSBmb3IgYW5hbHlzaXMgezF9Ii5mb3JtYXQoc3RyKGV4Y2VwdGlvbiksIGFuYWx5c2lzX2lkKSkKICAgICAgICBjb21wbGV4aXR5X2VuZF90cyA9IHRpbWUudGltZSgpCiAgICAgICAgZHVyYXRpb24gPSBjb21wbGV4aXR5X2VuZF90cyAtIGNvbXBsZXhpdHlfc3RhcnRfdHMKICAgICAgICBsb2dnaW5nLmRlYnVnKCJbRVhFQ1VUT1JdIExJWkFSRCB0b29rIHswfSBzZWMgdG8gZXhlY3V0b3IiLmZvcm1hdChkdXJhdGlvbikpCiAgICByZXR1cm4gdGFncwoKCmRlZiBhbmFseXplX2FyY2hpdGVjdHVyZShhbmFseXNpc19pZCwgZGIsIGNvbmZpZ19maWxlLCB3b3JraW5nX2RpcmVjdG9yeSwgcmVwb3NpdG9yeV9kaXJlY3RvcnksIHNsb2NzX3Blcl9sYW5ndWFnZSwgcHJvamVjdF9jb25maWd1cmF0aW9uKToKICAgICIiIgogICAgQW5hbHl6ZSB0aGUgYXJjaGl0ZWN0dXJlIHdpdGggZGVwZW5kcwogICAgOnBhcmFtIGFuYWx5c2lzX2lkOgogICAgOnBhcmFtIGRiOgogICAgOnBhcmFtIGNvbmZpZ19maWxlOgogICAgOnBhcmFtIHdvcmtpbmdfZGlyZWN0b3J5OgogICAgOnBhcmFtIHJlcG9zaXRvcnlfZGlyZWN0b3J5OgogICAgOnBhcmFtIHNsb2NzX3Blcl9sYW5ndWFnZToKICAgIDpwYXJhbSBwcm9qZWN0X2NvbmZpZ3VyYXRpb246CiAgICA6cmV0dXJuOgogICAgIiIiCiAgICB0YWdzID0gW10KICAgIGlmIGNvbmYuaXNfZW5hYmxlZChwcm9qZWN0X2NvbmZpZ3VyYXRpb24sIGNvbnN0YW50cy5FTkdJTkVfQVJDSElURUNUVVJFX0VOQUJMRUQsICJ0cnVlIik6CiAgICAgICAgZGVwZW5kc19zdGFydF90cyA9IHRpbWUudGltZSgpCiAgICAgICAgZGVwZW5kc19yZXBvcnRfZmlsZSA9ICJ7MH0vZGVwZW5kc19yZXBvcnQiLmZvcm1hdCh3b3JraW5nX2RpcmVjdG9yeSkKCiAgICAgICAgbGFuZ3VhZ2UgPSBkZXBlbmRzX2hlbHBlci5nZXRfbGFuZ3VhZ2Uoc2xvY3NfcGVyX2xhbmd1YWdlKQoKICAgICAgICBpZiBub3QgbGFuZ3VhZ2U6CiAgICAgICAgICAgIGxvZ2dpbmcuaW5mbygiW0VYRUNVVE9SXSBbREVQRU5EU10gbGFuZ3VhZ2Ugbm90IHN1cHBvcnRlZCBmb3IgYW5hbHlzaXMgJXMiLCBhbmFseXNpc19pZCkKICAgICAgICAgICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKG1ldHJpY3NfbmFtZXMuREVQRU5EU19MQU5HVUFHRV9OT1RfU1VQUE9SVEVEKQogICAgICAgICAgICByZXR1cm4gdGFncwoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFyY2hpdGVjdHVyZSA9IE5vbmUKICAgICAgICAgICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKG1ldHJpY3NfbmFtZXMuREVQRU5EU19DQUxMX1RPT0wpCiAgICAgICAgICAgIGRlcGVuZHNfaGVscGVyLmV4ZWN1dGUoY29uZmlnX2ZpbGUsIGxhbmd1YWdlLCByZXBvc2l0b3J5X2RpcmVjdG9yeSwgd29ya2luZ19kaXJlY3RvcnksIGRlcGVuZHNfcmVwb3J0X2ZpbGUsIHByb2plY3RfY29uZmlndXJhdGlvbikKICAgICAgICAgICAgaWYgb3MucGF0aC5pc2ZpbGUoZGVwZW5kc19yZXBvcnRfZmlsZSk6CiAgICAgICAgICAgICAgICBhcmNoaXRlY3R1cmUgPSBkZXBlbmRzX2hlbHBlci5wYXJzZV9vdXRwdXQoZGVwZW5kc19yZXBvcnRfZmlsZSwgInswfS8iLmZvcm1hdChyZXBvc2l0b3J5X2RpcmVjdG9yeSkpCgogICAgICAgICAgICBpZiBhcmNoaXRlY3R1cmU6CiAgICAgICAgICAgICAgICBtZXRyaWNzLmluY3JlbWVudF9tZXRyaWMobWV0cmljc19uYW1lcy5ERVBFTkRTX0FSQ0hJVEVDVFVSRV9GT1VORCkKICAgICAgICAgICAgICAgIGluc2VydF9hcmNoaXRlY3R1cmUoZGIsIGFuYWx5c2lzX2lkLCBhcmNoaXRlY3R1cmUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBtZXRyaWNzLmluY3JlbWVudF9tZXRyaWMobWV0cmljc19uYW1lcy5ERVBFTkRTX0FSQ0hJVEVDVFVSRV9OT1RfRk9VTkQpCiAgICAgICAgICAgICAgICBsb2dnaW5nLmluZm8oIltFWEVDVVRPUl0gW0RFUEVORFNdIGFyY2hpdGVjdHVyZSBub3QgZm91bmQgZm9yIGFuYWx5c2lzICVzIiwgYW5hbHlzaXNfaWQpCgogICAgICAgIGV4Y2VwdCBzdWJwcm9jZXNzLlRpbWVvdXRFeHBpcmVkOgogICAgICAgICAgICB0YWdzLmFwcGVuZCgiREVQRU5EU19USU1FT1VUIikKICAgICAgICAgICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKG1ldHJpY3NfbmFtZXMuREVQRU5EU19FWENFUFRJT05fVElNRU9VVCkKICAgICAgICAgICAgbG9nZ2luZy5lcnJvcigiW0VYRUNVVE9SXSBERVBFTkRTIC0gdGltZW91dCBleHBpcmVkIGZvciBhbmFseXNpcyAlcyIsIGFuYWx5c2lzX2lkKQogICAgICAgIGV4Y2VwdCBzdWJwcm9jZXNzLkNhbGxlZFByb2Nlc3NFcnJvcjoKICAgICAgICAgICAgdGFncy5hcHBlbmQoIkRFUEVORFNfRVJST1IiKQogICAgICAgICAgICBtZXRyaWNzLmluY3JlbWVudF9tZXRyaWMobWV0cmljc19uYW1lcy5ERVBFTkRTX0NBTExFRF9QUk9DRVNTX0VSUk9SKQogICAgICAgICAgICBsb2dnaW5nLmVycm9yKCJbRVhFQ1VUT1JdIERFUEVORFMgLSBpc3N1ZSBmb3IgYW5hbHlzaXMgJXMiLCBhbmFseXNpc19pZCkKICAgICAgICBleGNlcHQgSW5kZXhFcnJvcjoKICAgICAgICAgICAgdGFncy5hcHBlbmQoIkRFUEVORFNfRVJST1IiKSAKICAgICAgICAgICAgbWV0cmljcy5pbmNyZW1lbnRfbWV0cmljKG1ldHJpY3NfbmFtZXMuREVQRU5EU19VTktOT1dOX0VSUk9SKQogICAgICAgICAgICBsb2dnaW5nLmVycm9yKCJbREVQRU5EU10gZmlsZSBjb250ZW50IikKICAgICAgICAgICAgbG9nZ2luZy5leGNlcHRpb24oIltFWEVDVVRPUl0gREVQRU5EUyAtIHVua25vd24gZXhjZXB0aW9uIGZvciBhbmFseXNpcyAlcyIsIGFuYWx5c2lzX2lkKQogICAgICAgIGRlcGVuZHNfbGFzdF90cyA9IHRpbWUudGltZSgpCiAgICAgICAgZGVwZW5kc19kdXJhdGlvbiA9IGRlcGVuZHNfbGFzdF90cyAtIGRlcGVuZHNfc3RhcnRfdHMKICAgICAgICBsb2dnaW5nLmRlYnVnKCJbRVhFQ1VUT1JdIERFUEVORFMgdG9vayAlcyBzZWMgdG8gZXhlY3V0b3IiLCBkZXBlbmRzX2R1cmF0aW9uKQogICAgcmV0dXJuIHRhZ3MKCgpkZWYgYW5hbHl6ZV9kZXBlbmRlbmNpZXMoYW5hbHlzaXNfaWQsIGRiLCByZXBvc2l0b3J5X2RpcmVjdG9yeSwgcHJvamVjdF9jb25maWd1cmF0aW9uKToKICAgICIiIgogICAgR2V0IGFsbCB0aGUgZGVwZW5kZW5jaWVzIGFuZCBhZGQgdGhlbSBpbiB0aGUgZGF0YWJhc2UKICAgIDpwYXJhbSBhbmFseXNpc19pZDogY3VycmVudCBhbmFseXNpcyBpZAogICAgOnBhcmFtIGRiOiB0aGUgY29ubmVjdGlvbiB0byB0aGUgZGF0YWJhc2UKICAgIDpwYXJhbSByZXBvc2l0b3J5X2RpcmVjdG9yeTogd2hlcmUgaXMgdGhlIHJlcG9zaXRvcnkKICAgIDpwYXJhbSBwcm9qZWN0X2NvbmZpZ3VyYXRpb246IHRoZSBwcm9qZWN0IGNvbmZpZ3VyYXRpb24KICAgIDpyZXR1cm46IGEgbGlzdCBvZiB0YWdzIGlmIGFueQogICAgIiIiCiAgICBkZWYgYnVpbGRfZmlsZW5hbWUoY29uZmlndXJhdGlvbl9maWxlbmFtZSwgZGVmYXVsdF9maWxlbmFtZSk6CiAgICAgICAgIiIiCiAgICAgICAgQnVpbGQgdGhlIGZpbGVuYW1lIHRvIGdldCB0aGUgY29uZmlndXJhdGlvbiBmaWxlLgogICAgICAgIDpwYXJhbSBjb25maWd1cmF0aW9uX2ZpbGVuYW1lOiB1c2VyLWRlZmluZWQgZmlsZSBzZXQgaW4gdGhlIGNvbmZpZ3VyYXRpb24uIGNhbiBiZSBOb25lIGlmIG5vdCBzZXQKICAgICAgICA6cGFyYW0gZGVmYXVsdF9maWxlbmFtZTogdGhlIGRlZmF1bHQgZmlsZSwgYWx3YXlzIHNldC4KICAgICAgICA6cmV0dXJuOiB0aGUgZmlsZW5hbWUgdG8gdXNlCiAgICAgICAgIiIiCiAgICAgICAgaWYgY29uZmlndXJhdGlvbl9maWxlbmFtZSBpcyBub3QgTm9uZSBhbmQgbGVuKGNvbmZpZ3VyYXRpb25fZmlsZW5hbWUpID4gMCBhbmQgIi4uIiBub3QgaW4gY29uZmlndXJhdGlvbl9maWxlbmFtZToKICAgICAgICAgICAgIyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgdXNlciBpcyBub3QgdHJ5aW5nIHRvIGdldCBvdGhlciBmaWxlcwogICAgICAgICAgICB0bXAgPSAiezB9L3sxfSIuZm9ybWF0KHJlcG9zaXRvcnlfZGlyZWN0b3J5LCBjb25maWd1cmF0aW9uX2ZpbGVuYW1lKQogICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZSh0bXApOgogICAgICAgICAgICAgICAgcmV0dXJuIHRtcAogICAgICAgIHJldHVybiAiezB9L3sxfSIuZm9ybWF0KHJlcG9zaXRvcnlfZGlyZWN0b3J5LCBkZWZhdWx0X2ZpbGVuYW1lKQoKICAgIHRhZ3MgPSBbXQogICAgZGVwZW5kZW5jaWVzOiBsaXN0W0RlcGVuZGVuY3ldID0gW10KICAgIGlmIGNvbmYuaXNfZW5hYmxlZChwcm9qZWN0X2NvbmZpZ3VyYXRpb24sIGNvbnN0YW50cy5FTkdJTkVfREVQRU5ERU5DWV9FTkFCTEVELCAidHJ1ZSIpOgogICAgICAgIGRlcGVuZGVuY2llcy5leHRlbmQocGFyc2VfcnVieV9nZW1maWxlKGJ1aWxkX2ZpbGVuYW1lKHByb2plY3RfY29uZmlndXJhdGlvbi5nZXQoY29uc3RhbnRzLlBST0pFQ1RfQ09ORklHVVJBVElPTl9SVUJZX0dFTUZJTEVfRklMRV9QQVRILCBOb25lKSwgY29uc3RhbnRzLkRFUEVOREVOQ1lfR0VNRklMRV9OQU1FKSkpCiAgICAgICAgZGVwZW5kZW5jaWVzLmV4dGVuZChwYXJzZV9weXRob25fcmVxdWlyZW1lbnRzKGJ1aWxkX2ZpbGVuYW1lKHByb2plY3RfY29uZmlndXJhdGlvbi5nZXQoY29uc3RhbnRzLlBST0pFQ1RfQ09ORklHVVJBVElPTl9QWVRIT05fUkVRVUlSRU1FTlRTX1BBVEgsIE5vbmUpLCBjb25zdGFudHMuREVQRU5ERU5DWV9QWVRIT05fUkVRVUlSRU1FTlRTX05BTUUpKSkKICAgICAgICBkZXBlbmRlbmNpZXMuZXh0ZW5kKHBhcnNlX3BocF9jb21wb3Nlcl9qc29uKGJ1aWxkX2ZpbGVuYW1lKHByb2plY3RfY29uZmlndXJhdGlvbi5nZXQoY29uc3RhbnRzLlBST0pFQ1RfQ09ORklHVVJBVElPTl9QSFBfQ09NUE9TRVJfSlNPTl9QQVRILCBOb25lKSwgY29uc3RhbnRzLkRFUEVOREVOQ1lfUEhQX0NPTVBPU0VSX0pTT05fTkFNRSkpKQogICAgICAgIGRlcGVuZGVuY2llcy5leHRlbmQocGFyc2VfamF2YXNjcmlwdF9wYWNrYWdlcyhidWlsZF9maWxlbmFtZShwcm9qZWN0X2NvbmZpZ3VyYXRpb24uZ2V0KGNvbnN0YW50cy5QUk9KRUNUX0NPTkZJR1VSQVRJT05fSkFWQVNDUklQVF9QQUNLQUdFX1BBVEgsIE5vbmUpLCBjb25zdGFudHMuREVQRU5ERU5DWV9KQVZBU0NSSVBUX1BBQ0tBR0VfTkFNRSkpKQogICAgICAgIGRlcGVuZGVuY2llcy5leHRlbmQocGFyc2VfcG9tKGJ1aWxkX2ZpbGVuYW1lKHByb2plY3RfY29uZmlndXJhdGlvbi5nZXQoY29uc3RhbnRzLlBST0pFQ1RfQ09ORklHVVJBVElPTl9KQVZBX1BPTV9GSUxFX1BBVEgsIE5vbmUpLCBjb25zdGFudHMuREVQRU5ERU5DWV9KQVZBX1BPTV9OQU1FKSkpCiAgICAgICAgZGVwZW5kZW5jaWVzLmV4dGVuZChwYXJzZV9zYnRfYnVpbGRfZmlsZShidWlsZF9maWxlbmFtZShwcm9qZWN0X2NvbmZpZ3VyYXRpb24uZ2V0KGNvbnN0YW50cy5QUk9KRUNUX0NPTkZJR1VSQVRJT05fU0JUX0JVSUxEX0ZJTEVfUEFUSCwgTm9uZSksIGNvbnN0YW50cy5ERVBFTkRFTkNZX1NCVF9CVUlMRF9OQU1FKSkpCiAgICAgICAgZGVwZW5kZW5jaWVzLmV4dGVuZChwYXJzZV9ncmFkbGVfa290bGluKGJ1aWxkX2ZpbGVuYW1lKHByb2plY3RfY29uZmlndXJhdGlvbi5nZXQoY29uc3RhbnRzLlBST0pFQ1RfQ09ORklHVVJBVElPTl9HUkFETEVfS09UTElOX0ZJTEVfUEFUSCwgTm9uZSksIGNvbnN0YW50cy5ERVBFTkRFTkNZX0dSQURMRV9LT1RMSU5fTkFNRSkpKQogICAgICAgIGRlcGVuZGVuY2llcy5leHRlbmQocGFyc2VfZ3JhZGxlX2phdmEoYnVpbGRfZmlsZW5hbWUocHJvamVjdF9jb25maWd1cmF0aW9uLmdldChjb25zdGFudHMuUFJPSkVDVF9DT05GSUdVUkFUSU9OX0dSQURMRV9KQVZBX0ZJTEVfUEFUSCwgTm9uZSksIGNvbnN0YW50cy5ERVBFTkRFTkNZX0dSQURMRV9KQVZBX05BTUUpKSkKCgogICAgICAgICMgTm93LCB1cGRhdGUgdGhlIGRlcGVuZGVuY3kgZGVzY3JpcHRpb24gaW4gdGhlIGRhdGFiYXNlIHRvIG1ha2Ugc3VyZSB0aGV5IGFyZSB1cCB0byBkYXRlLgogICAgICAgIGZvciBkZXBlbmRlbmN5IGluIGRlcGVuZGVuY2llczoKICAgICAgICAgICAgaWYgZGVwZW5kZW5jeS5sYW5ndWFnZSA9PSBjb25zdGFudHMuTEFOR1VBR0VfUFlUSE9OOgogICAgICAgICAgICAgICAgdXBkYXRlX3B5dGhvbl9wYWNrYWdlKGRiLCBkZXBlbmRlbmN5Lm5hbWUpCiAgICAgICAgICAgIGlmIGRlcGVuZGVuY3kubGFuZ3VhZ2UgPT0gY29uc3RhbnRzLkxBTkdVQUdFX0pBVkFTQ1JJUFQ6CiAgICAgICAgICAgICAgICB1cGRhdGVfamF2YXNjcmlwdF9kZXBlbmRlbmN5KGRiLCBkZXBlbmRlbmN5Lm5hbWUpCiAgICAgICAgICAgIGlmIGRlcGVuZGVuY3kubGFuZ3VhZ2UgPT0gY29uc3RhbnRzLkxBTkdVQUdFX0pBVkE6CiAgICAgICAgICAgICAgICB1cGRhdGVfcG9tX2RlcGVuZGVuY3koZGIsIGRlcGVuZGVuY3kubmFtZSkKICAgICAgICAgICAgaWYgZGVwZW5kZW5jeS5sYW5ndWFnZSA9PSBjb25zdGFudHMuTEFOR1VBR0VfUlVCWToKICAgICAgICAgICAgICAgIHVwZGF0ZV9nZW1zX2RlcGVuZGVuY3koZGIsIGRlcGVuZGVuY3kubmFtZSkKICAgICAgICAgICAgaWYgZGVwZW5kZW5jeS5sYW5ndWFnZSA9PSBjb25zdGFudHMuTEFOR1VBR0VfUEhQOgogICAgICAgICAgICAgICAgdXBkYXRlX3BocF9kZXBlbmRlbmN5KGRiLCBkZXBlbmRlbmN5Lm5hbWUpCiAgICAgICAgaW5zZXJ0X2FuYWx5c2lzX2RlcGVuZGVuY2llcyhkYiwgYW5hbHlzaXNfaWQsIGRlcGVuZGVuY2llcykKICAgIHJldHVybiB0YWdzCgoKZGVmIHNob3VsZF9za2lwKGNvbW1pdF9tZXNzYWdlLCBwcm9qZWN0X2NvbmZpZ3VyYXRpb24pOgogICAgIiIiCiAgICBkZWNpZGUgaWYgeW91IHNob3VsZCBza2lwIGFuIGFuYWx5c2lzIGJhc2VkIG9uIHRoZSBsYXRlc3QgY29tbWl0IG1lc3NhZ2UKICAgIDpwYXJhbSBjb21taXRfbWVzc2FnZTogdGhlIGNvbW1pdCBtZXNzYWdlCiAgICA6cGFyYW0gcHJvamVjdF9jb25maWd1cmF0aW9uOiB0aGUgcHJvamVjdCBjb25maWd1cmF0aW9uIHJldHJpZXZlZCBiZWZvcmUgYW5hbHlzaXMKICAgIDpyZXR1cm46IHRydWUgb2YgZmFsc2UgLSBpZiB3ZSBzaG91bGQgc2tpcAogICAgIiIiCgogICAgaWYgbm90IGNvbW1pdF9tZXNzYWdlOgogICAgICAgIHJldHVybiBGYWxzZQogICAgaWYgbm90IHByb2plY3RfY29uZmlndXJhdGlvbjoKICAgICAgICByZXR1cm4gRmFsc2UKICAgIGtleXdvcmRzID0gY29uZi5nZXRfYW5hbHlzaXNfc2tpcF9rZXl3b3Jkcyhwcm9qZWN0X2NvbmZpZ3VyYXRpb24pCiAgICBpZiBub3Qga2V5d29yZHM6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICBpZiBsZW4oa2V5d29yZHMpID09IDA6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICBmb3Iga2V5d29yZCBpbiBrZXl3b3JkczoKICAgICAgICBpZiBsZW4oa2V5d29yZCkgPiAwIGFuZCBrZXl3b3JkIGluIGNvbW1pdF9tZXNzYWdlOgogICAgICAgICAgICBsb2dnaW5nLmluZm8oIltzaG91bGRfc2tpcF0ga2V5d29yZCB7MH0gZm91bmQgaW4gY29tbWl0IG1lc3NhZ2UgezF9Ii5mb3JtYXQoa2V5d29yZCwgY29tbWl0X21lc3NhZ2UpKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgcmV0dXJuIEZhbHNlCgoKZGVmIGdldF9tYXhfYWxsb3dlZF9zbG9jc19mb3JfYW5hbHlzaXMoZGIsIGFuYWx5c2lzKToKICAgICIiIgogICAgR2V0IHRoZSBtYXggYWxsb3dlZCBzbG9jcyBmb3IgYW4gYW5hbHlzaXMsIGF0dGVtcHRpbmcgdG8gdGFrZSBpdCBmcm9tIHZhcmlvdXMgc291cmNlcwogICAgOnBhcmFtIGRiOgogICAgOnBhcmFtIGFuYWx5c2lzOgogICAgOnJldHVybjoKICAgICIiIgoKICAgIGlmIG5vdCBhbmFseXNpczoKICAgICAgICByZXR1cm4gY29uc3RhbnRzLk1BWF9TTE9DU19CQVNJQwoKICAgIHVzZXJfaWQgPSBhbmFseXNpc1sndXNlcl9pZCddCiAgICBwcm9qZWN0X2lkID0gYW5hbHlzaXNbJ3Byb2plY3RfaWQnXQoKICAgIG1heF9zbG9jcyA9IFtdCiAgICBtYXhfc2xvY3MuYXBwZW5kKGJhY2tlbmRfbGliLmRhdGFiYXNlLmFuYWx5c2lzX3N0YXRzLmdldF9tYXhfYWxsb3dlZF9zbG9jc19mb3JfdXNlcihkYiwgdXNlcl9pZCkpCgogICAgaWYgcHJvamVjdF9pZDoKICAgICAgICBwcm9qZWN0X2luZm8gPSBiYWNrZW5kX2xpYi5kYXRhYmFzZS5wcm9qZWN0LmdldF9wcm9qZWN0X2luZm8oZGIsIHByb2plY3RfaWQpCiAgICAgICAgaWYgcHJvamVjdF9pbmZvIGFuZCBwcm9qZWN0X2luZm9bJ2dyb3VwX2lkJ106CiAgICAgICAgICAgIG1heF9zbG9jcy5hcHBlbmQoCiAgICAgICAgICAgICAgICBiYWNrZW5kX2xpYi5kYXRhYmFzZS5hbmFseXNpc19zdGF0cy5nZXRfbWF4X2FsbG93ZWRfc2xvY3NfZm9yX2dyb3VwKGRiLCBwcm9qZWN0X2luZm9bJ2dyb3VwX2lkJ10pKQogICAgICAgIGlmIHByb2plY3RfaW5mbyBhbmQgcHJvamVjdF9pbmZvWyd1c2VyX2lkJ106CiAgICAgICAgICAgIG1heF9zbG9jcy5hcHBlbmQoCiAgICAgICAgICAgICAgICBiYWNrZW5kX2xpYi5kYXRhYmFzZS5hbmFseXNpc19zdGF0cy5nZXRfbWF4X2FsbG93ZWRfc2xvY3NfZm9yX3VzZXIoZGIsIHByb2plY3RfaW5mb1sndXNlcl9pZCddKSkKICAgIHJldHVybiBtYXgobWF4X3Nsb2NzKQoKCmRlZiBoYXNfdG9vX21hbnlfc2xvY3MoZGF0YWJhc2VfY29ubmVjdGlvbiwgYW5hbHlzaXMpOgogICAgIiIiCiAgICBJbmRpY2F0ZSBpZiBhbiBhbmFseXNpcyBoYXMgdG9vIG1hbnkgc2xvY3MuIFRoZSBhbmFseXNpcyBvYmplY3QgaXMgYSBkaWN0b25hcnkgcHVsbGVkIGZyb20gdGhlCiAgICBkYXRhYmFzZS4KICAgIDpwYXJhbSBkYXRhYmFzZV9jb25uZWN0aW9uOiBjb25uZWN0aW9uIHRvIHRoZSBkYXRhYmFzZQogICAgOnBhcmFtIGFuYWx5c2lzOiB0aGUgZGljdGlvbmFyeSB0aGF0IHJlcHJlc2VudCB0aGUgYW5hbHlzaXMuCiAgICA6cmV0dXJuOgogICAgIiIiCiAgICBpZiBhbmFseXNpcyBpcyBOb25lOgogICAgICAgIHJldHVybiBGYWxzZQoKICAgIGFuYWx5c2lzX2lkID0gYW5hbHlzaXNbImlkIl0KICAgIG1heF9hbGxvd2VkX3Nsb2NzID0gZ2V0X21heF9hbGxvd2VkX3Nsb2NzX2Zvcl9hbmFseXNpcyhkYXRhYmFzZV9jb25uZWN0aW9uLCBhbmFseXNpcykKCiAgICBzbG9jcyA9IGJhY2tlbmRfbGliLmRhdGFiYXNlLmFuYWx5c2lzX3N0YXRzLmdldF9zbG9jc19mb3JfYW5hbHlzaXMoZGF0YWJhc2VfY29ubmVjdGlvbiwgYW5hbHlzaXNfaWQpCgogICAgcmV0dXJuIHNsb2NzID4gbWF4X2FsbG93ZWRfc2xvY3MK";
        String decoded = new String(Base64.getDecoder().decode(encodedCode.getBytes()));
        PythonLexer lexer = new PythonLexer(CharStreams.fromString(decoded));
        CommonTokenStream tokens = new CommonTokenStream(lexer);
        PythonParser parser = new PythonParser(tokens);
        parser.setBuildParseTree(true);
        CodigaVisitor codigaVisitor = new CodigaVisitor(decoded);
        codigaVisitor.visit(parser.root());
        assertEquals(64, codigaVisitor.assignments.size());
        assertEquals(22, codigaVisitor.fromStatements.size());
        assertEquals(32, codigaVisitor.importStatements.size());
        assertEquals(43, codigaVisitor.ifStatements.size());
        assertEquals(5, codigaVisitor.tryStatements.size());
        assertEquals(8, codigaVisitor.forStatements.size());
        assertEquals(13, codigaVisitor.functionDefinitions.size());
        assertEquals(225, codigaVisitor.functionCalls.size());
    }
}

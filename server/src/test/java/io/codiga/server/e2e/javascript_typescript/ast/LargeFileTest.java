package io.codiga.server.e2e.javascript_typescript.ast;

import static org.junit.jupiter.api.Assertions.assertEquals;

import io.codiga.model.EntityChecked;
import io.codiga.model.RuleType;
import io.codiga.server.e2e.E2EBase;
import io.codiga.server.response.Response;
import java.util.Base64;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class LargeFileTest extends E2EBase {

    private static final Logger logger = LoggerFactory.getLogger(LargeFileTest.class);


    String code = "Ci8qKgogKiBDb3B5cmlnaHQgKGMpIE1ldGEgUGxhdGZvcm1zLCBJbmMuIGFuZCBhZmZpbGlhdGVzLgogKgogKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogKi8KCi8qIGdsb2JhbCBCaWdJbnQgKi8KLyogZXNsaW50LWRpc2FibGUgbm8tZm9yLW9mLWxvb3BzL25vLWZvci1vZi1sb29wcyAqLwoKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIENhdGNoIGFsbCBpZGVudGlmaWVycyB0aGF0IGJlZ2luIHdpdGggInVzZSIgZm9sbG93ZWQgYnkgYW4gdXBwZXJjYXNlIExhdGluCiAqIGNoYXJhY3RlciB0byBleGNsdWRlIGlkZW50aWZpZXJzIGxpa2UgInVzZXIiLgogKi8KCmZ1bmN0aW9uIGlzSG9va05hbWUocykgewogIGlmIChfX0VYUEVSSU1FTlRBTF9fKSB7CiAgICByZXR1cm4gcyA9PT0gJ3VzZScgfHwgL151c2VbQS1aMC05XS8udGVzdChzKTsKICB9CiAgcmV0dXJuIC9edXNlW0EtWjAtOV0vLnRlc3Qocyk7Cn0KCi8qKgogKiBXZSBjb25zaWRlciBob29rcyB0byBiZSBhIGhvb2sgbmFtZSBpZGVudGlmaWVyIG9yIGEgbWVtYmVyIGV4cHJlc3Npb24KICogY29udGFpbmluZyBhIGhvb2sgbmFtZS4KICovCgpmdW5jdGlvbiBpc0hvb2sobm9kZSkgewogIGlmIChub2RlLnR5cGUgPT09ICdJZGVudGlmaWVyJykgewogICAgcmV0dXJuIGlzSG9va05hbWUobm9kZS5uYW1lKTsKICB9IGVsc2UgaWYgKAogICAgbm9kZS50eXBlID09PSAnTWVtYmVyRXhwcmVzc2lvbicgJiYKICAgICFub2RlLmNvbXB1dGVkICYmCiAgICBpc0hvb2sobm9kZS5wcm9wZXJ0eSkKICApIHsKICAgIGNvbnN0IG9iaiA9IG5vZGUub2JqZWN0OwogICAgY29uc3QgaXNQYXNjYWxDYXNlTmFtZVNwYWNlID0gL15bQS1aXS4qLzsKICAgIHJldHVybiBvYmoudHlwZSA9PT0gJ0lkZW50aWZpZXInICYmIGlzUGFzY2FsQ2FzZU5hbWVTcGFjZS50ZXN0KG9iai5uYW1lKTsKICB9IGVsc2UgewogICAgcmV0dXJuIGZhbHNlOwogIH0KfQoKLyoqCiAqIENoZWNrcyBpZiB0aGUgbm9kZSBpcyBhIFJlYWN0IGNvbXBvbmVudCBuYW1lLiBSZWFjdCBjb21wb25lbnQgbmFtZXMgbXVzdAogKiBhbHdheXMgc3RhcnQgd2l0aCBhbiB1cHBlcmNhc2UgbGV0dGVyLgogKi8KCmZ1bmN0aW9uIGlzQ29tcG9uZW50TmFtZShub2RlKSB7CiAgcmV0dXJuIG5vZGUudHlwZSA9PT0gJ0lkZW50aWZpZXInICYmIC9eW0EtWl0vLnRlc3Qobm9kZS5uYW1lKTsKfQoKZnVuY3Rpb24gaXNSZWFjdEZ1bmN0aW9uKG5vZGUsIGZ1bmN0aW9uTmFtZSkgewogIHJldHVybiAoCiAgICBub2RlLm5hbWUgPT09IGZ1bmN0aW9uTmFtZSB8fAogICAgKG5vZGUudHlwZSA9PT0gJ01lbWJlckV4cHJlc3Npb24nICYmCiAgICAgIG5vZGUub2JqZWN0Lm5hbWUgPT09ICdSZWFjdCcgJiYKICAgICAgbm9kZS5wcm9wZXJ0eS5uYW1lID09PSBmdW5jdGlvbk5hbWUpCiAgKTsKfQoKLyoqCiAqIENoZWNrcyBpZiB0aGUgbm9kZSBpcyBhIGNhbGxiYWNrIGFyZ3VtZW50IG9mIGZvcndhcmRSZWYuIFRoaXMgcmVuZGVyIGZ1bmN0aW9uCiAqIHNob3VsZCBmb2xsb3cgdGhlIHJ1bGVzIG9mIGhvb2tzLgogKi8KCmZ1bmN0aW9uIGlzRm9yd2FyZFJlZkNhbGxiYWNrKG5vZGUpIHsKICByZXR1cm4gISEoCiAgICBub2RlLnBhcmVudCAmJgogICAgbm9kZS5wYXJlbnQuY2FsbGVlICYmCiAgICBpc1JlYWN0RnVuY3Rpb24obm9kZS5wYXJlbnQuY2FsbGVlLCAnZm9yd2FyZFJlZicpCiAgKTsKfQoKLyoqCiAqIENoZWNrcyBpZiB0aGUgbm9kZSBpcyBhIGNhbGxiYWNrIGFyZ3VtZW50IG9mIFJlYWN0Lm1lbW8uIFRoaXMgYW5vbnltb3VzCiAqIGZ1bmN0aW9uYWwgY29tcG9uZW50IHNob3VsZCBmb2xsb3cgdGhlIHJ1bGVzIG9mIGhvb2tzLgogKi8KCmZ1bmN0aW9uIGlzTWVtb0NhbGxiYWNrKG5vZGUpIHsKICByZXR1cm4gISEoCiAgICBub2RlLnBhcmVudCAmJgogICAgbm9kZS5wYXJlbnQuY2FsbGVlICYmCiAgICBpc1JlYWN0RnVuY3Rpb24obm9kZS5wYXJlbnQuY2FsbGVlLCAnbWVtbycpCiAgKTsKfQoKZnVuY3Rpb24gaXNJbnNpZGVDb21wb25lbnRPckhvb2sobm9kZSkgewogIHdoaWxlIChub2RlKSB7CiAgICBjb25zdCBmdW5jdGlvbk5hbWUgPSBnZXRGdW5jdGlvbk5hbWUobm9kZSk7CiAgICBpZiAoZnVuY3Rpb25OYW1lKSB7CiAgICAgIGlmIChpc0NvbXBvbmVudE5hbWUoZnVuY3Rpb25OYW1lKSB8fCBpc0hvb2soZnVuY3Rpb25OYW1lKSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgICBpZiAoaXNGb3J3YXJkUmVmQ2FsbGJhY2sobm9kZSkgfHwgaXNNZW1vQ2FsbGJhY2sobm9kZSkpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBub2RlID0gbm9kZS5wYXJlbnQ7CiAgfQogIHJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gaXNVc2VFZmZlY3RFdmVudElkZW50aWZpZXIobm9kZSkgewogIGlmIChfX0VYUEVSSU1FTlRBTF9fKSB7CiAgICByZXR1cm4gbm9kZS50eXBlID09PSAnSWRlbnRpZmllcicgJiYgbm9kZS5uYW1lID09PSAndXNlRWZmZWN0RXZlbnQnOwogIH0KICByZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIGlzVXNlSWRlbnRpZmllcihub2RlKSB7CiAgaWYgKF9fRVhQRVJJTUVOVEFMX18pIHsKICAgIHJldHVybiBub2RlLnR5cGUgPT09ICdJZGVudGlmaWVyJyAmJiBub2RlLm5hbWUgPT09ICd1c2UnOwogIH0KICByZXR1cm4gZmFsc2U7Cn0KCmV4cG9ydCBkZWZhdWx0IHsKICBtZXRhOiB7CiAgICB0eXBlOiAncHJvYmxlbScsCiAgICBkb2NzOiB7CiAgICAgIGRlc2NyaXB0aW9uOiAnZW5mb3JjZXMgdGhlIFJ1bGVzIG9mIEhvb2tzJywKICAgICAgcmVjb21tZW5kZWQ6IHRydWUsCiAgICAgIHVybDogJ2h0dHBzOi8vcmVhY3Rqcy5vcmcvZG9jcy9ob29rcy1ydWxlcy5odG1sJywKICAgIH0sCiAgfSwKICBjcmVhdGUoY29udGV4dCkgewogICAgbGV0IGxhc3RFZmZlY3QgPSBudWxsOwogICAgY29uc3QgY29kZVBhdGhSZWFjdEhvb2tzTWFwU3RhY2sgPSBbXTsKICAgIGNvbnN0IGNvZGVQYXRoU2VnbWVudFN0YWNrID0gW107CiAgICBjb25zdCB1c2VFZmZlY3RFdmVudEZ1bmN0aW9ucyA9IG5ldyBXZWFrU2V0KCk7CgogICAgLy8gRm9yIGEgZ2l2ZW4gc2NvcGUsIGl0ZXJhdGUgdGhyb3VnaCB0aGUgcmVmZXJlbmNlcyBhbmQgYWRkIGFsbCB1c2VFZmZlY3RFdmVudCBkZWZpbml0aW9ucy4gV2UgY2FuCiAgICAvLyBkbyB0aGlzIGluIG5vbi1Qcm9ncmFtIG5vZGVzIGJlY2F1c2Ugd2UgY2FuIHJlbHkgb24gdGhlIGFzc3VtcHRpb24gdGhhdCB1c2VFZmZlY3RFdmVudCBmdW5jdGlvbnMKICAgIC8vIGNhbiBvbmx5IGJlIGRlY2xhcmVkIHdpdGhpbiBhIGNvbXBvbmVudCBvciBob29rIGF0IGl0cyB0b3AgbGV2ZWwuCiAgICBmdW5jdGlvbiByZWNvcmRBbGxVc2VFZmZlY3RFdmVudEZ1bmN0aW9ucyhzY29wZSkgewogICAgICBmb3IgKGNvbnN0IHJlZmVyZW5jZSBvZiBzY29wZS5yZWZlcmVuY2VzKSB7CiAgICAgICAgY29uc3QgcGFyZW50ID0gcmVmZXJlbmNlLmlkZW50aWZpZXIucGFyZW50OwogICAgICAgIGlmICgKICAgICAgICAgIHBhcmVudC50eXBlID09PSAnVmFyaWFibGVEZWNsYXJhdG9yJyAmJgogICAgICAgICAgcGFyZW50LmluaXQgJiYKICAgICAgICAgIHBhcmVudC5pbml0LnR5cGUgPT09ICdDYWxsRXhwcmVzc2lvbicgJiYKICAgICAgICAgIHBhcmVudC5pbml0LmNhbGxlZSAmJgogICAgICAgICAgaXNVc2VFZmZlY3RFdmVudElkZW50aWZpZXIocGFyZW50LmluaXQuY2FsbGVlKQogICAgICAgICkgewogICAgICAgICAgZm9yIChjb25zdCByZWYgb2YgcmVmZXJlbmNlLnJlc29sdmVkLnJlZmVyZW5jZXMpIHsKICAgICAgICAgICAgaWYgKHJlZiAhPT0gcmVmZXJlbmNlKSB7CiAgICAgICAgICAgICAgdXNlRWZmZWN0RXZlbnRGdW5jdGlvbnMuYWRkKHJlZi5pZGVudGlmaWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIC8vIE1haW50YWluIGNvZGUgc2VnbWVudCBwYXRoIHN0YWNrIGFzIHdlIHRyYXZlcnNlLgogICAgICBvbkNvZGVQYXRoU2VnbWVudFN0YXJ0OiBzZWdtZW50ID0+IGNvZGVQYXRoU2VnbWVudFN0YWNrLnB1c2goc2VnbWVudCksCiAgICAgIG9uQ29kZVBhdGhTZWdtZW50RW5kOiAoKSA9PiBjb2RlUGF0aFNlZ21lbnRTdGFjay5wb3AoKSwKCiAgICAgIC8vIE1haW50YWluIGNvZGUgcGF0aCBzdGFjayBhcyB3ZSB0cmF2ZXJzZS4KICAgICAgb25Db2RlUGF0aFN0YXJ0OiAoKSA9PiBjb2RlUGF0aFJlYWN0SG9va3NNYXBTdGFjay5wdXNoKG5ldyBNYXAoKSksCgogICAgICAvLyBQcm9jZXNzIG91ciBjb2RlIHBhdGguCiAgICAgIC8vCiAgICAgIC8vIEV2ZXJ5dGhpbmcgaXMgb2sgaWYgYWxsIFJlYWN0IEhvb2tzIGFyZSBib3RoIHJlYWNoYWJsZSBmcm9tIHRoZSBpbml0aWFsCiAgICAgIC8vIHNlZ21lbnQgYW5kIHJlYWNoYWJsZSBmcm9tIGV2ZXJ5IGZpbmFsIHNlZ21lbnQuCiAgICAgIG9uQ29kZVBhdGhFbmQoY29kZVBhdGgsIGNvZGVQYXRoTm9kZSkgewogICAgICAgIGNvbnN0IHJlYWN0SG9va3NNYXAgPSBjb2RlUGF0aFJlYWN0SG9va3NNYXBTdGFjay5wb3AoKTsKICAgICAgICBpZiAocmVhY3RIb29rc01hcC5zaXplID09PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBBbGwgb2YgdGhlIHNlZ21lbnRzIHdoaWNoIGFyZSBjeWNsaWMgYXJlIHJlY29yZGVkIGluIHRoaXMgc2V0LgogICAgICAgIGNvbnN0IGN5Y2xpYyA9IG5ldyBTZXQoKTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQ291bnQgdGhlIG51bWJlciBvZiBjb2RlIHBhdGhzIGZyb20gdGhlIHN0YXJ0IG9mIHRoZSBmdW5jdGlvbiB0byB0aGlzCiAgICAgICAgICogc2VnbWVudC4gRm9yIGV4YW1wbGU6CiAgICAgICAgICoKICAgICAgICAgKiBgYGBqcwogICAgICAgICAqIGZ1bmN0aW9uIE15Q29tcG9uZW50KCkgewogICAgICAgICAqICAgaWYgKGNvbmRpdGlvbikgewogICAgICAgICAqICAgICAvLyBTZWdtZW50IDEKICAgICAgICAgKiAgIH0gZWxzZSB7CiAgICAgICAgICogICAgIC8vIFNlZ21lbnQgMgogICAgICAgICAqICAgfQogICAgICAgICAqICAgLy8gU2VnbWVudCAzCiAgICAgICAgICogfQogICAgICAgICAqIGBgYAogICAgICAgICAqCiAgICAgICAgICogU2VnbWVudHMgMSBhbmQgMiBoYXZlIG9uZSBwYXRoIHRvIHRoZSBiZWdpbm5pbmcgb2YgYE15Q29tcG9uZW50YCBhbmQKICAgICAgICAgKiBzZWdtZW50IDMgaGFzIHR3byBwYXRocyB0byB0aGUgYmVnaW5uaW5nIG9mIGBNeUNvbXBvbmVudGAgc2luY2Ugd2UKICAgICAgICAgKiBjb3VsZCBoYXZlIGVpdGhlciB0YWtlbiB0aGUgcGF0aCBvZiBzZWdtZW50IDEgb3Igc2VnbWVudCAyLgogICAgICAgICAqCiAgICAgICAgICogUG9wdWxhdGVzIGBjeWNsaWNgIHdpdGggY3ljbGljIHNlZ21lbnRzLgogICAgICAgICAqLwoKICAgICAgICBmdW5jdGlvbiBjb3VudFBhdGhzRnJvbVN0YXJ0KHNlZ21lbnQsIHBhdGhIaXN0b3J5KSB7CiAgICAgICAgICBjb25zdCB7Y2FjaGV9ID0gY291bnRQYXRoc0Zyb21TdGFydDsKICAgICAgICAgIGxldCBwYXRocyA9IGNhY2hlLmdldChzZWdtZW50LmlkKTsKICAgICAgICAgIGNvbnN0IHBhdGhMaXN0ID0gbmV3IFNldChwYXRoSGlzdG9yeSk7CgogICAgICAgICAgLy8gSWYgYHBhdGhMaXN0YCBpbmNsdWRlcyB0aGUgY3VycmVudCBzZWdtZW50IHRoZW4gd2UndmUgZm91bmQgYSBjeWNsZSEKICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZmlsbCBgY3ljbGljYCB3aXRoIGFsbCBzZWdtZW50cyBpbnNpZGUgY3ljbGUKICAgICAgICAgIGlmIChwYXRoTGlzdC5oYXMoc2VnbWVudC5pZCkpIHsKICAgICAgICAgICAgY29uc3QgcGF0aEFycmF5ID0gWy4uLnBhdGhMaXN0XTsKICAgICAgICAgICAgY29uc3QgY3ljbGljU2VnbWVudHMgPSBwYXRoQXJyYXkuc2xpY2UoCiAgICAgICAgICAgICAgcGF0aEFycmF5LmluZGV4T2Yoc2VnbWVudC5pZCkgKyAxLAogICAgICAgICAgICApOwogICAgICAgICAgICBmb3IgKGNvbnN0IGN5Y2xpY1NlZ21lbnQgb2YgY3ljbGljU2VnbWVudHMpIHsKICAgICAgICAgICAgICBjeWNsaWMuYWRkKGN5Y2xpY1NlZ21lbnQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gQmlnSW50KCcwJyk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gYWRkIHRoZSBjdXJyZW50IHNlZ21lbnQgdG8gcGF0aExpc3QKICAgICAgICAgIHBhdGhMaXN0LmFkZChzZWdtZW50LmlkKTsKCiAgICAgICAgICAvLyBXZSBoYXZlIGEgY2FjaGVkIGBwYXRoc2AuIFJldHVybiBpdC4KICAgICAgICAgIGlmIChwYXRocyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBwYXRoczsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY29kZVBhdGgudGhyb3duU2VnbWVudHMuaW5jbHVkZXMoc2VnbWVudCkpIHsKICAgICAgICAgICAgcGF0aHMgPSBCaWdJbnQoJzAnKTsKICAgICAgICAgIH0gZWxzZSBpZiAoc2VnbWVudC5wcmV2U2VnbWVudHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHBhdGhzID0gQmlnSW50KCcxJyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYXRocyA9IEJpZ0ludCgnMCcpOwogICAgICAgICAgICBmb3IgKGNvbnN0IHByZXZTZWdtZW50IG9mIHNlZ21lbnQucHJldlNlZ21lbnRzKSB7CiAgICAgICAgICAgICAgcGF0aHMgKz0gY291bnRQYXRoc0Zyb21TdGFydChwcmV2U2VnbWVudCwgcGF0aExpc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gSWYgb3VyIHNlZ21lbnQgaXMgcmVhY2hhYmxlIHRoZW4gdGhlcmUgc2hvdWxkIGJlIGF0IGxlYXN0IG9uZSBwYXRoCiAgICAgICAgICAvLyB0byBpdCBmcm9tIHRoZSBzdGFydCBvZiBvdXIgY29kZSBwYXRoLgogICAgICAgICAgaWYgKHNlZ21lbnQucmVhY2hhYmxlICYmIHBhdGhzID09PSBCaWdJbnQoJzAnKSkgewogICAgICAgICAgICBjYWNoZS5kZWxldGUoc2VnbWVudC5pZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjYWNoZS5zZXQoc2VnbWVudC5pZCwgcGF0aHMpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBwYXRoczsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIENvdW50IHRoZSBudW1iZXIgb2YgY29kZSBwYXRocyBmcm9tIHRoaXMgc2VnbWVudCB0byB0aGUgZW5kIG9mIHRoZQogICAgICAgICAqIGZ1bmN0aW9uLiBGb3IgZXhhbXBsZToKICAgICAgICAgKgogICAgICAgICAqIGBgYGpzCiAgICAgICAgICogZnVuY3Rpb24gTXlDb21wb25lbnQoKSB7CiAgICAgICAgICogICAvLyBTZWdtZW50IDEKICAgICAgICAgKiAgIGlmIChjb25kaXRpb24pIHsKICAgICAgICAgKiAgICAgLy8gU2VnbWVudCAyCiAgICAgICAgICogICB9IGVsc2UgewogICAgICAgICAqICAgICAvLyBTZWdtZW50IDMKICAgICAgICAgKiAgIH0KICAgICAgICAgKiB9CiAgICAgICAgICogYGBgCiAgICAgICAgICoKICAgICAgICAgKiBTZWdtZW50cyAyIGFuZCAzIGhhdmUgb25lIHBhdGggdG8gdGhlIGVuZCBvZiBgTXlDb21wb25lbnRgIGFuZAogICAgICAgICAqIHNlZ21lbnQgMSBoYXMgdHdvIHBhdGhzIHRvIHRoZSBlbmQgb2YgYE15Q29tcG9uZW50YCBzaW5jZSB3ZSBjb3VsZAogICAgICAgICAqIGVpdGhlciB0YWtlIHRoZSBwYXRoIG9mIHNlZ21lbnQgMSBvciBzZWdtZW50IDIuCiAgICAgICAgICoKICAgICAgICAgKiBQb3B1bGF0ZXMgYGN5Y2xpY2Agd2l0aCBjeWNsaWMgc2VnbWVudHMuCiAgICAgICAgICovCgogICAgICAgIGZ1bmN0aW9uIGNvdW50UGF0aHNUb0VuZChzZWdtZW50LCBwYXRoSGlzdG9yeSkgewogICAgICAgICAgY29uc3Qge2NhY2hlfSA9IGNvdW50UGF0aHNUb0VuZDsKICAgICAgICAgIGxldCBwYXRocyA9IGNhY2hlLmdldChzZWdtZW50LmlkKTsKICAgICAgICAgIGNvbnN0IHBhdGhMaXN0ID0gbmV3IFNldChwYXRoSGlzdG9yeSk7CgogICAgICAgICAgLy8gSWYgYHBhdGhMaXN0YCBpbmNsdWRlcyB0aGUgY3VycmVudCBzZWdtZW50IHRoZW4gd2UndmUgZm91bmQgYSBjeWNsZSEKICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZmlsbCBgY3ljbGljYCB3aXRoIGFsbCBzZWdtZW50cyBpbnNpZGUgY3ljbGUKICAgICAgICAgIGlmIChwYXRoTGlzdC5oYXMoc2VnbWVudC5pZCkpIHsKICAgICAgICAgICAgY29uc3QgcGF0aEFycmF5ID0gQXJyYXkuZnJvbShwYXRoTGlzdCk7CiAgICAgICAgICAgIGNvbnN0IGN5Y2xpY1NlZ21lbnRzID0gcGF0aEFycmF5LnNsaWNlKAogICAgICAgICAgICAgIHBhdGhBcnJheS5pbmRleE9mKHNlZ21lbnQuaWQpICsgMSwKICAgICAgICAgICAgKTsKICAgICAgICAgICAgZm9yIChjb25zdCBjeWNsaWNTZWdtZW50IG9mIGN5Y2xpY1NlZ21lbnRzKSB7CiAgICAgICAgICAgICAgY3ljbGljLmFkZChjeWNsaWNTZWdtZW50KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIEJpZ0ludCgnMCcpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIGFkZCB0aGUgY3VycmVudCBzZWdtZW50IHRvIHBhdGhMaXN0CiAgICAgICAgICBwYXRoTGlzdC5hZGQoc2VnbWVudC5pZCk7CgogICAgICAgICAgLy8gV2UgaGF2ZSBhIGNhY2hlZCBgcGF0aHNgLiBSZXR1cm4gaXQuCiAgICAgICAgICBpZiAocGF0aHMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gcGF0aHM7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGNvZGVQYXRoLnRocm93blNlZ21lbnRzLmluY2x1ZGVzKHNlZ21lbnQpKSB7CiAgICAgICAgICAgIHBhdGhzID0gQmlnSW50KCcwJyk7CiAgICAgICAgICB9IGVsc2UgaWYgKHNlZ21lbnQubmV4dFNlZ21lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBwYXRocyA9IEJpZ0ludCgnMScpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGF0aHMgPSBCaWdJbnQoJzAnKTsKICAgICAgICAgICAgZm9yIChjb25zdCBuZXh0U2VnbWVudCBvZiBzZWdtZW50Lm5leHRTZWdtZW50cykgewogICAgICAgICAgICAgIHBhdGhzICs9IGNvdW50UGF0aHNUb0VuZChuZXh0U2VnbWVudCwgcGF0aExpc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgY2FjaGUuc2V0KHNlZ21lbnQuaWQsIHBhdGhzKTsKICAgICAgICAgIHJldHVybiBwYXRoczsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHNob3J0ZXN0IHBhdGggbGVuZ3RoIHRvIHRoZSBzdGFydCBvZiBhIGNvZGUgcGF0aC4KICAgICAgICAgKiBGb3IgZXhhbXBsZToKICAgICAgICAgKgogICAgICAgICAqIGBgYGpzCiAgICAgICAgICogZnVuY3Rpb24gTXlDb21wb25lbnQoKSB7CiAgICAgICAgICogICBpZiAoY29uZGl0aW9uKSB7CiAgICAgICAgICogICAgIC8vIFNlZ21lbnQgMQogICAgICAgICAqICAgfQogICAgICAgICAqICAgLy8gU2VnbWVudCAyCiAgICAgICAgICogfQogICAgICAgICAqIGBgYAogICAgICAgICAqCiAgICAgICAgICogVGhlcmUgaXMgb25seSBvbmUgcGF0aCBmcm9tIHNlZ21lbnQgMSB0byB0aGUgY29kZSBwYXRoIHN0YXJ0LiBJdHMKICAgICAgICAgKiBsZW5ndGggaXMgb25lIHNvIHRoYXQgaXMgdGhlIHNob3J0ZXN0IHBhdGguCiAgICAgICAgICoKICAgICAgICAgKiBUaGVyZSBhcmUgdHdvIHBhdGhzIGZyb20gc2VnbWVudCAyIHRvIHRoZSBjb2RlIHBhdGggc3RhcnQuIE9uZQogICAgICAgICAqIHRocm91Z2ggc2VnbWVudCAxIHdpdGggYSBsZW5ndGggb2YgdHdvIGFuZCBhbm90aGVyIGRpcmVjdGx5IHRvIHRoZQogICAgICAgICAqIHN0YXJ0IHdpdGggYSBsZW5ndGggb2Ygb25lLiBUaGUgc2hvcnRlc3QgcGF0aCBoYXMgYSBsZW5ndGggb2Ygb25lCiAgICAgICAgICogc28gd2Ugd291bGQgcmV0dXJuIHRoYXQuCiAgICAgICAgICovCgogICAgICAgIGZ1bmN0aW9uIHNob3J0ZXN0UGF0aExlbmd0aFRvU3RhcnQoc2VnbWVudCkgewogICAgICAgICAgY29uc3Qge2NhY2hlfSA9IHNob3J0ZXN0UGF0aExlbmd0aFRvU3RhcnQ7CiAgICAgICAgICBsZXQgbGVuZ3RoID0gY2FjaGUuZ2V0KHNlZ21lbnQuaWQpOwoKICAgICAgICAgIC8vIElmIGBsZW5ndGhgIGlzIG51bGwgdGhlbiB3ZSBmb3VuZCBhIGN5Y2xlISBSZXR1cm4gaW5maW5pdHkgc2luY2UKICAgICAgICAgIC8vIHRoZSBzaG9ydGVzdCBwYXRoIGlzIGRlZmluaXRlbHkgbm90IHRoZSBvbmUgd2hlcmUgd2UgbG9vcGVkLgogICAgICAgICAgaWYgKGxlbmd0aCA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gSW5maW5pdHk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gV2UgaGF2ZSBhIGNhY2hlZCBgbGVuZ3RoYC4gUmV0dXJuIGl0LgogICAgICAgICAgaWYgKGxlbmd0aCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBsZW5ndGg7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQ29tcHV0ZSBgbGVuZ3RoYCBhbmQgY2FjaGUgaXQuIEd1YXJkaW5nIGFnYWluc3QgY3ljbGVzLgogICAgICAgICAgY2FjaGUuc2V0KHNlZ21lbnQuaWQsIG51bGwpOwogICAgICAgICAgaWYgKHNlZ21lbnQucHJldlNlZ21lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBsZW5ndGggPSAxOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGVuZ3RoID0gSW5maW5pdHk7CiAgICAgICAgICAgIGZvciAoY29uc3QgcHJldlNlZ21lbnQgb2Ygc2VnbWVudC5wcmV2U2VnbWVudHMpIHsKICAgICAgICAgICAgICBjb25zdCBwcmV2TGVuZ3RoID0gc2hvcnRlc3RQYXRoTGVuZ3RoVG9TdGFydChwcmV2U2VnbWVudCk7CiAgICAgICAgICAgICAgaWYgKHByZXZMZW5ndGggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIGxlbmd0aCA9IHByZXZMZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGxlbmd0aCArPSAxOwogICAgICAgICAgfQogICAgICAgICAgY2FjaGUuc2V0KHNlZ21lbnQuaWQsIGxlbmd0aCk7CiAgICAgICAgICByZXR1cm4gbGVuZ3RoOwogICAgICAgIH0KCiAgICAgICAgY291bnRQYXRoc0Zyb21TdGFydC5jYWNoZSA9IG5ldyBNYXAoKTsKICAgICAgICBjb3VudFBhdGhzVG9FbmQuY2FjaGUgPSBuZXcgTWFwKCk7CiAgICAgICAgc2hvcnRlc3RQYXRoTGVuZ3RoVG9TdGFydC5jYWNoZSA9IG5ldyBNYXAoKTsKCiAgICAgICAgLy8gQ291bnQgYWxsIGNvZGUgcGF0aHMgdG8gdGhlIGVuZCBvZiBvdXIgY29tcG9uZW50L2hvb2suIEFsc28gcHJpbWVzCiAgICAgICAgLy8gdGhlIGBjb3VudFBhdGhzVG9FbmRgIGNhY2hlLgogICAgICAgIGNvbnN0IGFsbFBhdGhzRnJvbVN0YXJ0VG9FbmQgPSBjb3VudFBhdGhzVG9FbmQoY29kZVBhdGguaW5pdGlhbFNlZ21lbnQpOwoKICAgICAgICAvLyBHZXRzIHRoZSBmdW5jdGlvbiBuYW1lIGZvciBvdXIgY29kZSBwYXRoLiBJZiB0aGUgZnVuY3Rpb24gbmFtZSBpcwogICAgICAgIC8vIGB1bmRlZmluZWRgIHRoZW4gd2Uga25vdyBlaXRoZXIgdGhhdCB3ZSBoYXZlIGFuIGFub255bW91cyBmdW5jdGlvbgogICAgICAgIC8vIGV4cHJlc3Npb24gb3Igb3VyIGNvZGUgcGF0aCBpcyBub3QgaW4gYSBmdW5jdGlvbi4gSW4gYm90aCBjYXNlcyB3ZQogICAgICAgIC8vIHdpbGwgd2FudCB0byBlcnJvciBzaW5jZSBuZWl0aGVyIGFyZSBSZWFjdCBmdW5jdGlvbiBjb21wb25lbnRzIG9yCiAgICAgICAgLy8gaG9vayBmdW5jdGlvbnMgLSB1bmxlc3MgaXQgaXMgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIGFyZ3VtZW50IHRvCiAgICAgICAgLy8gZm9yd2FyZFJlZiBvciBtZW1vLgogICAgICAgIGNvbnN0IGNvZGVQYXRoRnVuY3Rpb25OYW1lID0gZ2V0RnVuY3Rpb25OYW1lKGNvZGVQYXRoTm9kZSk7CgogICAgICAgIC8vIFRoaXMgaXMgYSB2YWxpZCBjb2RlIHBhdGggZm9yIFJlYWN0IGhvb2tzIGlmIHdlIGFyZSBkaXJlY3RseSBpbiBhIFJlYWN0CiAgICAgICAgLy8gZnVuY3Rpb24gY29tcG9uZW50IG9yIHdlIGFyZSBpbiBhIGhvb2sgZnVuY3Rpb24uCiAgICAgICAgY29uc3QgaXNTb21ld2hlcmVJbnNpZGVDb21wb25lbnRPckhvb2sgPSBpc0luc2lkZUNvbXBvbmVudE9ySG9vaygKICAgICAgICAgIGNvZGVQYXRoTm9kZSwKICAgICAgICApOwogICAgICAgIGNvbnN0IGlzRGlyZWN0bHlJbnNpZGVDb21wb25lbnRPckhvb2sgPSBjb2RlUGF0aEZ1bmN0aW9uTmFtZQogICAgICAgICAgPyBpc0NvbXBvbmVudE5hbWUoY29kZVBhdGhGdW5jdGlvbk5hbWUpIHx8CiAgICAgICAgICAgIGlzSG9vayhjb2RlUGF0aEZ1bmN0aW9uTmFtZSkKICAgICAgICAgIDogaXNGb3J3YXJkUmVmQ2FsbGJhY2soY29kZVBhdGhOb2RlKSB8fCBpc01lbW9DYWxsYmFjayhjb2RlUGF0aE5vZGUpOwoKICAgICAgICAvLyBDb21wdXRlIHRoZSBlYXJsaWVzdCBmaW5hbGl6ZXIgbGV2ZWwgdXNpbmcgaW5mb3JtYXRpb24gZnJvbSB0aGUKICAgICAgICAvLyBjYWNoZS4gV2UgZXhwZWN0IGFsbCByZWFjaGFibGUgZmluYWwgc2VnbWVudHMgdG8gaGF2ZSBhIGNhY2hlIGVudHJ5CiAgICAgICAgLy8gYWZ0ZXIgY2FsbGluZyBgdmlzaXRTZWdtZW50KClgLgogICAgICAgIGxldCBzaG9ydGVzdEZpbmFsUGF0aExlbmd0aCA9IEluZmluaXR5OwogICAgICAgIGZvciAoY29uc3QgZmluYWxTZWdtZW50IG9mIGNvZGVQYXRoLmZpbmFsU2VnbWVudHMpIHsKICAgICAgICAgIGlmICghZmluYWxTZWdtZW50LnJlYWNoYWJsZSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHNob3J0ZXN0UGF0aExlbmd0aFRvU3RhcnQoZmluYWxTZWdtZW50KTsKICAgICAgICAgIGlmIChsZW5ndGggPCBzaG9ydGVzdEZpbmFsUGF0aExlbmd0aCkgewogICAgICAgICAgICBzaG9ydGVzdEZpbmFsUGF0aExlbmd0aCA9IGxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE1ha2Ugc3VyZSBhbGwgUmVhY3QgSG9va3MgcGFzcyBvdXIgbGludCBpbnZhcmlhbnRzLiBMb2cgd2FybmluZ3MKICAgICAgICAvLyBpZiBub3QuCiAgICAgICAgZm9yIChjb25zdCBbc2VnbWVudCwgcmVhY3RIb29rc10gb2YgcmVhY3RIb29rc01hcCkgewogICAgICAgICAgLy8gTk9URTogV2UgY291bGQgcmVwb3J0IGhlcmUgdGhhdCB0aGUgaG9vayBpcyBub3QgcmVhY2hhYmxlLCBidXQKICAgICAgICAgIC8vIHRoYXQgd291bGQgYmUgcmVkdW5kYW50IHdpdGggbW9yZSBnZW5lcmFsICJubyB1bnJlYWNoYWJsZSIKICAgICAgICAgIC8vIGxpbnQgcnVsZXMuCiAgICAgICAgICBpZiAoIXNlZ21lbnQucmVhY2hhYmxlKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIElmIHRoZXJlIGFyZSBhbnkgZmluYWwgc2VnbWVudHMgd2l0aCBhIHNob3J0ZXIgcGF0aCB0byBzdGFydCB0aGVuCiAgICAgICAgICAvLyB3ZSBwb3NzaWJseSBoYXZlIGFuIGVhcmx5IHJldHVybi4KICAgICAgICAgIC8vCiAgICAgICAgICAvLyBJZiBvdXIgc2VnbWVudCBpcyBhIGZpbmFsIHNlZ21lbnQgaXRzZWxmIHRoZW4gc2libGluZ3MgY291bGQKICAgICAgICAgIC8vIHBvc3NpYmx5IGJlIGVhcmx5IHJldHVybnMuCiAgICAgICAgICBjb25zdCBwb3NzaWJseUhhc0Vhcmx5UmV0dXJuID0KICAgICAgICAgICAgc2VnbWVudC5uZXh0U2VnbWVudHMubGVuZ3RoID09PSAwCiAgICAgICAgICAgICAgPyBzaG9ydGVzdEZpbmFsUGF0aExlbmd0aCA8PSBzaG9ydGVzdFBhdGhMZW5ndGhUb1N0YXJ0KHNlZ21lbnQpCiAgICAgICAgICAgICAgOiBzaG9ydGVzdEZpbmFsUGF0aExlbmd0aCA8IHNob3J0ZXN0UGF0aExlbmd0aFRvU3RhcnQoc2VnbWVudCk7CgogICAgICAgICAgLy8gQ291bnQgYWxsIHRoZSBwYXRocyBmcm9tIHRoZSBzdGFydCBvZiBvdXIgY29kZSBwYXRoIHRvIHRoZSBlbmQgb2YKICAgICAgICAgIC8vIG91ciBjb2RlIHBhdGggdGhhdCBnbyBfdGhyb3VnaF8gdGhpcyBzZWdtZW50LiBUaGUgY3JpdGljYWwgcGllY2UKICAgICAgICAgIC8vIG9mIHRoaXMgaXMgX3Rocm91Z2hfLiBJZiB3ZSBqdXN0IGNhbGwgYGNvdW50UGF0aHNUb0VuZChzZWdtZW50KWAKICAgICAgICAgIC8vIHRoZW4gd2UgbmVnbGVjdCB0aGF0IHdlIG1heSBoYXZlIGdvbmUgdGhyb3VnaCBtdWx0aXBsZSBwYXRocyB0byBnZXQKICAgICAgICAgIC8vIHRvIHRoaXMgcG9pbnQhIENvbnNpZGVyOgogICAgICAgICAgLy8KICAgICAgICAgIC8vIGBgYGpzCiAgICAgICAgICAvLyBmdW5jdGlvbiBNeUNvbXBvbmVudCgpIHsKICAgICAgICAgIC8vICAgaWYgKGEpIHsKICAgICAgICAgIC8vICAgICAvLyBTZWdtZW50IDEKICAgICAgICAgIC8vICAgfSBlbHNlIHsKICAgICAgICAgIC8vICAgICAvLyBTZWdtZW50IDIKICAgICAgICAgIC8vICAgfQogICAgICAgICAgLy8gICAvLyBTZWdtZW50IDMKICAgICAgICAgIC8vICAgaWYgKGIpIHsKICAgICAgICAgIC8vICAgICAvLyBTZWdtZW50IDQKICAgICAgICAgIC8vICAgfSBlbHNlIHsKICAgICAgICAgIC8vICAgICAvLyBTZWdtZW50IDUKICAgICAgICAgIC8vICAgfQogICAgICAgICAgLy8gfQogICAgICAgICAgLy8gYGBgCiAgICAgICAgICAvLwogICAgICAgICAgLy8gSW4gdGhpcyBjb21wb25lbnQgd2UgaGF2ZSBmb3VyIGNvZGUgcGF0aHM6CiAgICAgICAgICAvLwogICAgICAgICAgLy8gMS4gYGEgPSB0cnVlOyBiID0gdHJ1ZWAKICAgICAgICAgIC8vIDIuIGBhID0gdHJ1ZTsgYiA9IGZhbHNlYAogICAgICAgICAgLy8gMy4gYGEgPSBmYWxzZTsgYiA9IHRydWVgCiAgICAgICAgICAvLyA0LiBgYSA9IGZhbHNlOyBiID0gZmFsc2VgCiAgICAgICAgICAvLwogICAgICAgICAgLy8gRnJvbSBzZWdtZW50IDMgdGhlcmUgYXJlIHR3byBjb2RlIHBhdGhzIHRvIHRoZSBlbmQgdGhyb3VnaCBzZWdtZW50CiAgICAgICAgICAvLyA0IGFuZCBzZWdtZW50IDUuIEhvd2V2ZXIsIHdlIHRvb2sgdHdvIHBhdGhzIHRvIGdldCBoZXJlIHRocm91Z2gKICAgICAgICAgIC8vIHNlZ21lbnQgMSBhbmQgc2VnbWVudCAyLgogICAgICAgICAgLy8KICAgICAgICAgIC8vIElmIHdlIG11bHRpcGx5IHRoZSBwYXRocyBmcm9tIHN0YXJ0ICh0d28pIGJ5IHRoZSBwYXRocyB0byBlbmQgKHR3bykKICAgICAgICAgIC8vIGZvciBzZWdtZW50IDMgd2UgZ2V0IGZvdXIuIFdoaWNoIGlzIG91ciBkZXNpcmVkIGNvdW50LgogICAgICAgICAgY29uc3QgcGF0aHNGcm9tU3RhcnRUb0VuZCA9CiAgICAgICAgICAgIGNvdW50UGF0aHNGcm9tU3RhcnQoc2VnbWVudCkgKiBjb3VudFBhdGhzVG9FbmQoc2VnbWVudCk7CgogICAgICAgICAgLy8gSXMgdGhpcyBob29rIGEgcGFydCBvZiBhIGN5Y2xpYyBzZWdtZW50PwogICAgICAgICAgY29uc3QgY3ljbGVkID0gY3ljbGljLmhhcyhzZWdtZW50LmlkKTsKCiAgICAgICAgICBmb3IgKGNvbnN0IGhvb2sgb2YgcmVhY3RIb29rcykgewogICAgICAgICAgICAvLyBSZXBvcnQgYW4gZXJyb3IgaWYgYSBob29rIG1heSBiZSBjYWxsZWQgbW9yZSB0aGVuIG9uY2UuCiAgICAgICAgICAgIC8vIGB1c2UoLi4uKWAgY2FuIGJlIGNhbGxlZCBpbiBsb29wcy4KICAgICAgICAgICAgaWYgKGN5Y2xlZCAmJiAhaXNVc2VJZGVudGlmaWVyKGhvb2spKSB7CiAgICAgICAgICAgICAgY29udGV4dC5yZXBvcnQoewogICAgICAgICAgICAgICAgbm9kZTogaG9vaywKICAgICAgICAgICAgICAgIG1lc3NhZ2U6CiAgICAgICAgICAgICAgICAgIGBSZWFjdCBIb29rICIke2NvbnRleHQuZ2V0U291cmNlKGhvb2spfSIgbWF5IGJlIGV4ZWN1dGVkIGAgKwogICAgICAgICAgICAgICAgICAnbW9yZSB0aGFuIG9uY2UuIFBvc3NpYmx5IGJlY2F1c2UgaXQgaXMgY2FsbGVkIGluIGEgbG9vcC4gJyArCiAgICAgICAgICAgICAgICAgICdSZWFjdCBIb29rcyBtdXN0IGJlIGNhbGxlZCBpbiB0aGUgZXhhY3Qgc2FtZSBvcmRlciBpbiAnICsKICAgICAgICAgICAgICAgICAgJ2V2ZXJ5IGNvbXBvbmVudCByZW5kZXIuJywKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSWYgdGhpcyBpcyBub3QgYSB2YWxpZCBjb2RlIHBhdGggZm9yIFJlYWN0IGhvb2tzIHRoZW4gd2UgbmVlZCB0bwogICAgICAgICAgICAvLyBsb2cgYSB3YXJuaW5nIGZvciBldmVyeSBob29rIGluIHRoaXMgY29kZSBwYXRoLgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBQaWNrIGEgc3BlY2lhbCBtZXNzYWdlIGRlcGVuZGluZyBvbiB0aGUgc2NvcGUgdGhpcyBob29rIHdhcwogICAgICAgICAgICAvLyBjYWxsZWQgaW4uCiAgICAgICAgICAgIGlmIChpc0RpcmVjdGx5SW5zaWRlQ29tcG9uZW50T3JIb29rKSB7CiAgICAgICAgICAgICAgLy8gUmVwb3J0IGFuIGVycm9yIGlmIGEgaG9vayBkb2VzIG5vdCByZWFjaCBhbGwgZmluYWxpemluZyBjb2RlCiAgICAgICAgICAgICAgLy8gcGF0aCBzZWdtZW50cy4KICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgIC8vIFNwZWNpYWwgY2FzZSB3aGVuIHdlIHRoaW5rIHRoZXJlIG1pZ2h0IGJlIGFuIGVhcmx5IHJldHVybi4KICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAhY3ljbGVkICYmCiAgICAgICAgICAgICAgICBwYXRoc0Zyb21TdGFydFRvRW5kICE9PSBhbGxQYXRoc0Zyb21TdGFydFRvRW5kICYmCiAgICAgICAgICAgICAgICAhaXNVc2VJZGVudGlmaWVyKGhvb2spIC8vIGB1c2UoLi4uKWAgY2FuIGJlIGNhbGxlZCBjb25kaXRpb25hbGx5LgogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9CiAgICAgICAgICAgICAgICAgIGBSZWFjdCBIb29rICIke2NvbnRleHQuZ2V0U291cmNlKGhvb2spfSIgaXMgY2FsbGVkIGAgKwogICAgICAgICAgICAgICAgICAnY29uZGl0aW9uYWxseS4gUmVhY3QgSG9va3MgbXVzdCBiZSBjYWxsZWQgaW4gdGhlIGV4YWN0ICcgKwogICAgICAgICAgICAgICAgICAnc2FtZSBvcmRlciBpbiBldmVyeSBjb21wb25lbnQgcmVuZGVyLicgKwogICAgICAgICAgICAgICAgICAocG9zc2libHlIYXNFYXJseVJldHVybgogICAgICAgICAgICAgICAgICAgID8gJyBEaWQgeW91IGFjY2lkZW50YWxseSBjYWxsIGEgUmVhY3QgSG9vayBhZnRlciBhbicgKwogICAgICAgICAgICAgICAgICAgICAgJyBlYXJseSByZXR1cm4/JwogICAgICAgICAgICAgICAgICAgIDogJycpOwogICAgICAgICAgICAgICAgY29udGV4dC5yZXBvcnQoe25vZGU6IGhvb2ssIG1lc3NhZ2V9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgY29kZVBhdGhOb2RlLnBhcmVudCAmJgogICAgICAgICAgICAgIChjb2RlUGF0aE5vZGUucGFyZW50LnR5cGUgPT09ICdNZXRob2REZWZpbml0aW9uJyB8fAogICAgICAgICAgICAgICAgY29kZVBhdGhOb2RlLnBhcmVudC50eXBlID09PSAnQ2xhc3NQcm9wZXJ0eScpICYmCiAgICAgICAgICAgICAgY29kZVBhdGhOb2RlLnBhcmVudC52YWx1ZSA9PT0gY29kZVBhdGhOb2RlCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIC8vIEN1c3RvbSBtZXNzYWdlIGZvciBob29rcyBpbnNpZGUgYSBjbGFzcwogICAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPQogICAgICAgICAgICAgICAgYFJlYWN0IEhvb2sgIiR7Y29udGV4dC5nZXRTb3VyY2UoaG9vayl9IiBjYW5ub3QgYmUgY2FsbGVkIGAgKwogICAgICAgICAgICAgICAgJ2luIGEgY2xhc3MgY29tcG9uZW50LiBSZWFjdCBIb29rcyBtdXN0IGJlIGNhbGxlZCBpbiBhICcgKwogICAgICAgICAgICAgICAgJ1JlYWN0IGZ1bmN0aW9uIGNvbXBvbmVudCBvciBhIGN1c3RvbSBSZWFjdCBIb29rIGZ1bmN0aW9uLic7CiAgICAgICAgICAgICAgY29udGV4dC5yZXBvcnQoe25vZGU6IGhvb2ssIG1lc3NhZ2V9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjb2RlUGF0aEZ1bmN0aW9uTmFtZSkgewogICAgICAgICAgICAgIC8vIEN1c3RvbSBtZXNzYWdlIGlmIHdlIGZvdW5kIGFuIGludmFsaWQgZnVuY3Rpb24gbmFtZS4KICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlID0KICAgICAgICAgICAgICAgIGBSZWFjdCBIb29rICIke2NvbnRleHQuZ2V0U291cmNlKGhvb2spfSIgaXMgY2FsbGVkIGluIGAgKwogICAgICAgICAgICAgICAgYGZ1bmN0aW9uICIke2NvbnRleHQuZ2V0U291cmNlKGNvZGVQYXRoRnVuY3Rpb25OYW1lKX0iIGAgKwogICAgICAgICAgICAgICAgJ3RoYXQgaXMgbmVpdGhlciBhIFJlYWN0IGZ1bmN0aW9uIGNvbXBvbmVudCBub3IgYSBjdXN0b20gJyArCiAgICAgICAgICAgICAgICAnUmVhY3QgSG9vayBmdW5jdGlvbi4nICsKICAgICAgICAgICAgICAgICcgUmVhY3QgY29tcG9uZW50IG5hbWVzIG11c3Qgc3RhcnQgd2l0aCBhbiB1cHBlcmNhc2UgbGV0dGVyLicgKwogICAgICAgICAgICAgICAgJyBSZWFjdCBIb29rIG5hbWVzIG11c3Qgc3RhcnQgd2l0aCB0aGUgd29yZCAidXNlIi4nOwogICAgICAgICAgICAgIGNvbnRleHQucmVwb3J0KHtub2RlOiBob29rLCBtZXNzYWdlfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY29kZVBhdGhOb2RlLnR5cGUgPT09ICdQcm9ncmFtJykgewogICAgICAgICAgICAgIC8vIFRoZXNlIGFyZSBkYW5nZXJvdXMgaWYgeW91IGhhdmUgaW5saW5lIHJlcXVpcmVzIGVuYWJsZWQuCiAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9CiAgICAgICAgICAgICAgICBgUmVhY3QgSG9vayAiJHtjb250ZXh0LmdldFNvdXJjZShob29rKX0iIGNhbm5vdCBiZSBjYWxsZWQgYCArCiAgICAgICAgICAgICAgICAnYXQgdGhlIHRvcCBsZXZlbC4gUmVhY3QgSG9va3MgbXVzdCBiZSBjYWxsZWQgaW4gYSAnICsKICAgICAgICAgICAgICAgICdSZWFjdCBmdW5jdGlvbiBjb21wb25lbnQgb3IgYSBjdXN0b20gUmVhY3QgSG9vayBmdW5jdGlvbi4nOwogICAgICAgICAgICAgIGNvbnRleHQucmVwb3J0KHtub2RlOiBob29rLCBtZXNzYWdlfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gQXNzdW1lIGluIGFsbCBvdGhlciBjYXNlcyB0aGUgdXNlciBjYWxsZWQgYSBob29rIGluIHNvbWUKICAgICAgICAgICAgICAvLyByYW5kb20gZnVuY3Rpb24gY2FsbGJhY2suIFRoaXMgc2hvdWxkIHVzdWFsbHkgYmUgdHJ1ZSBmb3IKICAgICAgICAgICAgICAvLyBhbm9ueW1vdXMgZnVuY3Rpb24gZXhwcmVzc2lvbnMuIEhvcGVmdWxseSB0aGlzIGlzIGNsYXJpZnlpbmcKICAgICAgICAgICAgICAvLyBlbm91Z2ggaW4gdGhlIGNvbW1vbiBjYXNlIHRoYXQgdGhlIGluY29ycmVjdCBtZXNzYWdlIGluCiAgICAgICAgICAgICAgLy8gdW5jb21tb24gY2FzZXMgZG9lc24ndCBtYXR0ZXIuCiAgICAgICAgICAgICAgLy8gYHVzZSguLi4pYCBjYW4gYmUgY2FsbGVkIGluIGNhbGxiYWNrcy4KICAgICAgICAgICAgICBpZiAoaXNTb21ld2hlcmVJbnNpZGVDb21wb25lbnRPckhvb2sgJiYgIWlzVXNlSWRlbnRpZmllcihob29rKSkgewogICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9CiAgICAgICAgICAgICAgICAgIGBSZWFjdCBIb29rICIke2NvbnRleHQuZ2V0U291cmNlKGhvb2spfSIgY2Fubm90IGJlIGNhbGxlZCBgICsKICAgICAgICAgICAgICAgICAgJ2luc2lkZSBhIGNhbGxiYWNrLiBSZWFjdCBIb29rcyBtdXN0IGJlIGNhbGxlZCBpbiBhICcgKwogICAgICAgICAgICAgICAgICAnUmVhY3QgZnVuY3Rpb24gY29tcG9uZW50IG9yIGEgY3VzdG9tIFJlYWN0IEhvb2sgZnVuY3Rpb24uJzsKICAgICAgICAgICAgICAgIGNvbnRleHQucmVwb3J0KHtub2RlOiBob29rLCBtZXNzYWdlfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLy8gTWlzc2VkIG9wcG9ydHVuaXR5Li4uV2UgY291bGQgdmlzaXQgYWxsIGBJZGVudGlmaWVyYHMgaW5zdGVhZCBvZiBhbGwKICAgICAgLy8gYENhbGxFeHByZXNzaW9uYHMgYW5kIGNoZWNrIHRoYXQgX2V2ZXJ5IHVzZV8gb2YgYSBob29rIG5hbWUgaXMgdmFsaWQuCiAgICAgIC8vIEJ1dCB0aGF0IGdldHMgY29tcGxpY2F0ZWQgYW5kIGVudGVycyB0eXBlLXN5c3RlbSB0ZXJyaXRvcnksIHNvIHdlJ3JlCiAgICAgIC8vIG9ubHkgYmVpbmcgc3RyaWN0IGFib3V0IGhvb2sgY2FsbHMgZm9yIG5vdy4KICAgICAgQ2FsbEV4cHJlc3Npb24obm9kZSkgewogICAgICAgIGlmIChpc0hvb2sobm9kZS5jYWxsZWUpKSB7CiAgICAgICAgICAvLyBBZGQgdGhlIGhvb2sgbm9kZSB0byBhIG1hcCBrZXllZCBieSB0aGUgY29kZSBwYXRoIHNlZ21lbnQuIFdlIHdpbGwKICAgICAgICAgIC8vIGRvIGZ1bGwgY29kZSBwYXRoIGFuYWx5c2lzIGF0IHRoZSBlbmQgb2Ygb3VyIGNvZGUgcGF0aC4KICAgICAgICAgIGNvbnN0IHJlYWN0SG9va3NNYXAgPSBsYXN0KGNvZGVQYXRoUmVhY3RIb29rc01hcFN0YWNrKTsKICAgICAgICAgIGNvbnN0IGNvZGVQYXRoU2VnbWVudCA9IGxhc3QoY29kZVBhdGhTZWdtZW50U3RhY2spOwogICAgICAgICAgbGV0IHJlYWN0SG9va3MgPSByZWFjdEhvb2tzTWFwLmdldChjb2RlUGF0aFNlZ21lbnQpOwogICAgICAgICAgaWYgKCFyZWFjdEhvb2tzKSB7CiAgICAgICAgICAgIHJlYWN0SG9va3MgPSBbXTsKICAgICAgICAgICAgcmVhY3RIb29rc01hcC5zZXQoY29kZVBhdGhTZWdtZW50LCByZWFjdEhvb2tzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlYWN0SG9va3MucHVzaChub2RlLmNhbGxlZSk7CiAgICAgICAgfQoKICAgICAgICAvLyB1c2VFZmZlY3RFdmVudDogdXNlRWZmZWN0RXZlbnQgZnVuY3Rpb25zIGNhbiBiZSBwYXNzZWQgYnkgcmVmZXJlbmNlIHdpdGhpbiB1c2VFZmZlY3QgYXMgd2VsbCBhcyBpbgogICAgICAgIC8vIGFub3RoZXIgdXNlRWZmZWN0RXZlbnQKICAgICAgICBpZiAoCiAgICAgICAgICBub2RlLmNhbGxlZS50eXBlID09PSAnSWRlbnRpZmllcicgJiYKICAgICAgICAgIChub2RlLmNhbGxlZS5uYW1lID09PSAndXNlRWZmZWN0JyB8fAogICAgICAgICAgICBpc1VzZUVmZmVjdEV2ZW50SWRlbnRpZmllcihub2RlLmNhbGxlZSkpICYmCiAgICAgICAgICBub2RlLmFyZ3VtZW50cy5sZW5ndGggPiAwCiAgICAgICAgKSB7CiAgICAgICAgICAvLyBEZW5vdGUgdGhhdCB3ZSBoYXZlIHRyYXZlcnNlZCBpbnRvIGEgdXNlRWZmZWN0IGNhbGwsIGFuZCBzdGFzaCB0aGUgQ2FsbEV4cHIgZm9yCiAgICAgICAgICAvLyBjb21wYXJpc29uIGxhdGVyIHdoZW4gd2UgZXhpdAogICAgICAgICAgbGFzdEVmZmVjdCA9IG5vZGU7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgSWRlbnRpZmllcihub2RlKSB7CiAgICAgICAgLy8gVGhpcyBpZGVudGlmaWVyIHJlc29sdmVzIHRvIGEgdXNlRWZmZWN0RXZlbnQgZnVuY3Rpb24sIGJ1dCBpc24ndCBiZWluZyByZWZlcmVuY2VkIGluIGFuCiAgICAgICAgLy8gZWZmZWN0IG9yIGFub3RoZXIgZXZlbnQgZnVuY3Rpb24uIEl0IGlzbid0IGJlaW5nIGNhbGxlZCBlaXRoZXIuCiAgICAgICAgaWYgKAogICAgICAgICAgbGFzdEVmZmVjdCA9PSBudWxsICYmCiAgICAgICAgICB1c2VFZmZlY3RFdmVudEZ1bmN0aW9ucy5oYXMobm9kZSkgJiYKICAgICAgICAgIG5vZGUucGFyZW50LnR5cGUgIT09ICdDYWxsRXhwcmVzc2lvbicKICAgICAgICApIHsKICAgICAgICAgIGNvbnRleHQucmVwb3J0KHsKICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgbWVzc2FnZToKICAgICAgICAgICAgICBgXGAke2NvbnRleHQuZ2V0U291cmNlKAogICAgICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgICApfVxgIGlzIGEgZnVuY3Rpb24gY3JlYXRlZCB3aXRoIFJlYWN0IEhvb2sgInVzZUVmZmVjdEV2ZW50IiwgYW5kIGNhbiBvbmx5IGJlIGNhbGxlZCBmcm9tIGAgKwogICAgICAgICAgICAgICd0aGUgc2FtZSBjb21wb25lbnQuIFRoZXkgY2Fubm90IGJlIGFzc2lnbmVkIHRvIHZhcmlhYmxlcyBvciBwYXNzZWQgZG93bi4nLAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgJ0NhbGxFeHByZXNzaW9uOmV4aXQnKG5vZGUpIHsKICAgICAgICBpZiAobm9kZSA9PT0gbGFzdEVmZmVjdCkgewogICAgICAgICAgbGFzdEVmZmVjdCA9IG51bGw7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgRnVuY3Rpb25EZWNsYXJhdGlvbihub2RlKSB7CiAgICAgICAgLy8gZnVuY3Rpb24gTXlDb21wb25lbnQoKSB7IGNvbnN0IG9uQ2xpY2sgPSB1c2VFZmZlY3RFdmVudCguLi4pIH0KICAgICAgICBpZiAoaXNJbnNpZGVDb21wb25lbnRPckhvb2sobm9kZSkpIHsKICAgICAgICAgIHJlY29yZEFsbFVzZUVmZmVjdEV2ZW50RnVuY3Rpb25zKGNvbnRleHQuZ2V0U2NvcGUoKSk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgQXJyb3dGdW5jdGlvbkV4cHJlc3Npb24obm9kZSkgewogICAgICAgIC8vIGNvbnN0IE15Q29tcG9uZW50ID0gKCkgPT4geyBjb25zdCBvbkNsaWNrID0gdXNlRWZmZWN0RXZlbnQoLi4uKSB9CiAgICAgICAgaWYgKGlzSW5zaWRlQ29tcG9uZW50T3JIb29rKG5vZGUpKSB7CiAgICAgICAgICByZWNvcmRBbGxVc2VFZmZlY3RFdmVudEZ1bmN0aW9ucyhjb250ZXh0LmdldFNjb3BlKCkpOwogICAgICAgIH0KICAgICAgfSwKICAgIH07CiAgfSwKfTsKCi8qKgogKiBHZXRzIHRoZSBzdGF0aWMgbmFtZSBvZiBhIGZ1bmN0aW9uIEFTVCBub2RlLiBGb3IgZnVuY3Rpb24gZGVjbGFyYXRpb25zIGl0IGlzCiAqIGVhc3kuIEZvciBhbm9ueW1vdXMgZnVuY3Rpb24gZXhwcmVzc2lvbnMgaXQgaXMgbXVjaCBoYXJkZXIuIElmIHlvdSBzZWFyY2ggZm9yCiAqIGBJc0Fub255bW91c0Z1bmN0aW9uRGVmaW5pdGlvbigpYCBpbiB0aGUgRUNNQVNjcmlwdCBzcGVjIHlvdSdsbCBmaW5kIHBsYWNlcwogKiB3aGVyZSBKUyBnaXZlcyBhbm9ueW1vdXMgZnVuY3Rpb24gZXhwcmVzc2lvbnMgbmFtZXMuIFdlIHJvdWdobHkgZGV0ZWN0IHRoZQogKiBzYW1lIEFTVCBub2RlcyB3aXRoIHNvbWUgZXhjZXB0aW9ucyB0byBiZXR0ZXIgZml0IG91ciB1c2UgY2FzZS4KICovCgpmdW5jdGlvbiBnZXRGdW5jdGlvbk5hbWUobm9kZSkgewogIGlmICgKICAgIG5vZGUudHlwZSA9PT0gJ0Z1bmN0aW9uRGVjbGFyYXRpb24nIHx8CiAgICAobm9kZS50eXBlID09PSAnRnVuY3Rpb25FeHByZXNzaW9uJyAmJiBub2RlLmlkKQogICkgewogICAgLy8gZnVuY3Rpb24gdXNlSG9vaygpIHt9CiAgICAvLyBjb25zdCB3aGF0ZXZlciA9IGZ1bmN0aW9uIHVzZUhvb2soKSB7fTsKICAgIC8vCiAgICAvLyBGdW5jdGlvbiBkZWNsYXJhdGlvbiBvciBmdW5jdGlvbiBleHByZXNzaW9uIG5hbWVzIHdpbiBvdmVyIGFueQogICAgLy8gYXNzaWdubWVudCBzdGF0ZW1lbnRzIG9yIG90aGVyIHJlbmFtZXMuCiAgICByZXR1cm4gbm9kZS5pZDsKICB9IGVsc2UgaWYgKAogICAgbm9kZS50eXBlID09PSAnRnVuY3Rpb25FeHByZXNzaW9uJyB8fAogICAgbm9kZS50eXBlID09PSAnQXJyb3dGdW5jdGlvbkV4cHJlc3Npb24nCiAgKSB7CiAgICBpZiAoCiAgICAgIG5vZGUucGFyZW50LnR5cGUgPT09ICdWYXJpYWJsZURlY2xhcmF0b3InICYmCiAgICAgIG5vZGUucGFyZW50LmluaXQgPT09IG5vZGUKICAgICkgewogICAgICAvLyBjb25zdCB1c2VIb29rID0gKCkgPT4ge307CiAgICAgIHJldHVybiBub2RlLnBhcmVudC5pZDsKICAgIH0gZWxzZSBpZiAoCiAgICAgIG5vZGUucGFyZW50LnR5cGUgPT09ICdBc3NpZ25tZW50RXhwcmVzc2lvbicgJiYKICAgICAgbm9kZS5wYXJlbnQucmlnaHQgPT09IG5vZGUgJiYKICAgICAgbm9kZS5wYXJlbnQub3BlcmF0b3IgPT09ICc9JwogICAgKSB7CiAgICAgIC8vIHVzZUhvb2sgPSAoKSA9PiB7fTsKICAgICAgcmV0dXJuIG5vZGUucGFyZW50LmxlZnQ7CiAgICB9IGVsc2UgaWYgKAogICAgICBub2RlLnBhcmVudC50eXBlID09PSAnUHJvcGVydHknICYmCiAgICAgIG5vZGUucGFyZW50LnZhbHVlID09PSBub2RlICYmCiAgICAgICFub2RlLnBhcmVudC5jb21wdXRlZAogICAgKSB7CiAgICAgIC8vIHt1c2VIb29rOiAoKSA9PiB7fX0KICAgICAgLy8ge3VzZUhvb2soKSB7fX0KICAgICAgcmV0dXJuIG5vZGUucGFyZW50LmtleTsKCiAgICAgIC8vIE5PVEU6IFdlIGNvdWxkIGFsc28gc3VwcG9ydCBgQ2xhc3NQcm9wZXJ0eWAgYW5kIGBNZXRob2REZWZpbml0aW9uYAogICAgICAvLyBoZXJlIHRvIGJlIHBlZGFudGljLiBIb3dldmVyLCBob29rcyBpbiBhIGNsYXNzIGFyZSBhbiBhbnRpLXBhdHRlcm4uIFNvCiAgICAgIC8vIHdlIGRvbid0IGFsbG93IGl0IHRvIGVycm9yIGVhcmx5LgogICAgICAvLwogICAgICAvLyBjbGFzcyB7dXNlSG9vayA9ICgpID0+IHt9fQogICAgICAvLyBjbGFzcyB7dXNlSG9vaygpIHt9fQogICAgfSBlbHNlIGlmICgKICAgICAgbm9kZS5wYXJlbnQudHlwZSA9PT0gJ0Fzc2lnbm1lbnRQYXR0ZXJuJyAmJgogICAgICBub2RlLnBhcmVudC5yaWdodCA9PT0gbm9kZSAmJgogICAgICAhbm9kZS5wYXJlbnQuY29tcHV0ZWQKICAgICkgewogICAgICAvLyBjb25zdCB7dXNlSG9vayA9ICgpID0+IHt9fSA9IHt9OwogICAgICAvLyAoe3VzZUhvb2sgPSAoKSA9PiB7fX0gPSB7fSk7CiAgICAgIC8vCiAgICAgIC8vIEtpbmRhIGNsb3dueSwgYnV0IHdlJ2Qgc2FpZCB3ZSdkIGZvbGxvdyBzcGVjIGNvbnZlbnRpb24gZm9yCiAgICAgIC8vIGBJc0Fub255bW91c0Z1bmN0aW9uRGVmaW5pdGlvbigpYCB1c2FnZS4KICAgICAgcmV0dXJuIG5vZGUucGFyZW50LmxlZnQ7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogIH0gZWxzZSB7CiAgICByZXR1cm4gdW5kZWZpbmVkOwogIH0KfQoKLyoqCiAqIENvbnZlbmllbmNlIGZ1bmN0aW9uIGZvciBwZWVraW5nIHRoZSBsYXN0IGl0ZW0gaW4gYSBzdGFjay4KICovCgpmdW5jdGlvbiBsYXN0KGFycmF5KSB7CiAgcmV0dXJuIGFycmF5W2FycmF5Lmxlbmd0aCAtIDFdOwp9CgovKioKICogQGZpbGVvdmVydmlldyBSZXBvcnQgbWlzc2luZyBga2V5YCBwcm9wcyBpbiBpdGVyYXRvcnMvY29sbGVjdGlvbiBsaXRlcmFscy4KICogQGF1dGhvciBCZW4gTW9zaGVyCiAqLwoKJ3VzZSBzdHJpY3QnOwoKY29uc3QgaGFzUHJvcCA9IHJlcXVpcmUoJ2pzeC1hc3QtdXRpbHMvaGFzUHJvcCcpOwpjb25zdCBwcm9wTmFtZSA9IHJlcXVpcmUoJ2pzeC1hc3QtdXRpbHMvcHJvcE5hbWUnKTsKY29uc3QgdmFsdWVzID0gcmVxdWlyZSgnb2JqZWN0LnZhbHVlcycpOwpjb25zdCBkb2NzVXJsID0gcmVxdWlyZSgnLi4vdXRpbC9kb2NzVXJsJyk7CmNvbnN0IHByYWdtYVV0aWwgPSByZXF1aXJlKCcuLi91dGlsL3ByYWdtYScpOwpjb25zdCByZXBvcnQgPSByZXF1aXJlKCcuLi91dGlsL3JlcG9ydCcpOwpjb25zdCBhc3RVdGlsID0gcmVxdWlyZSgnLi4vdXRpbC9hc3QnKTsKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyBSdWxlIERlZmluaXRpb24KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpjb25zdCBkZWZhdWx0T3B0aW9ucyA9IHsKICBjaGVja0ZyYWdtZW50U2hvcnRoYW5kOiBmYWxzZSwKICBjaGVja0tleU11c3RCZWZvcmVTcHJlYWQ6IGZhbHNlLAogIHdhcm5PbkR1cGxpY2F0ZXM6IGZhbHNlLAp9OwoKY29uc3QgbWVzc2FnZXMgPSB7CiAgbWlzc2luZ0l0ZXJLZXk6ICdNaXNzaW5nICJrZXkiIHByb3AgZm9yIGVsZW1lbnQgaW4gaXRlcmF0b3InLAogIG1pc3NpbmdJdGVyS2V5VXNlUHJhZzogJ01pc3NpbmcgImtleSIgcHJvcCBmb3IgZWxlbWVudCBpbiBpdGVyYXRvci4gU2hvcnRoYW5kIGZyYWdtZW50IHN5bnRheCBkb2VzIG5vdCBzdXBwb3J0IHByb3ZpZGluZyBrZXlzLiBVc2Uge3tyZWFjdFByYWd9fS57e2ZyYWdQcmFnfX0gaW5zdGVhZCcsCiAgbWlzc2luZ0FycmF5S2V5OiAnTWlzc2luZyAia2V5IiBwcm9wIGZvciBlbGVtZW50IGluIGFycmF5JywKICBtaXNzaW5nQXJyYXlLZXlVc2VQcmFnOiAnTWlzc2luZyAia2V5IiBwcm9wIGZvciBlbGVtZW50IGluIGFycmF5LiBTaG9ydGhhbmQgZnJhZ21lbnQgc3ludGF4IGRvZXMgbm90IHN1cHBvcnQgcHJvdmlkaW5nIGtleXMuIFVzZSB7e3JlYWN0UHJhZ319Lnt7ZnJhZ1ByYWd9fSBpbnN0ZWFkJywKICBrZXlCZWZvcmVTcHJlYWQ6ICdga2V5YCBwcm9wIG11c3QgYmUgcGxhY2VkIGJlZm9yZSBhbnkgYHsuLi5zcHJlYWR9LCB0byBhdm9pZCBjb25mbGljdGluZyB3aXRoIFJlYWN04oCZcyBuZXcgSlNYIHRyYW5zZm9ybTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9ibG9nLzIwMjAvMDkvMjIvaW50cm9kdWNpbmctdGhlLW5ldy1qc3gtdHJhbnNmb3JtLmh0bWxgJywKICBub25VbmlxdWVLZXlzOiAnYGtleWAgcHJvcCBtdXN0IGJlIHVuaXF1ZScsCn07Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBtZXRhOiB7CiAgICBkb2NzOiB7CiAgICAgIGRlc2NyaXB0aW9uOiAnRGlzYWxsb3cgbWlzc2luZyBga2V5YCBwcm9wcyBpbiBpdGVyYXRvcnMvY29sbGVjdGlvbiBsaXRlcmFscycsCiAgICAgIGNhdGVnb3J5OiAnUG9zc2libGUgRXJyb3JzJywKICAgICAgcmVjb21tZW5kZWQ6IHRydWUsCiAgICAgIHVybDogZG9jc1VybCgnanN4LWtleScpLAogICAgfSwKCiAgICBtZXNzYWdlcywKCiAgICBzY2hlbWE6IFt7CiAgICAgIHR5cGU6ICdvYmplY3QnLAogICAgICBwcm9wZXJ0aWVzOiB7CiAgICAgICAgY2hlY2tGcmFnbWVudFNob3J0aGFuZDogewogICAgICAgICAgdHlwZTogJ2Jvb2xlYW4nLAogICAgICAgICAgZGVmYXVsdDogZGVmYXVsdE9wdGlvbnMuY2hlY2tGcmFnbWVudFNob3J0aGFuZCwKICAgICAgICB9LAogICAgICAgIGNoZWNrS2V5TXVzdEJlZm9yZVNwcmVhZDogewogICAgICAgICAgdHlwZTogJ2Jvb2xlYW4nLAogICAgICAgICAgZGVmYXVsdDogZGVmYXVsdE9wdGlvbnMuY2hlY2tLZXlNdXN0QmVmb3JlU3ByZWFkLAogICAgICAgIH0sCiAgICAgICAgd2Fybk9uRHVwbGljYXRlczogewogICAgICAgICAgdHlwZTogJ2Jvb2xlYW4nLAogICAgICAgICAgZGVmYXVsdDogZGVmYXVsdE9wdGlvbnMud2Fybk9uRHVwbGljYXRlcywKICAgICAgICB9LAogICAgICB9LAogICAgICBhZGRpdGlvbmFsUHJvcGVydGllczogZmFsc2UsCiAgICB9XSwKICB9LAoKICBjcmVhdGUoY29udGV4dCkgewogICAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRPcHRpb25zLCBjb250ZXh0Lm9wdGlvbnNbMF0pOwogICAgY29uc3QgY2hlY2tGcmFnbWVudFNob3J0aGFuZCA9IG9wdGlvbnMuY2hlY2tGcmFnbWVudFNob3J0aGFuZDsKICAgIGNvbnN0IGNoZWNrS2V5TXVzdEJlZm9yZVNwcmVhZCA9IG9wdGlvbnMuY2hlY2tLZXlNdXN0QmVmb3JlU3ByZWFkOwogICAgY29uc3Qgd2Fybk9uRHVwbGljYXRlcyA9IG9wdGlvbnMud2Fybk9uRHVwbGljYXRlczsKICAgIGNvbnN0IHJlYWN0UHJhZ21hID0gcHJhZ21hVXRpbC5nZXRGcm9tQ29udGV4dChjb250ZXh0KTsKICAgIGNvbnN0IGZyYWdtZW50UHJhZ21hID0gcHJhZ21hVXRpbC5nZXRGcmFnbWVudEZyb21Db250ZXh0KGNvbnRleHQpOwoKICAgIGZ1bmN0aW9uIGNoZWNrSXRlcmF0b3JFbGVtZW50KG5vZGUpIHsKICAgICAgaWYgKG5vZGUudHlwZSA9PT0gJ0pTWEVsZW1lbnQnICYmICFoYXNQcm9wKG5vZGUub3BlbmluZ0VsZW1lbnQuYXR0cmlidXRlcywgJ2tleScpKSB7CiAgICAgICAgcmVwb3J0KGNvbnRleHQsIG1lc3NhZ2VzLm1pc3NpbmdJdGVyS2V5LCAnbWlzc2luZ0l0ZXJLZXknLCB7CiAgICAgICAgICBub2RlLAogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKGNoZWNrRnJhZ21lbnRTaG9ydGhhbmQgJiYgbm9kZS50eXBlID09PSAnSlNYRnJhZ21lbnQnKSB7CiAgICAgICAgcmVwb3J0KGNvbnRleHQsIG1lc3NhZ2VzLm1pc3NpbmdJdGVyS2V5VXNlUHJhZywgJ21pc3NpbmdJdGVyS2V5VXNlUHJhZycsIHsKICAgICAgICAgIG5vZGUsCiAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIHJlYWN0UHJhZzogcmVhY3RQcmFnbWEsCiAgICAgICAgICAgIGZyYWdQcmFnOiBmcmFnbWVudFByYWdtYSwKICAgICAgICAgIH0sCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRSZXR1cm5TdGF0ZW1lbnRzKG5vZGUpIHsKICAgICAgY29uc3QgcmV0dXJuU3RhdGVtZW50cyA9IGFyZ3VtZW50c1sxXSB8fCBbXTsKICAgICAgaWYgKG5vZGUudHlwZSA9PT0gJ0lmU3RhdGVtZW50JykgewogICAgICAgIGlmIChub2RlLmNvbnNlcXVlbnQpIHsKICAgICAgICAgIGdldFJldHVyblN0YXRlbWVudHMobm9kZS5jb25zZXF1ZW50LCByZXR1cm5TdGF0ZW1lbnRzKTsKICAgICAgICB9CiAgICAgICAgaWYgKG5vZGUuYWx0ZXJuYXRlKSB7CiAgICAgICAgICBnZXRSZXR1cm5TdGF0ZW1lbnRzKG5vZGUuYWx0ZXJuYXRlLCByZXR1cm5TdGF0ZW1lbnRzKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShub2RlLmJvZHkpKSB7CiAgICAgICAgbm9kZS5ib2R5LmZvckVhY2goKGl0ZW0pID0+IHsKICAgICAgICAgIGlmIChpdGVtLnR5cGUgPT09ICdJZlN0YXRlbWVudCcpIHsKICAgICAgICAgICAgZ2V0UmV0dXJuU3RhdGVtZW50cyhpdGVtLCByZXR1cm5TdGF0ZW1lbnRzKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaXRlbS50eXBlID09PSAnUmV0dXJuU3RhdGVtZW50JykgewogICAgICAgICAgICByZXR1cm5TdGF0ZW1lbnRzLnB1c2goaXRlbSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXR1cm5TdGF0ZW1lbnRzOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzS2V5QWZ0ZXJTcHJlYWQoYXR0cmlidXRlcykgewogICAgICBsZXQgaGFzRm91bmRTcHJlYWQgPSBmYWxzZTsKICAgICAgcmV0dXJuIGF0dHJpYnV0ZXMuc29tZSgoYXR0cmlidXRlKSA9PiB7CiAgICAgICAgaWYgKGF0dHJpYnV0ZS50eXBlID09PSAnSlNYU3ByZWFkQXR0cmlidXRlJykgewogICAgICAgICAgaGFzRm91bmRTcHJlYWQgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoYXR0cmlidXRlLnR5cGUgIT09ICdKU1hBdHRyaWJ1dGUnKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBoYXNGb3VuZFNwcmVhZCAmJiBwcm9wTmFtZShhdHRyaWJ1dGUpID09PSAna2V5JzsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIG5vZGUgaXMgYSBmdW5jdGlvbiBleHByZXNzaW9uIG9yIGFycm93IGZ1bmN0aW9uLAogICAgICogYW5kIGNoZWNrcyBpZiB0aGVyZSBpcyBhIG1pc3Npbmcga2V5IHByb3AgaW4gcmV0dXJuIHN0YXRlbWVudCdzIGFyZ3VtZW50cwogICAgICogQHBhcmFtIHtBU1ROb2RlfSBub2RlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNoZWNrRnVuY3Rpb25zQmxvY2tTdGF0ZW1lbnQobm9kZSkgewogICAgICBpZiAoYXN0VXRpbC5pc0Z1bmN0aW9uTGlrZUV4cHJlc3Npb24obm9kZSkpIHsKICAgICAgICBpZiAobm9kZS5ib2R5LnR5cGUgPT09ICdCbG9ja1N0YXRlbWVudCcpIHsKICAgICAgICAgIGdldFJldHVyblN0YXRlbWVudHMobm9kZS5ib2R5KQogICAgICAgICAgICAuZmlsdGVyKChyZXR1cm5TdGF0ZW1lbnQpID0+IHJldHVyblN0YXRlbWVudCAmJiByZXR1cm5TdGF0ZW1lbnQuYXJndW1lbnQpCiAgICAgICAgICAgIC5mb3JFYWNoKChyZXR1cm5TdGF0ZW1lbnQpID0+IHsKICAgICAgICAgICAgICBjaGVja0l0ZXJhdG9yRWxlbWVudChyZXR1cm5TdGF0ZW1lbnQuYXJndW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiB0aGUgZ2l2ZW4gbm9kZSBpcyBhbiBhcnJvdyBmdW5jdGlvbiB0aGF0IGhhcyBhbiBKU1ggRWxlbWVudCBvciBKU1ggRnJhZ21lbnQgaW4gaXRzIGJvZHksCiAgICAgKiBhbmQgdGhlIEpTWCBpcyBtaXNzaW5nIGEga2V5IHByb3AKICAgICAqIEBwYXJhbSB7QVNUTm9kZX0gbm9kZQogICAgICovCiAgICBmdW5jdGlvbiBjaGVja0Fycm93RnVuY3Rpb25XaXRoSlNYKG5vZGUpIHsKICAgICAgY29uc3QgaXNBcnJGbiA9IG5vZGUgJiYgbm9kZS50eXBlID09PSAnQXJyb3dGdW5jdGlvbkV4cHJlc3Npb24nOwogICAgICBjb25zdCBzaG91bGRDaGVja05vZGUgPSAobikgPT4gbiAmJiAobi50eXBlID09PSAnSlNYRWxlbWVudCcgfHwgbi50eXBlID09PSAnSlNYRnJhZ21lbnQnKTsKICAgICAgaWYgKGlzQXJyRm4gJiYgc2hvdWxkQ2hlY2tOb2RlKG5vZGUuYm9keSkpIHsKICAgICAgICBjaGVja0l0ZXJhdG9yRWxlbWVudChub2RlLmJvZHkpOwogICAgICB9CiAgICAgIGlmIChub2RlLmJvZHkudHlwZSA9PT0gJ0NvbmRpdGlvbmFsRXhwcmVzc2lvbicpIHsKICAgICAgICBpZiAoc2hvdWxkQ2hlY2tOb2RlKG5vZGUuYm9keS5jb25zZXF1ZW50KSkgewogICAgICAgICAgY2hlY2tJdGVyYXRvckVsZW1lbnQobm9kZS5ib2R5LmNvbnNlcXVlbnQpOwogICAgICAgIH0KICAgICAgICBpZiAoc2hvdWxkQ2hlY2tOb2RlKG5vZGUuYm9keS5hbHRlcm5hdGUpKSB7CiAgICAgICAgICBjaGVja0l0ZXJhdG9yRWxlbWVudChub2RlLmJvZHkuYWx0ZXJuYXRlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAobm9kZS5ib2R5LnR5cGUgPT09ICdMb2dpY2FsRXhwcmVzc2lvbicgJiYgc2hvdWxkQ2hlY2tOb2RlKG5vZGUuYm9keS5yaWdodCkpIHsKICAgICAgICBjaGVja0l0ZXJhdG9yRWxlbWVudChub2RlLmJvZHkucmlnaHQpOwogICAgICB9CiAgICB9CgogICAgY29uc3QgY2hpbGRyZW5Ub0FycmF5U2VsZWN0b3IgPSBgOm1hdGNoZXMoCiAgICAgIENhbGxFeHByZXNzaW9uCiAgICAgICAgW2NhbGxlZS5vYmplY3Qub2JqZWN0Lm5hbWU9JHtyZWFjdFByYWdtYX1dCiAgICAgICAgW2NhbGxlZS5vYmplY3QucHJvcGVydHkubmFtZT1DaGlsZHJlbl0KICAgICAgICBbY2FsbGVlLnByb3BlcnR5Lm5hbWU9dG9BcnJheV0sCiAgICAgIENhbGxFeHByZXNzaW9uCiAgICAgICAgW2NhbGxlZS5vYmplY3QubmFtZT1DaGlsZHJlbl0KICAgICAgICBbY2FsbGVlLnByb3BlcnR5Lm5hbWU9dG9BcnJheV0KICAgIClgLnJlcGxhY2UoL1xzL2csICcnKTsKICAgIGxldCBpc1dpdGhpbkNoaWxkcmVuVG9BcnJheSA9IGZhbHNlOwoKICAgIGNvbnN0IHNlZW4gPSBuZXcgV2Vha1NldCgpOwoKICAgIHJldHVybiB7CiAgICAgIFtjaGlsZHJlblRvQXJyYXlTZWxlY3Rvcl0oKSB7CiAgICAgICAgaXNXaXRoaW5DaGlsZHJlblRvQXJyYXkgPSB0cnVlOwogICAgICB9LAoKICAgICAgW2Ake2NoaWxkcmVuVG9BcnJheVNlbGVjdG9yfTpleGl0YF0oKSB7CiAgICAgICAgaXNXaXRoaW5DaGlsZHJlblRvQXJyYXkgPSBmYWxzZTsKICAgICAgfSwKCiAgICAgICdBcnJheUV4cHJlc3Npb24sIEpTWEVsZW1lbnQgPiBKU1hFbGVtZW50Jyhub2RlKSB7CiAgICAgICAgaWYgKGlzV2l0aGluQ2hpbGRyZW5Ub0FycmF5KSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25zdCBqc3ggPSAobm9kZS50eXBlID09PSAnQXJyYXlFeHByZXNzaW9uJyA/IG5vZGUuZWxlbWVudHMgOiBub2RlLnBhcmVudC5jaGlsZHJlbikuZmlsdGVyKCh4KSA9PiB4ICYmIHgudHlwZSA9PT0gJ0pTWEVsZW1lbnQnKTsKICAgICAgICBpZiAoanN4Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgbWFwID0ge307CiAgICAgICAganN4LmZvckVhY2goKGVsZW1lbnQpID0+IHsKICAgICAgICAgIGNvbnN0IGF0dHJzID0gZWxlbWVudC5vcGVuaW5nRWxlbWVudC5hdHRyaWJ1dGVzOwogICAgICAgICAgY29uc3Qga2V5cyA9IGF0dHJzLmZpbHRlcigoeCkgPT4geC5uYW1lICYmIHgubmFtZS5uYW1lID09PSAna2V5Jyk7CgogICAgICAgICAgaWYgKGtleXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGlmIChub2RlLnR5cGUgPT09ICdBcnJheUV4cHJlc3Npb24nKSB7CiAgICAgICAgICAgICAgcmVwb3J0KGNvbnRleHQsIG1lc3NhZ2VzLm1pc3NpbmdBcnJheUtleSwgJ21pc3NpbmdBcnJheUtleScsIHsKICAgICAgICAgICAgICAgIG5vZGU6IGVsZW1lbnQsCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtleXMuZm9yRWFjaCgoYXR0cikgPT4gewogICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gY29udGV4dC5nZXRTb3VyY2VDb2RlKCkuZ2V0VGV4dChhdHRyLnZhbHVlKTsKICAgICAgICAgICAgICBpZiAoIW1hcFt2YWx1ZV0pIHsgbWFwW3ZhbHVlXSA9IFtdOyB9CiAgICAgICAgICAgICAgbWFwW3ZhbHVlXS5wdXNoKGF0dHIpOwoKICAgICAgICAgICAgICBpZiAoY2hlY2tLZXlNdXN0QmVmb3JlU3ByZWFkICYmIGlzS2V5QWZ0ZXJTcHJlYWQoYXR0cnMpKSB7CiAgICAgICAgICAgICAgICByZXBvcnQoY29udGV4dCwgbWVzc2FnZXMua2V5QmVmb3JlU3ByZWFkLCAna2V5QmVmb3JlU3ByZWFkJywgewogICAgICAgICAgICAgICAgICBub2RlOiBub2RlLnR5cGUgPT09ICdBcnJheUV4cHJlc3Npb24nID8gbm9kZSA6IG5vZGUucGFyZW50LAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgaWYgKHdhcm5PbkR1cGxpY2F0ZXMpIHsKICAgICAgICAgIHZhbHVlcyhtYXApLmZpbHRlcigodikgPT4gdi5sZW5ndGggPiAxKS5mb3JFYWNoKCh2KSA9PiB7CiAgICAgICAgICAgIHYuZm9yRWFjaCgobikgPT4gewogICAgICAgICAgICAgIGlmICghc2Vlbi5oYXMobikpIHsKICAgICAgICAgICAgICAgIHNlZW4uYWRkKG4pOwogICAgICAgICAgICAgICAgcmVwb3J0KGNvbnRleHQsIG1lc3NhZ2VzLm5vblVuaXF1ZUtleXMsICdub25VbmlxdWVLZXlzJywgewogICAgICAgICAgICAgICAgICBub2RlOiBuLAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIEpTWEZyYWdtZW50KG5vZGUpIHsKICAgICAgICBpZiAoIWNoZWNrRnJhZ21lbnRTaG9ydGhhbmQgfHwgaXNXaXRoaW5DaGlsZHJlblRvQXJyYXkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChub2RlLnBhcmVudC50eXBlID09PSAnQXJyYXlFeHByZXNzaW9uJykgewogICAgICAgICAgcmVwb3J0KGNvbnRleHQsIG1lc3NhZ2VzLm1pc3NpbmdBcnJheUtleVVzZVByYWcsICdtaXNzaW5nQXJyYXlLZXlVc2VQcmFnJywgewogICAgICAgICAgICBub2RlLAogICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgcmVhY3RQcmFnOiByZWFjdFByYWdtYSwKICAgICAgICAgICAgICBmcmFnUHJhZzogZnJhZ21lbnRQcmFnbWEsCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvLyBBcnJheS5wcm90b3R5cGUubWFwCiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1tdWx0aS1zdHIKICAgICAgJ0NhbGxFeHByZXNzaW9uW2NhbGxlZS50eXBlPSJNZW1iZXJFeHByZXNzaW9uIl1bY2FsbGVlLnByb3BlcnR5Lm5hbWU9Im1hcCJdLFwKICAgICAgIENhbGxFeHByZXNzaW9uW2NhbGxlZS50eXBlPSJPcHRpb25hbE1lbWJlckV4cHJlc3Npb24iXVtjYWxsZWUucHJvcGVydHkubmFtZT0ibWFwIl0sXAogICAgICAgT3B0aW9uYWxDYWxsRXhwcmVzc2lvbltjYWxsZWUudHlwZT0iTWVtYmVyRXhwcmVzc2lvbiJdW2NhbGxlZS5wcm9wZXJ0eS5uYW1lPSJtYXAiXSxcCiAgICAgICBPcHRpb25hbENhbGxFeHByZXNzaW9uW2NhbGxlZS50eXBlPSJPcHRpb25hbE1lbWJlckV4cHJlc3Npb24iXVtjYWxsZWUucHJvcGVydHkubmFtZT0ibWFwIl0nKG5vZGUpIHsKICAgICAgICBpZiAoaXNXaXRoaW5DaGlsZHJlblRvQXJyYXkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGZuID0gbm9kZS5hcmd1bWVudHMubGVuZ3RoID4gMCAmJiBub2RlLmFyZ3VtZW50c1swXTsKICAgICAgICBpZiAoIWZuIHx8ICFhc3RVdGlsLmlzRnVuY3Rpb25MaWtlRXhwcmVzc2lvbihmbikpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNoZWNrQXJyb3dGdW5jdGlvbldpdGhKU1goZm4pOwoKICAgICAgICBjaGVja0Z1bmN0aW9uc0Jsb2NrU3RhdGVtZW50KGZuKTsKICAgICAgfSwKCiAgICAgIC8vIEFycmF5LmZyb20KICAgICAgJ0NhbGxFeHByZXNzaW9uW2NhbGxlZS50eXBlPSJNZW1iZXJFeHByZXNzaW9uIl1bY2FsbGVlLnByb3BlcnR5Lm5hbWU9ImZyb20iXScobm9kZSkgewogICAgICAgIGlmIChpc1dpdGhpbkNoaWxkcmVuVG9BcnJheSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgZm4gPSBub2RlLmFyZ3VtZW50cy5sZW5ndGggPiAxICYmIG5vZGUuYXJndW1lbnRzWzFdOwogICAgICAgIGlmICghYXN0VXRpbC5pc0Z1bmN0aW9uTGlrZUV4cHJlc3Npb24oZm4pKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjaGVja0Fycm93RnVuY3Rpb25XaXRoSlNYKGZuKTsKCiAgICAgICAgY2hlY2tGdW5jdGlvbnNCbG9ja1N0YXRlbWVudChmbik7CiAgICAgIH0sCiAgICB9OwogIH0sCn07Cg==";


    String decoded = new String(Base64.getDecoder().decode(code.getBytes()));


    String ruleCode = """
        function visit(node, filename, code) {
          const arguments = node.arguments.values;

          /*
           * Check each argument. If one argument has the variable "foo" used,
           * we report it.
           */
          arguments.forEach((a) => {
            if (a.value.astType === "string") {
              if (a.value.value === "foo") {
                const error = buildError(a.value.start.line, a.value.start.col,
                  a.value.end.line, a.value.end.col,
                  "Do not use foo as value", "WARNING", "BEST_PRACTICE");

                addError(error);
              }
            }
          });

          /*
           * Check the function name. We cannot use my_function, we recommend to use myFunction
           */
          if (node.functionName && node.functionName.astType === "string") {
            if (node.functionName.value === "my_function") {
              const error = buildError(node.functionName.start.line, node.functionName.start.col,
                node.functionName.end.line, node.functionName.end.col,
                "Do not use function_name", "WARNING", "BEST_PRACTICE");
              const edit = buildEditUpdate(node.functionName.start.line, node.functionName.start.col,
                node.functionName.end.line, node.functionName.end.col,
                "myFunction");
              const fix = buildFix("use myFunction", [edit]);
              addError(error.addFix(fix));
            }
          }
        }
                        """;

    @Test
    @DisplayName("run on a very large file")
    public void testRunLargeFile() throws Exception {
        JAVASCRIPT_TYPESCRIPT.forEach(l -> {
            logger.info("Running test with language: " + l);
            logger.info(decoded);
            Response response = executeTest("bla.js", decoded + decoded, l, ruleCode, "errorUseQuery", RuleType.AST_CHECK, EntityChecked.FUNCTION_CALL, null, true);
            logger.info(response.toString());
            assertEquals(1, response.ruleResponses.size());
        });
    }


}
